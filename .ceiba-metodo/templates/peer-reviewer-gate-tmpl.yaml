# <!-- Powered by BMAD™ Core -->
template:
  id: peer-reviewer-gate-template-v1
  name: Quality Gate Decision Peer Reviewer
  version: 1.0
  output:
    format: yaml
    filename: qa.qaLocation/gates/{{epic_num}}.{{story_num}}-{{story_slug}}.yml
    title: "Quality Gate: {{epic_num}}.{{story_num}}"

# Campos requeridos (mantener estos primero)
schema: 1
story: "{{epic_num}}.{{story_num}}"
story_title: "{{story_title}}"
gate: "{{gate_status}}" # PASS|CONCERNS|FAIL|WAIVED
status_reason: "{{status_reason}}" # Resumen de 1-2 oraciones de por qué esta decisión de gate
reviewer: "Revisor par - Ceiba (Arquitecto de Pruebas)"
updated: "{{iso_timestamp}}"

# Siempre presente pero solo activo cuando WAIVED
waiver: { active: false }

# Problemas (si los hay) - Usar severidad fija: low | medium | high
top_issues: []

# Resumen de riesgo (de tarea risk-profile si se ejecuta)
risk_summary:
  totals: { critical: 0, high: 0, medium: 0, low: 0 }
  recommendations:
    must_fix: []
    monitor: []

# Sección de ejemplos usando escalares de bloque para claridad
examples:
  with_issues: |
    top_issues:
      - id: "SEC-001"
        severity: high  # SOLO: low|medium|high
        finding: "Sin limitación de tasa en endpoint de login"
        suggested_action: "Agregar middleware de limitación de tasa antes de producción"
      - id: "TEST-001"  
        severity: medium
        finding: "Faltan pruebas de integración para flujo de auth"
        suggested_action: "Agregar cobertura de prueba para rutas críticas"

  when_waived: |
    waiver:
      active: true
      reason: "Aceptado para liberación MVP - se abordará en siguiente sprint"
      approved_by: "Product Owner"

# ============ Campos Extendidos Opcionales ============
# Descomentar y usar si tu equipo quiere más detalle

optional_fields_examples:
  quality_and_expiry: |
    quality_score: 75  # 0-100 (puntuación opcional)
    expires: "2025-01-26T00:00:00Z"  # Ventana opcional de frescura del gate

  evidence: |
    evidence:
      tests_reviewed: 15
      risks_identified: 3
      trace:
        ac_covered: [1, 2, 3]  # Números AC con cobertura de prueba
        ac_gaps: [4]  # Números AC que carecen de cobertura

  nfr_validation: |
    nfr_validation:
      security: { status: CONCERNS, notes: "Falta limitación de tasa" }
      performance: { status: PASS, notes: "" }
      reliability: { status: PASS, notes: "" }
      maintainability: { status: PASS, notes: "" }

  history: |
    history:  # Pista de auditoría solo-añadir
      - at: "2025-01-12T10:00:00Z"
        gate: FAIL
        note: "Revisión inicial - faltan pruebas"
      - at: "2025-01-12T15:00:00Z"  
        gate: CONCERNS
        note: "Pruebas agregadas pero aún falta limitación de tasa"

  risk_summary: |
    risk_summary:  # De tarea risk-profile
      totals:
        critical: 0
        high: 0
        medium: 0
        low: 0
      # 'highest' se emite solo cuando existen riesgos
      recommendations:
        must_fix: []
        monitor: []

  recommendations: |
    recommendations:
      immediate:  # Debe arreglarse antes de producción
        - action: "Agregar limitación de tasa a endpoints de auth"
          refs: ["api/auth/login.ts:42-68"]
      future:  # Puede abordarse después
        - action: "Considerar caché para mejor rendimiento"
          refs: ["services/data.service.ts"]
