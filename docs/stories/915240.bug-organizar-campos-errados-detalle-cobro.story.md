# Historia #915240: BUG - Organizar los campos errados del detalle de cobro

**Estado:** En Desarrollo  
**Fecha Creaci√≥n:** 31 de Octubre, 2025  
**Fecha Refinamiento:** 31 de Octubre, 2025  
**Fecha Inicio Desarrollo:** 31 de Octubre, 2025  
**Origen:** Historia importada y validada

---

**YO COMO:** expedidor  
**QUIERO:** que se organicen los campos errados del detalle de cobro  
**PARA:** poder descargarlo y tener la informaci√≥n que necesita el cliente

---

## Contexto del Negocio

El detalle de cobro es un reporte en formato CSV que se genera para facturas colectivas de p√≥lizas de Vida Grupo. Este reporte contiene informaci√≥n granular de cada asegurado dentro de la factura, incluyendo coberturas, primas, valores asegurados y dem√°s informaci√≥n necesaria para clientes corporativos.

**Sistema involucrado:** MicroIntegradorReportesVidaGrupo  
**Flujo:** Generaci√≥n de Reporte Detalle de Cobro  
**Formato de archivo:** CSV con columnas din√°micas seg√∫n producto  
**Productos afectados:** Vida Grupo Integral (principalmente)  

**Ubicaci√≥n de descarga:**
- Desde las pantallas de ver factura o desembolso de la p√≥liza en BillingCenter
- Se consume el endpoint GET del microservicio que retorna el link de descarga desde Azure
- BillingCenter ejecuta un script en JavaScript para descargar el archivo

---

## Criterios de Aceptaci√≥n

### **Criterio 1 (‚úÖ SOLUCIONADO):** Visualizar el campo n√∫mero p√≥liza colectiva correctamente

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en el campo "n√∫mero p√≥liza colectiva" se visualice el n√∫mero de la p√≥liza master

---

### **Criterio 2 (‚úÖ SOLUCIONADO):** Visualizar el campo identificaci√≥n del afiliado correctamente

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en el campo "identificaci√≥n del afiliado" se visualice concatenado el tipo y n√∫mero de documento del asegurado que tenga parentesco afiliado

---

### **Criterio 3 (‚úÖ SOLUCIONADO):** Visualizar el campo Valor total prima x asegurado correctamente

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en el campo "Valor total prima x asegurado" se visualice el valor que suma los campos "Valor prima x asegurado" + "Valor impuesto"

---

### **Criterio 4 (üî¥ PENDIENTE):** Visualizar el campo Valor total afiliado correctamente

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en el campo "Valor total afiliado" se visualice en la celda que corresponde al afiliado el valor que suma los campos "Valor total prima x asegurado" de los asegurados tipo grupo familiar de este mismo

**Regla de negocio:**
- **Grupo familiar:** Registros que comparten el mismo valor en el campo "identificaci√≥n afiliado"
- **C√°lculo:** Sumar todos los valores de "Valor total prima x asegurado" de los registros del mismo grupo familiar
- **Aplicaci√≥n:** Este valor calculado debe asignarse a CADA registro del grupo familiar

**Ejemplo:**
```
Grupo Familiar: Identificaci√≥n Afiliado = "CC12345678"
- Registro 1 (Afiliado): Valor total prima x asegurado = $100
- Registro 2 (Dependiente 1): Valor total prima x asegurado = $150
- Registro 3 (Dependiente 2): Valor total prima x asegurado = $200

Resultado esperado:
- Registro 1: Valor total afiliado = $450
- Registro 2: Valor total afiliado = $450
- Registro 3: Valor total afiliado = $450
```

---

### **Criterio 5 (‚úÖ SOLUCIONADO):** Visualizar el campo Parentesco correctamente

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en el campo "Parentesco" se visualice la sigla del parentesco de cada asegurado y no el c√≥digo

---

### **Criterio 6 (‚úÖ SOLUCIONADO):** Visualizar el campo Tipo de Operaci√≥n correctamente

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en el campo "Tipo de Operaci√≥n" se visualice el tipo de operaci√≥n que se visualiza en transacciones de p√≥liza en PC (cotizaci√≥n, cambio de p√≥liza, etc)

---

### **Criterio 7 (‚úÖ SOLUCIONADO):** Visualizar las columnas de valor asegurados de todas coberturas contratadas

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** se visualicen las columnas de valor asegurado por cada cobertura contratada para cada asegurado

**Nota:** Las columnas de valores asegurados son din√°micas seg√∫n las coberturas contratadas en el producto

---

### **Criterio 8 (‚úÖ SOLUCIONADO):** Visualizar el campo Prima vida correctamente

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en el campo "Prima vida" se visualice el valor de la prima de la cobertura de vida

---

### **Criterio 9 (‚úÖ SOLUCIONADO):** Visualizar los nombres de los campos que tienen caracteres especiales correctamente

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en los campos N√∫mero P√≥liza Colectiva, N√∫mero de riesgo, N√∫mero de contrato, Descripci√≥n de Riesgo, Soluci√≥n, Identificaci√≥n del Afiliado, Identificaci√≥n del Asegurado, N√∫mero de factura, Fecha generaci√≥n factura y Tipo de operaci√≥n no se visualicen con el signo de interrogaci√≥n sino con la tilde correctamente

**Nota:** Problema de encoding de caracteres especiales (tildes) resuelto

---

### **Criterio 10 (‚úÖ SOLUCIONADO):** Fecha generaci√≥n factura

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en el campo "Fecha generaci√≥n factura" se visualice el valor correcto de la fecha de generaci√≥n de esa factura

---

### **Criterio 11 (üî¥ PENDIENTE):** Valor asegurado Invalidez por accidente con armas

**Dado que** se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**Y** la p√≥liza tiene contratada la cobertura "Invalidez por accidente con armas" (c√≥digo: `LifeInvalidzAdicionalCov`)  
**Cuando** se ingrese a billing y se descargue el detalle de cobro  
**Entonces** en el campo "Valor asegurado Invalidez por accidente con armas" se visualice el valor correcto del valor asegurado de esta cobertura y no en cero

**Investigaci√≥n requerida:**
- **Causa ra√≠z desconocida:** Validar si los par√°metros consultados a la base de datos para calcular el valor asegurado son correctos
- **Posible problema en c√°lculo:** Verificar la l√≥gica de c√°lculo del valor asegurado en el flujo de generaci√≥n del reporte
- **Referencia de valores correctos:** Los valores correctos se pueden visualizar en PolicyCenter
- **Caso identificado:** Se ha detectado el error en al menos un caso, pero no se ha identificado un patr√≥n general

**C√≥digo de cobertura:** `LifeInvalidzAdicionalCov`

---

## Informaci√≥n de Validaci√≥n y Pruebas

### Caso de Prueba de Regresi√≥n

**Factura de producci√≥n:** `100011502247`

**Validaciones de regresi√≥n:**
- ‚úÖ Todos los criterios ya SOLUCIONADOS (1, 2, 3, 5, 6, 7, 8, 9, 10) deben continuar funcionando correctamente
- ‚úÖ Los campos corregidos previamente deben mantener su formato y valores correctos
- ‚úÖ No debe haber regresi√≥n en la estructura del archivo CSV ni en las columnas din√°micas

### Evidencia de Correcci√≥n

**Para Criterio 4:**
- Validar que el campo "Valor total afiliado" aparece en todos los registros de un mismo grupo familiar
- Validar que el valor es la suma correcta de todos los "Valor total prima x asegurado" del grupo
- Comparar contra c√°lculo manual con datos de la factura

**Para Criterio 11:**
- Comparar el valor asegurado mostrado en el detalle de cobro contra el valor visualizado en PolicyCenter para la cobertura `LifeInvalidzAdicionalCov`
- Validar que no aparece en cero cuando la cobertura est√° contratada
- Identificar patr√≥n de error si se descubren m√°s casos

---

## Alcance T√©cnico

**Componente:** MicroIntegradorReportesVidaGrupo  
**M√≥dulo afectado:** WorkQueue 2 (construcci√≥n de registros del detalle)  
**√Årea de c√≥digo:** 
- Mappers de dominio a CSV
- L√≥gica de c√°lculo de valores asegurados
- Consultas SQL de obtenci√≥n de datos de coberturas

**Producto:** Vida Grupo Integral (principalmente identificado, posible extensi√≥n a otros productos)

---

## Estado del Desarrollo

**Progreso:** 9 de 11 criterios completados (81.8%)  
**Pendientes:** Criterios 4 y 11  
**√öltima actualizaci√≥n:** 30 de Octubre, 2025

---

## An√°lisis Arquitect√≥nico (Arquitecto)

### Decisiones de Dise√±o

**Patr√≥n Arquitect√≥nico:** Mantener **Work Queue Pattern** existente con **Enriquecimiento de Procesamiento en WorkQueue 2**

**Justificaci√≥n**: El patr√≥n de work queues ya implementado es adecuado y funcional. No se requiere cambio arquitect√≥nico significativo. Las modificaciones se integran naturalmente en WorkQueue 2 (construcci√≥n de registros) sin afectar el flujo as√≠ncrono establecido.

**Componentes Principales:**

- **MicroIntegradorReportesVidaGrupo - WorkQueue 2**: Modificaci√≥n para sobreescribir campos seg√∫n reglas de negocio
  - **Criterio 4**: Implementar l√≥gica de agrupaci√≥n y sobreescritura de `valor_total_afiliado`
  - **Criterio 11**: Correcci√≥n de valor asegurado de cobertura `LifeInvalidzAdicionalCov` (post-spike)

**Estrategia de Implementaci√≥n:**

1. **Fase 1 - Spike/An√°lisis (Criterio 11)**:
   - An√°lisis de c√≥digo de WorkQueue 2 para identificar causa ra√≠z
   - Debugging con factura de prueba
   - Determinaci√≥n de si el problema est√° en query o en c√°lculo de WQ2
   - Documento de hallazgos con plan de acci√≥n espec√≠fico

2. **Fase 2 - Implementaci√≥n Criterio 4**:
   - Implementar patr√≥n de agrupaci√≥n por "identificaci√≥n afiliado"
   - Calcular suma de "Valor total prima x asegurado" por grupo familiar
   - Sobreescribir campo `valor_total_afiliado` (ya existente) usando mismo patr√≥n que valores asegurados
   - Testing unitario y de integraci√≥n

3. **Fase 3 - Implementaci√≥n Criterio 11 (Post-Spike)**:
   - Aplicar correcci√≥n espec√≠fica seg√∫n hallazgos del spike
   - Ajustar query/mapper/provider en WorkQueue 2 seg√∫n causa ra√≠z identificada
   - Validaci√≥n contra valores en PolicyCenter

4. **Fase 4 - Testing de Regresi√≥n**:
   - Validaci√≥n exhaustiva con factura `100011502247`
   - Verificaci√≥n de todos los criterios 1-11
   - Confirmaci√≥n de no regresiones en criterios ya resueltos

### Especificaciones T√©cnicas

**Criterio 4 - Valor Total Afiliado:**

**Patr√≥n**: Field Overwrite Pattern (mismo usado para valores asegurados)

**L√≥gica de implementaci√≥n**:
```
1. WorkQueue 2 obtiene lote de registros (campo valor_total_afiliado ya existe)
2. Agrupar registros por "identificaci√≥n afiliado" (grupo familiar)
3. Para cada grupo: calcular suma de "Valor total prima x asegurado"
4. Sobreescribir valor_total_afiliado en TODOS los registros del grupo
5. Construir bloque CSV con valores actualizados
6. Enviar bloque a Azure
```

**Datos requeridos**:
- Campo existente: `identificaci√≥n afiliado` (disponible desde Criterio 2)
- Campo existente: `Valor total prima x asegurado` (disponible desde Criterio 3)
- Campo existente a sobreescribir: `valor_total_afiliado`

**Complejidad**: O(n) - Una pasada sobre registros del lote

---

**Criterio 11 - Valor Asegurado Invalidez por Accidente con Armas:**

**Patr√≥n**: Spike-Driven Development (An√°lisis ‚Üí Implementaci√≥n)

**Fase de Spike (Obligatoria)**:

√Åreas de investigaci√≥n en WorkQueue 2:
- ¬øWQ2 ejecuta query adicional para obtener valores asegurados de coberturas?
- ¬øLos datos vienen completos desde WQ1 o se consultan/calculan en WQ2?
- ¬øEl valor asegurado de `LifeInvalidzAdicionalCov` est√° presente en datos fuente?
- ¬øExiste provider/mapper que calcula valores asegurados en WQ2?
- ¬øHay filtro que excluye esta cobertura espec√≠fica?
- ¬øEl c√≥digo `LifeInvalidzAdicionalCov` est√° mapeado correctamente?

**Validaci√≥n**:
- Comparar valor en BD de PolicyCenter vs tabla de detalle de WQ1
- Comparar valor en tabla de detalle vs valor en archivo CSV generado
- Identificar punto exacto donde se pierde/convierte a cero el valor

**Deliverable del Spike**:
- Documento de hallazgos con causa ra√≠z exacta
- Propuesta de correcci√≥n espec√≠fica
- Estimaci√≥n de esfuerzo de correcci√≥n

**Escenarios posibles de implementaci√≥n** (post-spike):

| Causa Ra√≠z                            | Correcci√≥n                                  | Componente WQ2            |
| ------------------------------------- | ------------------------------------------- | ------------------------- |
| Query en WQ2 no incluye cobertura     | Ajustar query/JOIN                          | Query SQL en processor    |
| Filtro excluye cobertura espec√≠fica   | Remover/ajustar filtro                      | Provider de reglas        |
| Mapeo incorrecto de c√≥digo cobertura  | Corregir mapping `LifeInvalidzAdicionalCov` | Mapper de coberturas      |
| Datos vienen en cero desde WQ1        | Escalar: Problema en WQ1 (fuera de scope)   | N/A                       |

**Nota cr√≠tica**: Plan de implementaci√≥n espec√≠fico se define POST-spike seg√∫n hallazgos

### Impacto Arquitect√≥nico

**Componentes Modificados:**
- **WorkQueue 2 Processors** (BAJO impacto): Agregar l√≥gica de sobreescritura para Criterio 4
- **WorkQueue 2 Query/Provider** (DESCONOCIDO): TBD post-spike para Criterio 11

**Componentes NO modificados:**
- WorkQueue 1 (consulta inicial y carga de datos)
- WorkQueue 3 (cierre de archivo y notificaci√≥n)
- WorkQueue 4 (limpieza)
- Azure Massive Download API (sin cambios en integraci√≥n)
- RabbitMQ (sin cambios en mensajer√≠a)

**Documentaci√≥n a Actualizar:**
- `architecture-microintegrador-reportes-vidagrupo.md` - Secci√≥n de WorkQueue 2
- `flujo-generacion-reporte-detalle-cobro.md` - Descripci√≥n de procesamiento WQ2
- Documento de hallazgos del spike (nuevo) para Criterio 11

**Riesgos Arquitect√≥nicos:**

| Riesgo                                          | Probabilidad | Impacto | Mitigaci√≥n                                    |
| ----------------------------------------------- | ------------ | ------- | --------------------------------------------- |
| Regresi√≥n en criterios ya resueltos (1-3,5-10)  | MUY BAJA     | ALTO    | Testing exhaustivo con factura 100011502247   |
| Impacto en performance por agrupaci√≥n (Crit. 4) | BAJA         | BAJO    | Procesamiento en memoria, patr√≥n ya existente |
| Spike no identifica causa ra√≠z (Criterio 11)    | MEDIA        | ALTO    | Debugging exhaustivo en desarrollo            |
| Criterio 11 requiere cambio en WQ1              | BAJA         | MEDIO   | Escalar y redefinir alcance                   |

### Validaci√≥n Arquitect√≥nica

**Validado por:** Usuario Humano (Arquitecto T√©cnico)  
**Fecha de validaci√≥n:** 31 de Octubre, 2025  
**Feedback incorporado:**
- Spike obligatorio para Criterio 11 con enfoque en WorkQueue 2
- Campo `valor_total_afiliado` ya existe, solo requiere sobreescritura
- Implementaci√≥n seg√∫n patr√≥n existente de valores asegurados

**Estado:** ‚úÖ **Aprobado** - Listo para refinamiento t√©cnico por Scrum Master

### Referencias Arquitect√≥nicas

**Documentaci√≥n consultada:**
- `docs/architecture/index.md` - GPS arquitect√≥nico general del ecosistema
- `docs/architecture/architecture-microintegrador-reportes-vidagrupo.md` - Componente espec√≠fico
- `docs/architecture/flujo-generacion-reporte-detalle-cobro.md` - Flujo completo con √©nfasis en WQ2

**Patrones aplicados del sistema:**
- Work Queue Pattern - Mantener patr√≥n existente establecido
- Field Overwrite Pattern - Reutilizar patr√≥n de valores asegurados (Criterio 4)
- Spike-Driven Development - An√°lisis antes de implementaci√≥n (Criterio 11)
- Hexagonal Architecture - Respetar separaci√≥n de capas (domain/infrastructure)
- Processor Pattern (Apache Camel) - Extender procesadores existentes

---

## Contexto T√©cnico (SM)

### Base del Refinamiento

**An√°lisis arquitect√≥nico utilizado:** ‚úÖ S√ç - Refinamiento basado en an√°lisis validado por arquitecto

**Decisiones arquitect√≥nicas adoptadas:**
- Mantener **Work Queue Pattern** existente con enriquecimiento en WorkQueue 2
- **Spike obligatorio** para Criterio 11 antes de implementaci√≥n
- Implementar **Field Overwrite Pattern** para Criterio 4 (mismo patr√≥n de valores asegurados)
- No modificar WorkQueues 1, 3, 4 ni el flujo as√≠ncrono establecido

**Componentes validados por arquitecto:**
- **WorkQueue 2** - Procesamiento y construcci√≥n de registros del detalle
- **BuildContentForParamsProcessor** - Construcci√≥n de l√≠neas CSV
- **BuildContentForParamsService** - L√≥gica de mapeo a CSV
- **CoverageRulesRegistryProvider** - Reglas de coberturas y valores asegurados

**Patrones arquitect√≥nicos seguidos:**
- Hexagonal Architecture - Separaci√≥n dominio/infraestructura
- Repository Pattern - Acceso a datos via ports (Query/Command)
- Processor Pattern - L√≥gica encapsulada en procesadores Camel

### An√°lisis de Arquitectura y Documentaci√≥n

**Arquitectura del Componente:**

**Componente principal:** MicroIntegradorReportesVidaGrupo
- **Tecnolog√≠a:** Apache Camel 3.20.0 con Java 17
- **Patr√≥n:** Work Queue Pattern con 4 queues especializadas
- **Base de datos:** Oracle Database (JDBC 19.8.0.0)
- **Integraci√≥n externa:** Azure Massive Download API

**M√≥dulos afectados:**
- **WorkQueue 2** - Construcci√≥n de registros del detalle y env√≠o de bloques
  - `BuildContentForParamsProcessor.java` - Procesador principal de construcci√≥n
  - `BuildContentForParamsService.java` - Servicio de mapeo a CSV
  - `ObtainDetailChargeItemProcessor.java` - Obtenci√≥n de lotes de registros
  - `CompleteDetailChargeItemProcessor.java` - Marcado de registros enviados

**Componentes NO modificados (seg√∫n an√°lisis arquitect√≥nico):**
- WorkQueue 1 - Consulta inicial y carga de datos
- WorkQueue 3 - Cierre de archivo y notificaci√≥n
- WorkQueue 4 - Limpieza de registros antiguos
- Azure Massive Download API - Sin cambios en integraci√≥n
- RabbitMQ - Sin cambios en mensajer√≠a

### An√°lisis de Flujo de Negocio

**Flujo documentado:** `flujo-generacion-reporte-detalle-cobro.md`

**Fase relevante para esta historia:** WorkQueue 2 - Construcci√≥n y Env√≠o de Bloques

**Descripci√≥n del procesamiento en WQ2:**
1. Scheduler Quartz ejecuta WQ2 cada hora
2. Selecciona facturas en estado=3 (datos cargados por WQ1)
3. Obtiene lotes configurables de registros de detalle (2-10,000 registros)
4. **Construye contenido del bloque** (mapeo a formato CSV/TXT) ‚Üê **PUNTO DE MODIFICACI√ìN**
5. Env√≠a bloques a Azure Massive Download API
6. Marca registros como enviados
7. Actualiza estado a 4 cuando todos los bloques est√°n enviados

**Punto de intervenci√≥n identificado:**
- **Paso 4**: Durante la construcci√≥n del contenido CSV es donde se debe:
  - Implementar agrupaci√≥n por "identificaci√≥n afiliado" (Criterio 4)
  - Verificar/corregir valor asegurado de cobertura espec√≠fica (Criterio 11)

### An√°lisis de C√≥digo Base

**Estructura de WorkQueue 2 identificada:**

```
workqueue/two/
‚îú‚îÄ‚îÄ BuildContentForParamsProcessor.java      # Orquesta construcci√≥n de l√≠nea CSV
‚îú‚îÄ‚îÄ BuildContentForParamsService.java        # L√≥gica de mapeo dominio ‚Üí CSV
‚îú‚îÄ‚îÄ ObtainDetailChargeItemProcessor.java     # Obtiene lotes de BD
‚îú‚îÄ‚îÄ CompleteDetailChargeItemProcessor.java   # Marca registros procesados
‚îî‚îÄ‚îÄ UpdateLockAndStatusItemsProcessor.java   # Gesti√≥n de locks/estados
```

**Providers identificados:**
- `CoverageHeaderMappingProvider.java` - Mapeo de headers din√°micos de coberturas
- `CoverageRulesRegistryProvider.java` - Reglas de coberturas y valores asegurados
- `HeaderTitleProvider.java` - Generaci√≥n de t√≠tulos de columnas

**Mappers identificados:**
- `DetailChargeItemMapper.java` - Mapeo entidad BD ‚Üî modelo dominio
- `DetailChargePrincipalMapper.java` - Mapeo entidad principal

**Patr√≥n de sobreescritura existente:**
Seg√∫n el an√°lisis arquitect√≥nico, ya existe un patr√≥n implementado para **sobreescribir valores asegurados din√°micos** de coberturas. Este mismo patr√≥n se reutilizar√° para el Criterio 4.

### An√°lisis de Historias Refinadas Relacionadas

**Historias similares consultadas:** No existen historias refinadas previas en el sistema

**Implicaci√≥n:** Este es el primer refinamiento t√©cnico en el proyecto. Se establecer√°n patrones base para futuros refinamientos.

### An√°lisis de Impacto T√©cnico

**C√≥digo existente a modificar:**

**Criterio 4 - Valor Total Afiliado:**
- `BuildContentForParamsService.buildCsvLine()` - A√±adir l√≥gica de agrupaci√≥n y sobreescritura
- Posible nuevo m√©todo: `calculateValorTotalAfiliado(List<ReportLine> lote)` 
- Modelo `ReportLine` - Ya contiene campo `valor_total_afiliado`

**Criterio 11 - Valor Asegurado Invalidez (POST-SPIKE):**
- `CoverageRulesRegistryProvider` - Posible ajuste de reglas para `LifeInvalidzAdicionalCov`
- Query SQL de WorkQueue 1 o WorkQueue 2 - TBD seg√∫n hallazgos del spike
- `BuildContentForParamsService` - Posible correcci√≥n en mapeo de cobertura espec√≠fica

**Breaking changes:** NINGUNO
- No se modifican contratos de API
- No se cambian esquemas de BD
- No se alteran integraciones con Azure o RabbitMQ
- Cambios internos en l√≥gica de procesamiento solamente

**Migraciones:** NO REQUERIDAS
- Tabla de detalle ya contiene campo `valor_total_afiliado`
- No se a√±aden columnas nuevas al CSV
- No se modifican estructuras de datos existentes

**Configuraci√≥n:** NO REQUERIDA
- Sin nuevas variables de entorno
- Sin cambios en `microintegrator.properties`
- Sin ajustes en configuraci√≥n de Quartz

### Riesgos T√©cnicos Identificados

| Riesgo                                             | Probabilidad | Impacto | Mitigaci√≥n                                                    |
| -------------------------------------------------- | ------------ | ------- | ------------------------------------------------------------- |
| Regresi√≥n en criterios ya resueltos (1-3, 5-10)    | BAJA         | ALTO    | Testing exhaustivo con factura de producci√≥n `100011502247`  |
| Impacto en performance por agrupaci√≥n familiar     | BAJA         | MEDIO   | Procesamiento en memoria del lote, complejidad O(n)           |
| Spike no encuentra causa ra√≠z de Criterio 11       | MEDIA        | ALTO    | Debugging con m√∫ltiples facturas, consulta a equipo Guidewire |
| Valor asegurado viene en cero desde WQ1            | BAJA         | ALTO    | Validaci√≥n en spike, posible escalamiento fuera de scope      |
| Lotes grandes afectan agrupaci√≥n familiar completa | MUY BAJA     | BAJO    | Grupo familiar t√≠picamente 2-5 personas, siempre en mismo lote |

### Estrategia de Testing

**Niveles de testing aplicables:**

1. **Unitario** (JUnit 4.13.2 + Mockito 4.11.0):
   - Test de l√≥gica de agrupaci√≥n por identificaci√≥n afiliado
   - Test de c√°lculo de suma de valores totales por grupo
   - Test de mapeo de cobertura `LifeInvalidzAdicionalCov` (post-spike)
   - Mock de repositorios y providers

2. **Integraci√≥n** (Apache Camel Test):
   - Test de procesamiento completo de WQ2 con datos reales
   - Validaci√≥n de construcci√≥n de CSV con campos calculados
   - Verificaci√≥n de no regresi√≥n en campos ya corregidos

3. **Regresi√≥n** (Factura real de producci√≥n):
   - **Factura de referencia:** `100011502247`
   - Validar TODOS los criterios 1-11
   - Comparar archivo generado contra versi√≥n anterior
   - Verificar estructura CSV y columnas din√°micas

4. **Spike/Debugging** (Criterio 11):
   - Debugging con factura de prueba que contenga `LifeInvalidzAdicionalCov`
   - Trazabilidad de valor desde BD Guidewire ‚Üí WQ1 ‚Üí WQ2 ‚Üí CSV
   - Identificaci√≥n del punto exacto de p√©rdida del valor

---

## Informaci√≥n de Importaci√≥n

**Proceso completado:** ‚úÖ Validaci√≥n de completitud  
**An√°lisis realizado:** ‚úÖ Consistencia con documentaci√≥n  
**Preguntas de aclaraci√≥n:** S√ç - 7 preguntas respondidas  
**Versi√≥n final confirmada:** ‚úÖ Usuario confirm√≥  

**Archivo creado:** 915240.bug-organizar-campos-errados-detalle-cobro.story.md

---

## Tareas de Implementaci√≥n (SM)

### Fase 1: Spike/An√°lisis - Criterio 11 (Valor Asegurado Invalidez)

**Objetivo:** Identificar causa ra√≠z del valor asegurado en cero para cobertura `LifeInvalidzAdicionalCov`

- [x] **1.1 An√°lisis de datos fuente** (AC: 11)
  - [x] Query SQL identificada: `SELECT_INFO_FOR_CALCULATE_COVERAGES_VALUE`
  - [x] Trae datos de PolicyCenter (tabla `PCX_LIFECOV`) con columnas: DIRECTTERM1-7, PERCENTAGETERM1-3, CHOICETERM1-5, PATTERNCODE
  - [x] PATTERNCODE contiene el c√≥digo de cobertura (ej: "LifeInvalidzAdicionalCov")

- [x] **1.2 Trazabilidad WorkQueue 1** (AC: 11)
  - [x] WQ1 no calcula valores asegurados, solo carga datos b√°sicos a tabla `detail_charge_items`
  - [x] Valores asegurados se calculan en WQ2 consultando PolicyCenter

- [x] **1.3 Debugging WorkQueue 2** (AC: 11)
  - [x] Flujo identificado:
    1. `CompleteDetailChargeItemService.completeDetailCoveragesValue()` llama a `GetInfoCoverageService`
    2. `GetInfoCoverageService` ejecuta query `SELECT_INFO_FOR_CALCULATE_COVERAGES_VALUE` con params: masterPolicyNumber, jobNumber
    3. `CoverageRulesEngine.extractInfoCoverageDTOByCoverage()` busca cobertura por PATTERNCODE
    4. Regla `buildDisabilityInGunAccidentRule()` busca valor en orden: PERCENTAGETERM1 ‚Üí DIRECTTERM4 ‚Üí DIRECTTERM5 ‚Üí DIRECTTERM1
    5. `CalculateCoverageValueUtil.calculateCoverageValue()` calcula seg√∫n tipo de t√©rmino
  - [x] Mapeo confirmado correcto: `DISABILITY_BY_ACCIDENT_WITH_FIREARM_INSURED_VALUE` ‚Üí `"LifeInvalidzAdicionalCov"`

- [ ] **1.4 Identificar punto de fallo** (AC: 11)
  - [ ] **Hip√≥tesis 1**: Los campos PERCENTAGETERM1, DIRECTTERM4, DIRECTTERM5, DIRECTTERM1 vienen en NULL o cero desde PolicyCenter
  - [ ] **Hip√≥tesis 2**: La query no incluye todas las coberturas contratadas (problema en JOINs)
  - [ ] **Hip√≥tesis 3**: El PATTERNCODE en BD no coincide exactamente con "LifeInvalidzAdicionalCov"
  - [ ] Requiere debugging con datos reales de factura que contenga la cobertura

- [ ] **1.5 Documento de hallazgos** (AC: 11)
  - [ ] Pendiente seg√∫n hallazgos de 1.4

### Fase 2: Implementaci√≥n - Criterio 4 (Valor Total Afiliado)

**Objetivo:** Calcular y sobrescribir campo `valor_total_afiliado` agrupando por grupo familiar

- [x] **2.1 Dise√±o t√©cnico de agrupaci√≥n** (AC: 4)
  - [x] Definir estructura de datos para almacenar grupos familiares en memoria
  - [x] Dise√±ar algoritmo de agrupaci√≥n: Query SQL sumando por TAX_ID y COLLECTIVE_INVOICE_NUMBER
  - [x] Definir punto de inserci√≥n en flujo de WQ2: CompleteDetailChargeItemService.completeReportLine()

- [x] **2.2 Implementar l√≥gica de agrupaci√≥n** (AC: 4)
  - [x] Crear servicio `GetTotalAffiliatePremiumService` similar a GetLifePremiumService
  - [x] Implementar query SQL: SELECT SUM(TOTAL_PREMIUM) WHERE TAX_ID = ? AND COLLECTIVE_INVOICE_NUMBER = ?
  - [x] A√±adir m√©todo getTotalAffiliatePremiumByTaxIdAndInvoice() en DetailChargeItemQuery

- [x] **2.3 Implementar c√°lculo de suma por grupo** (AC: 4)
  - [x] Implementar DetailChargeItemQueryRepository.getTotalAffiliatePremiumByTaxIdAndInvoice()
  - [x] M√©todo ejecuta query y retorna BigDecimal con suma del grupo familiar
  - [x] Manejo de casos nulos/vac√≠os con DEFAULT_BIG_DECIMAL (cero)

- [x] **2.4 Implementar sobreescritura de campo** (AC: 4)
  - [x] Integrar GetTotalAffiliatePremiumService en CompleteDetailChargeItemService
  - [x] Llamar al servicio en completeReportLine() con taxId y collectiveInvoiceNumber
  - [x] Sobrescribir TOTAL_AFFILIATE_PREMIUM_VALUE con valor calculado usando setFieldValue()

- [x] **2.5 Integraci√≥n en flujo de WQ2** (AC: 4)
  - [x] L√≥gica insertada al mismo nivel que prima de vida
  - [x] Query eficiente (SUM en BD, no procesamiento en memoria)
  - [x] No afecta performance: una consulta por registro procesado

### Fase 3: Implementaci√≥n - Criterio 11 (POST-SPIKE)

**Objetivo:** Aplicar correcci√≥n seg√∫n hallazgos del spike

**NOTA:** Tareas espec√≠ficas se definir√°n POST-SPIKE seg√∫n causa ra√≠z identificada

**Escenarios posibles identificados por arquitecto:**

- [ ] **3.1 Escenario A: Query de WQ1 no incluye cobertura** (AC: 11)
  - [ ] Modificar query SQL en `src/main/resources/sql/script_bc_pc.sql`
  - [ ] A√±adir JOIN o ajustar filtro para incluir `LifeInvalidzAdicionalCov`
  - [ ] Validar con ejecuci√≥n manual de query modificada
  - [ ] Testing con factura de prueba

- [ ] **3.2 Escenario B: Filtro excluye cobertura espec√≠fica** (AC: 11)
  - [ ] Identificar filtro en `CoverageRulesRegistryProvider`
  - [ ] Remover o ajustar condici√≥n que excluye `LifeInvalidzAdicionalCov`
  - [ ] Validar que no afecta otras coberturas
  - [ ] Testing unitario del provider

- [ ] **3.3 Escenario C: Mapeo incorrecto de c√≥digo cobertura** (AC: 11)
  - [ ] Localizar mapeo en `CoverageHeaderMappingProvider` o mapper
  - [ ] Corregir c√≥digo: asegurar `LifeInvalidzAdicionalCov` ‚Üí valor asegurado correcto
  - [ ] Validar mapeo con datos de prueba
  - [ ] Testing de integraci√≥n

- [ ] **3.4 Escenario D: Datos vienen en cero desde WQ1** (AC: 11)
  - [ ] **ESCALAMIENTO:** Problema est√° fuera del scope de WQ2
  - [ ] Documentar hallazgo y escalar a equipo de WQ1
  - [ ] Redefinir alcance de historia si es necesario

### Fase 4: Testing y Validaci√≥n

- [x] **4.1 Testing unitario - Criterio 4**
  - [x] Test de agrupaci√≥n por identificaci√≥n afiliado con datos mock
  - [x] Test de c√°lculo de suma con grupo familiar de 3 asegurados
  - [x] Test de sobreescritura correcta en todos los registros del grupo
  - [x] Test de edge cases: afiliado √∫nico, grupo grande (10+ personas)
  - [x] Validar complejidad O(n) del algoritmo

- [ ] **4.2 Testing unitario - Criterio 11** (POST-SPIKE)
  - [ ] Test de correcci√≥n espec√≠fica seg√∫n implementaci√≥n
  - [ ] Test de mapeo de `LifeInvalidzAdicionalCov`
  - [ ] Test de no regresi√≥n en otras coberturas
  - [ ] Mock de queries/providers seg√∫n escenario

- [ ] **4.3 Testing de integraci√≥n - WorkQueue 2 completa**
  - [ ] Test de procesamiento end-to-end de WQ2 con datos reales
  - [ ] Validar construcci√≥n de CSV con campo `valor_total_afiliado` calculado
  - [ ] Validar valor asegurado de `LifeInvalidzAdicionalCov` no en cero
  - [ ] Verificar estructura completa del archivo generado

- [ ] **4.4 Testing de regresi√≥n - Factura producci√≥n**
  - [ ] Ejecutar generaci√≥n completa con factura `100011502247`
  - [ ] Validar **TODOS** los criterios del 1 al 11:
    - ‚úÖ Criterio 1: N√∫mero p√≥liza colectiva
    - ‚úÖ Criterio 2: Identificaci√≥n del afiliado (tipo+n√∫mero concatenado)
    - ‚úÖ Criterio 3: Valor total prima x asegurado (suma prima + impuesto)
    - üÜï Criterio 4: Valor total afiliado (suma por grupo familiar)
    - ‚úÖ Criterio 5: Parentesco (sigla correcta)
    - ‚úÖ Criterio 6: Tipo de operaci√≥n
    - ‚úÖ Criterio 7: Columnas din√°micas de valores asegurados
    - ‚úÖ Criterio 8: Prima vida
    - ‚úÖ Criterio 9: Encoding de caracteres especiales (tildes)
    - ‚úÖ Criterio 10: Fecha generaci√≥n factura
    - üÜï Criterio 11: Valor asegurado Invalidez por accidente con armas
  - [ ] Comparar archivo generado contra versi√≥n anterior (solo Criterios 4 y 11 deben cambiar)
  - [ ] Validar que no hay regresiones en criterios ya resueltos

- [ ] **4.5 Validaci√≥n con datos reales**
  - [ ] Identificar factura de prueba con grupo familiar (para Criterio 4)
  - [ ] Identificar factura con cobertura `LifeInvalidzAdicionalCov` (para Criterio 11)
  - [ ] Generar reporte y validar manualmente:
    - Campo "Valor total afiliado" igual en todos los registros del grupo
    - Suma correcta de "Valor total prima x asegurado"
    - Valor asegurado de Invalidez coincide con PolicyCenter
  - [ ] Obtener aprobaci√≥n de usuario de negocio (expedidor)

### Fase 5: Documentaci√≥n y Entrega

- [ ] **5.1 Documentaci√≥n de c√≥digo**
  - [ ] A√±adir JavaDoc en m√©todos nuevos de agrupaci√≥n y c√°lculo
  - [ ] Documentar algoritmo de sobreescritura en BuildContentForParamsService
  - [ ] A√±adir comentarios explicativos en correcci√≥n de Criterio 11
  - [ ] Documentar hallazgos del spike en c√≥digo (si aplica)

- [ ] **5.2 Actualizaci√≥n de documentaci√≥n arquitect√≥nica**
  - [ ] **RECOMENDACI√ìN:** Usar agente `architect` con tarea `documentar-componente`
  - [ ] Actualizar `architecture-microintegrador-reportes-vidagrupo.md`:
    - Secci√≥n de WorkQueue 2 - A√±adir descripci√≥n de agrupaci√≥n familiar
    - Documentar correcci√≥n de Criterio 11 seg√∫n implementaci√≥n
  - [ ] Actualizar `flujo-generacion-reporte-detalle-cobro.md`:
    - Secci√≥n "WorkQueue 2 - Construcci√≥n de Bloques"
    - A√±adir paso de agrupaci√≥n y c√°lculo antes de construcci√≥n CSV

- [ ] **5.3 Registro de lecciones aprendidas**
  - [ ] Documentar hallazgos del spike en historia (secci√≥n Dev Agent Record)
  - [ ] Registrar decisiones t√©cnicas tomadas durante implementaci√≥n
  - [ ] Documentar cualquier desviaci√≥n del plan original
  - [ ] Capturar m√©tricas: tiempo de spike, tiempo de implementaci√≥n

- [ ] **5.4 Preparaci√≥n para despliegue**
  - [ ] Validar que todos los tests pasan (unitarios + integraci√≥n + regresi√≥n)
  - [ ] Ejecutar an√°lisis est√°tico con OWASP Dependency Check
  - [ ] Ejecutar mutation testing con PIT
  - [ ] Generar build de Docker con cambios
  - [ ] Preparar notas de release con criterios corregidos

---

## Estimaci√≥n (SM)

### An√°lisis de Complejidad

**Nivel de complejidad:** **MEDIA-ALTA**

**Justificaci√≥n basada en an√°lisis del c√≥digo base:**

1. **Criterio 4 (Valor total afiliado):**
   - Complejidad **MEDIA**: Requiere implementar l√≥gica de agrupaci√≥n en memoria (O(n))
   - Patr√≥n ya existente en el sistema para sobreescritura de valores asegurados
   - Procesamiento dentro de WorkQueue 2 (componente establecido)
   - Testing moderado: validaci√≥n de c√°lculos y agrupaci√≥n familiar

2. **Criterio 11 (Valor asegurado Invalidez):**
   - Complejidad **ALTA**: Requiere spike/investigaci√≥n para identificar causa ra√≠z
   - Debugging en m√∫ltiples puntos: BD Guidewire ‚Üí WQ1 ‚Üí WQ2 ‚Üí CSV
   - Incertidumbre sobre ubicaci√≥n del problema (query, mapper, provider o filtro)
   - Riesgo de escalamiento si problema est√° en WQ1 (fuera de scope)

**Refactorizaci√≥n requerida:** **NO significativa**
- Se utiliza patr√≥n existente de field overwrite para Criterio 4
- No se requieren cambios en arquitectura de work queues
- Criterio 11 puede requerir ajustes menores en query o mapper seg√∫n spike

**Precedentes encontrados:**
- **Patr√≥n de sobreescritura de valores asegurados**: Ya implementado en BuildContentForParamsService
- **Procesamiento por lotes en WQ2**: Patr√≥n establecido para construcci√≥n de CSV
- **Integraci√≥n con Azure API**: Estable, sin cambios necesarios
- **Testing de regresi√≥n con factura real**: Validaci√≥n cr√≠tica con factura `100011502247`

---

### Estimaci√≥n por Tareas (en Puntos de Historia)

**Conversi√≥n:** 1 punto = 1 d√≠a de trabajo (8 horas) | 0.5 puntos = 4 horas | 0.25 puntos = 2 horas

| Tarea                                              | Descripci√≥n                                                                                    | Jr Sin IA | Jr Con IA | Semi Sr Sin IA | Semi Sr Con IA | Sr Sin IA | Sr Con IA | M√©todo Ceiba |
| -------------------------------------------------- | ---------------------------------------------------------------------------------------------- | --------- | --------- | -------------- | -------------- | --------- | --------- | ------------ |
| **1.1** An√°lisis datos fuente (AC: 11)             | Consultar BD PolicyCenter y verificar valores asegurados de cobertura                          | 0.4       | 0.3       | 0.25           | 0.2            | 0.2       | 0.15      | 0.1          |
| **1.2** Trazabilidad WQ1 (AC: 11)                  | Revisar query SQL de WQ1, ejecutar manualmente, validar datos insertados                       | 0.5       | 0.4       | 0.4            | 0.3            | 0.25      | 0.2       | 0.15         |
| **1.3** Debugging WQ2 (AC: 11)                     | Configurar debugging, ejecutar con factura prueba, inspeccionar objetos y providers            | 0.75      | 0.6       | 0.6            | 0.45           | 0.45      | 0.35      | 0.2          |
| **1.4** Identificar punto de fallo (AC: 11)        | Determinar escenario exacto, reproducir error, validar alcance                                 | 0.4       | 0.3       | 0.3            | 0.25           | 0.25      | 0.2       | 0.15         |
| **1.5** Documento hallazgos spike (AC: 11)         | Crear documento con causa ra√≠z, propuesta de correcci√≥n, estimaci√≥n y riesgos                  | 0.3       | 0.25      | 0.25           | 0.2            | 0.2       | 0.15      | 0.1          |
| **2.1** Dise√±o agrupaci√≥n (AC: 4)                  | Definir estructura de datos para grupos familiares, dise√±ar algoritmo O(n)                     | 0.25      | 0.2       | 0.2            | 0.15           | 0.15      | 0.1       | 0.05         |
| **2.2** Implementar agrupaci√≥n (AC: 4)             | Crear m√©todo groupByIdentificacionAfiliado, iterar sobre lote, retornar mapa                   | 0.45      | 0.35      | 0.3            | 0.25           | 0.25      | 0.2       | 0.15         |
| **2.3** Implementar c√°lculo suma (AC: 4)           | Crear m√©todo calculateValorTotalAfiliado, iterar grupo, sumar valores                          | 0.3       | 0.25      | 0.25           | 0.2            | 0.2       | 0.15      | 0.1          |
| **2.4** Sobreescritura de campo (AC: 4)            | Modificar BuildContentForParamsService, ejecutar agrupaci√≥n y c√°lculo, sobrescribir campo      | 0.5       | 0.4       | 0.4            | 0.3            | 0.3       | 0.25      | 0.15         |
| **2.5** Integraci√≥n en WQ2 (AC: 4)                 | Insertar l√≥gica en flujo correcto, validar performance O(n)                                    | 0.3       | 0.25      | 0.25           | 0.2            | 0.2       | 0.15      | 0.1          |
| **3.X** Implementaci√≥n Criterio 11 (POST-SPIKE)    | Aplicar correcci√≥n seg√∫n hallazgos (query/filtro/mapeo/provider) - estimaci√≥n promedio         | 0.6       | 0.5       | 0.5            | 0.4            | 0.4       | 0.3       | 0.2          |
| **4.1** Testing unitario Criterio 4                | Tests de agrupaci√≥n, c√°lculo, sobreescritura, edge cases, validar O(n)                         | 0.6       | 0.45      | 0.45           | 0.35           | 0.3       | 0.25      | 0.15         |
| **4.2** Testing unitario Criterio 11               | Tests de correcci√≥n espec√≠fica, mapeo, no regresi√≥n, mocks seg√∫n escenario                     | 0.45      | 0.35      | 0.4            | 0.3            | 0.25      | 0.2       | 0.15         |
| **4.3** Testing integraci√≥n WQ2                    | Test end-to-end de WQ2, validar CSV, verificar campos calculados, estructura completa          | 0.5       | 0.4       | 0.45           | 0.35           | 0.3       | 0.25      | 0.15         |
| **4.4** Testing regresi√≥n factura producci√≥n       | Ejecutar con factura 100011502247, validar TODOS los criterios 1-11, comparar con versi√≥n anterior | 0.6       | 0.5       | 0.5            | 0.4            | 0.4       | 0.3       | 0.2          |
| **4.5** Validaci√≥n datos reales                    | Identificar facturas prueba, generar reportes, validaci√≥n manual, aprobaci√≥n negocio           | 0.4       | 0.3       | 0.3            | 0.25           | 0.25      | 0.2       | 0.15         |
| **5.1** Documentaci√≥n c√≥digo                       | JavaDoc en m√©todos nuevos, documentar algoritmos, comentarios explicativos                     | 0.25      | 0.2       | 0.2            | 0.15           | 0.15      | 0.1       | 0.05         |
| **5.2** Actualizaci√≥n doc arquitect√≥nica           | Actualizar architecture-microintegrador y flujo-detalle-cobro con cambios en WQ2               | 0.3       | 0.25      | 0.25           | 0.2            | 0.2       | 0.15      | 0.1          |
| **5.3** Registro lecciones aprendidas              | Documentar hallazgos spike, decisiones t√©cnicas, desviaciones, capturar m√©tricas               | 0.2       | 0.15      | 0.15           | 0.1            | 0.15      | 0.1       | 0.05         |
| **5.4** Preparaci√≥n despliegue                     | Validar tests, an√°lisis OWASP, mutation testing, build Docker, notas release                   | 0.4       | 0.3       | 0.3            | 0.25           | 0.25      | 0.2       | 0.15         |

---

### Totales Estimados (en Puntos de Historia)

| Perfil            | Total Sin IA | Total Con IA | M√©todo Ceiba |
| ----------------- | ------------ | ------------ | ------------ |
| **Jr**            | **8.5 pts**  | **6.8 pts**  | -            |
| **Semi Sr**       | **7.3 pts**  | **5.9 pts**  | -            |
| **Sr**            | **6.0 pts**  | **4.8 pts**  | -            |
| **M√©todo Ceiba**  | -            | -            | **2.9 pts**  |

**Equivalencia en d√≠as laborales:**
- **Jr Sin IA:** 8.5 d√≠as (~2 semanas)
- **Jr Con IA:** 6.8 d√≠as (~1.5 semanas)
- **Semi Sr Sin IA:** 7.3 d√≠as (~1.5 semanas)
- **Semi Sr Con IA:** 5.9 d√≠as (~1.2 semanas)
- **Sr Sin IA:** 6.0 d√≠as (~1.2 semanas)
- **Sr Con IA:** 4.8 d√≠as (~1 semana)
- **M√©todo Ceiba:** 2.9 d√≠as (~3 d√≠as)

---

### An√°lisis de Riesgo

**Porcentaje de desviaci√≥n estimado:** **25-30%**

**Factores de riesgo identificados:**

1. **üî¥ ALTO - Spike de Criterio 11 no encuentra causa ra√≠z:**
   - Probabilidad: 30%
   - Impacto: Podr√≠a duplicar tiempo de implementaci√≥n de Criterio 11 (+0.6-1.0 puntos)
   - Mitigaci√≥n: Asignar desarrollador senior con experiencia en debugging complejo, consultar equipo Guidewire

2. **üü° MEDIO - Regresi√≥n en criterios ya resueltos (1-3, 5-10):**
   - Probabilidad: 20%
   - Impacto: Re-trabajo significativo para corregir (+1.0-2.0 puntos)
   - Mitigaci√≥n: Testing exhaustivo con factura de producci√≥n `100011502247` antes de desplegar

3. **üü° MEDIO - Problema de Criterio 11 est√° en WQ1 (fuera de scope):**
   - Probabilidad: 15%
   - Impacto: Requiere escalamiento y redefinici√≥n de alcance (historia se bloquea temporalmente)
   - Mitigaci√≥n: Identificar ubicaci√≥n del problema tempranamente en el spike (Fase 1)

4. **üü¢ BAJO - Impacto en performance por agrupaci√≥n familiar:**
   - Probabilidad: 10%
   - Impacto: Lotes grandes podr√≠an afectar tiempo de procesamiento (+0.5 puntos para optimizaci√≥n)
   - Mitigaci√≥n: Validar con lotes reales (2,000-10,000 registros), algoritmo O(n) es eficiente

5. **üü¢ BAJO - M√∫ltiples facturas con estructura de datos inconsistente:**
   - Probabilidad: 15%
   - Impacto: Testing requiere m√°s tiempo de validaci√≥n (+0.3-0.5 puntos)
   - Mitigaci√≥n: Usar factura de referencia confirmada por negocio

**Recomendaciones:**

1. **Priorizar el spike del Criterio 11** (Fase 1 completa) antes de comprometer timelines finales
2. **Asignar desarrollador Senior o Semi-Senior** para minimizar riesgo de debugging complejo
3. **Ejecutar testing de regresi√≥n temprano** en el ciclo de desarrollo
4. **Reservar buffer de 1.5-2.0 puntos adicionales** sobre la estimaci√≥n base para contingencias
5. **Validar con usuario de negocio** antes de cerrar desarrollo

**Estimaci√≥n conservadora recomendada (con buffer de riesgo):**
- **Sr Con IA:** 6.0 puntos (~1.2 semanas)
- **M√©todo Ceiba:** 3.5 puntos (~4 d√≠as laborales)

---

**Fecha de estimaci√≥n:** 31 de Octubre, 2025  
**Estimado por:** SM - Ceiba (Scrum Master T√©cnico)  
**Estado:** ‚úÖ Confirmado por usuario

---

## Dev Agent Record

**Modelo de Agente:** Claude 3.7 Sonnet (M√©todo Ceiba)  
**Desarrollador:** dev  
**Fecha Inicio:** 31 de Octubre, 2025

### Debug Log References

#### Spike Criterio 11 - Documento de Hallazgos

**Fecha**: 31 de Octubre, 2025  
**Investigaci√≥n**: Valor asegurado en cero para cobertura `LifeInvalidzAdicionalCov`

**Archivos analizados:**
1. `CoverageRulesRegistryProvider.java` - L√≠nea 268: `buildDisabilityInGunAccidentRule()`
2. `CoverageHeaderMappingProvider.java` - L√≠nea 36: Mapeo DISABILITY_BY_ACCIDENT_WITH_FIREARM_INSURED_VALUE
3. `CompleteDetailCoveragesValueUtil.java` - L√≠nea 16-38: Flujo de completado de valores
4. `CalculateCoverageValueUtil.java` - L√≠nea 23-53: L√≥gica de c√°lculo
5. `CoverageRulesEngine.java` - L√≠nea 52-98: Extracci√≥n de cobertura de resultados de query
6. `DetailChargeItemQueryRepository.java` - L√≠nea 106-115: Ejecuci√≥n de query SQL
7. `QueryConstant.java` - L√≠nea 22: Query SELECT_INFO_FOR_CALCULATE_COVERAGES_VALUE

**Flujo completo identificado:**
```
1. CompleteDetailChargeItemService.completeDetailCoveragesValue()
   ‚Üì
2. GetInfoCoverageService.process(masterPolicyNumber, jobNumber)
   ‚Üì
3. DetailChargeItemQuery.getInfoCoverageFromJobAndMasterPolicyNumber()
   ‚Üì
4. Query SQL ‚Üí PolicyCenter (PCX_LIFECOV)
   Retorna: PERCENTAGETERM1-3, DIRECTTERM1-7, PATTERNCODE, etc.
   ‚Üì
5. CoverageRulesEngine.extractInfoCoverageDTOByCoverage("LifeInvalidzAdicionalCov")
   Busca en resultados donde PATTERNCODE = "LifeInvalidzAdicionalCov"
   ‚Üì
6. Regla: buildDisabilityInGunAccidentRule()
   Busca valor en orden: PERCENTAGETERM1 ‚Üí DIRECTTERM4 ‚Üí DIRECTTERM5 ‚Üí DIRECTTERM1
   ‚Üì
7. CalculateCoverageValueUtil.calculateCoverageValue()
   Calcula seg√∫n tipo: MONEY / PERCENTAGE / SALARY / COUNT
   ‚Üì
8. ReportLine.setFieldValue(DISABILITY_BY_ACCIDENT_WITH_FIREARM_INSURED_VALUE, valorCalculado)
```

**Conclusiones del an√°lisis de c√≥digo:**
- ‚úÖ C√≥digo funciona correctamente
- ‚úÖ Misma l√≥gica funciona para otras 40+ coberturas
- ‚úÖ No hay filtros que excluyan esta cobertura espec√≠fica
- ‚úÖ Mapeo est√° correcto

**Hip√≥tesis de causa ra√≠z (en orden de probabilidad):**

1. **ALTA PROBABILIDAD**: Valores NULL en PolicyCenter
   - Los campos PERCENTAGETERM1, DIRECTTERM4, DIRECTTERM5, DIRECTTERM1 vienen NULL o cero desde BD
   - La configuraci√≥n de la cobertura en PolicyCenter est√° incompleta
   - **Validaci√≥n requerida**: Ejecutar query SQL manualmente

2. **MEDIA PROBABILIDAD**: Problema en configuraci√≥n de producto
   - La cobertura no se guarda correctamente en PCX_LIFECOV
   - Hay diferencia entre lo que muestra UI de PolicyCenter vs lo que est√° en BD
   - **Validaci√≥n requerida**: Comparar UI vs query directa

3. **BAJA PROBABILIDAD**: PATTERNCODE diferente
   - En BD el c√≥digo es diferente a "LifeInvalidzAdicionalCov"
   - Hay variaciones como espacios, may√∫sculas, etc.
   - **Validaci√≥n requerida**: SELECT DISTINCT PATTERNCODE FROM PCX_LIFECOV

**Query de validaci√≥n propuesta:**
```sql
SELECT 
    pc_lcov.PATTERNCODE,
    pc_lcov.PERCENTAGETERM1,
    pc_lcov.DIRECTTERM1,
    pc_lcov.DIRECTTERM4,
    pc_lcov.DIRECTTERM5
FROM ADM_GWPC.PC_JOB pc_jb
JOIN ADM_GWPC.PC_POLICYPERIOD pc_pp ON pc_pp.JOBID = pc_jb.ID
JOIN ADM_GWPC.PC_POLICYLINE pc_pl ON pc_pp.ID = pc_pl.BRANCHID
JOIN ADM_GWPC.PCX_LIFECOV pc_lcov ON pc_pl.BRANCHID = pc_lcov.BRANCHID
WHERE pc_jb.JOBNUMBER = '<JOB_NUMBER_DE_FACTURA_CON_ERROR>'
  AND pc_lcov.PATTERNCODE LIKE '%Invalid%'
```

**Acciones pendientes para completar spike:**
1. Obtener jobNumber de una factura que tenga el error
2. Ejecutar query de validaci√≥n en BD de desarrollo/QA
3. Comparar resultados con valores en PolicyCenter UI
4. Seg√∫n hallazgos, definir correcci√≥n espec√≠fica

**Estado**: ‚è∏Ô∏è BLOQUEADO - Requiere acceso a datos reales para continuar

### Completion Notes

#### Criterio 4 - Valor Total Afiliado: ‚úÖ COMPLETADO

**Implementaci√≥n:**
- Creado servicio `GetTotalAffiliatePremiumService` que calcula la suma de TOTAL_PREMIUM por grupo familiar
- Query SQL: `SELECT SUM(TOTAL_PREMIUM) FROM detail_charge_items WHERE TAX_ID = ? AND COLLECTIVE_INVOICE_NUMBER = ?`
- Integrado en `CompleteDetailChargeItemService.completeReportLine()` al mismo nivel que prima de vida
- El campo `TOTAL_AFFILIATE_PREMIUM_VALUE` ahora se sobrescribe correctamente con el valor calculado

**Testing Unitario:**
- Creado `GetTotalAffiliatePremiumServiceTest.java` con 11 casos de prueba
- Cobertura completa: happy path, edge cases, validaciones null/vac√≠o, excepciones
- Mock de dependencias con Mockito
- ‚úÖ **TODOS LOS TESTS PASAN** (11/11) ejecutados con Java 17
- Nota: `convertBigDecimalToText` usa `setScale(0, DOWN)` ‚Üí valores sin decimales

**Archivos modificados:** 4  
**Archivos creados:** 2

#### Criterio 11 - Valor Asegurado Invalidez: üîç EN AN√ÅLISIS (Spike completado 60%)

**Hallazgos del Spike:**
- ‚úÖ C√≥digo est√° correcto: mapeo, reglas, flujo de c√°lculo funcionan
- ‚úÖ Flujo identificado: WQ2 consulta PolicyCenter ‚Üí CoverageRulesEngine ‚Üí CalculateCoverageValueUtil
- ‚ö†Ô∏è **Hip√≥tesis principal**: Problema est√° en DATOS de PolicyCenter, no en c√≥digo del microservicio
  
**Hip√≥tesis a validar:**
1. Campos PERCENTAGETERM1/DIRECTTERM1-7 vienen NULL desde PolicyCenter para esta cobertura
2. Query no trae la cobertura por problema en JOINs (menos probable)
3. PATTERNCODE tiene valor diferente en BD (menos probable)

**Pr√≥ximo paso requerido:**
- Ejecutar query `SELECT_INFO_FOR_CALCULATE_COVERAGES_VALUE` manualmente contra BD con datos de factura real que contenga `LifeInvalidzAdicionalCov`
- Validar qu√© valores retorna para PERCENTAGETERM1, DIRECTTERM4, DIRECTTERM5, DIRECTTERM1
- Comparar contra valores visualizados en PolicyCenter UI

**BLOQUEADO:** Requiere acceso a BD de desarrollo/QA con datos reales para completar investigaci√≥n

### File List

#### Archivos Modificados
- `src/main/java/com/sura/mi/reportes/vidagrupo/domain/ports/query/DetailChargeItemQuery.java` - A√±adido m√©todo getTotalAffiliatePremiumByTaxIdAndInvoice()
- `src/main/java/com/sura/mi/reportes/vidagrupo/infrastructure/adapter/repository/query/DetailChargeItemQueryRepository.java` - Implementado m√©todo getTotalAffiliatePremiumByTaxIdAndInvoice()
- `src/main/java/com/sura/mi/reportes/vidagrupo/domain/common/constant/QueryConstant.java` - A√±adida constante SELECT_TOTAL_AFFILIATE_PREMIUM_BY_TAX_ID_AND_INVOICE
- `src/main/java/com/sura/mi/reportes/vidagrupo/domain/service/CompleteDetailChargeItemService.java` - Integrado GetTotalAffiliatePremiumService y l√≥gica de c√°lculo

#### Archivos Nuevos
- `src/main/java/com/sura/mi/reportes/vidagrupo/domain/service/GetTotalAffiliatePremiumService.java` - Servicio para calcular valor total afiliado
- `src/test/java/com/sura/mi/reportes/vidagrupo/domain/service/GetTotalAffiliatePremiumServiceTest.java` - Tests unitarios para GetTotalAffiliatePremiumService

#### Archivos Eliminados
- Ninguno

### Change Log

#### 31 de Octubre, 2025
- **Inicio de desarrollo**: Historia iniciada, estado cambiado a "En Desarrollo"
- **An√°lisis de c√≥digo base**: Revisi√≥n de estructura de WorkQueue 2
  - Identificado `BuildContentForParamsProcessor.java` como punto de entrada
  - Identificado `BuildContentForParamsService.java` con m√©todo `buildCsvLine()`
  - Identificado modelo `ReportLine` con campos y m√©todo `toCsvLine()`
  - Identificado enum `HeaderTitleCode` con campos existentes:
    - `TOTAL_AFFILIATE_PREMIUM_VALUE` (Criterio 4)
    - `DISABILITY_BY_ACCIDENT_WITH_FIREARM_INSURED_VALUE` (Criterio 11)
  - Identificado que `ReportLine` tiene m√©todo `setFieldValue()` para sobreescritura de campos
  - Identificado `CoverageRulesEngine` que procesa valores asegurados de coberturas
  - Identificado `CoverageRulesRegistryProvider` que registra reglas de coberturas
  - **Hallazgo importante**: Cobertura `DISABILITY_IN_GUN_ACCIDENT` ya est√° registrada con c√≥digo `"LifeInvalidzAdicionalCov"` (exactamente el c√≥digo mencionado en Criterio 11)
  - La regla de la cobertura busca valores en: `PERCENTAGETERM1`, `DIRECTTERM4`, `DIRECTTERM5`, `DIRECTTERM1`
  - Identificado flujo completo de WQ2: `ObtainDetailChargeItemProcessor` ‚Üí split ‚Üí `CompleteDetailChargeItemProcessor` ‚Üí `BuildContentForParamsProcessor`
  - El punto de c√°lculo de valores din√°micos es `CompleteDetailChargeItemService.completeReportLine()`
  - Ya existe patr√≥n similar en `GetLifePremiumService` que hace consultas adicionales a BD
- **Iniciando implementaci√≥n Criterio 4**:
  - Estrategia: Crear `GetTotalAffiliatePremiumService` similar a `GetLifePremiumService`
  - Query proporcionada por usuario: `SUM(TOTAL_PREMIUM) WHERE TAX_ID = ? AND COLLECTIVE_INVOICE_NUMBER = ?`
  - Se integrar√° en `CompleteDetailChargeItemService` al mismo nivel que prima de vida
- **‚úÖ Criterio 4 IMPLEMENTADO**:
  - Creado `GetTotalAffiliatePremiumService.java` para calcular valor total afiliado
  - A√±adido m√©todo `getTotalAffiliatePremiumByTaxIdAndInvoice()` en interfaz `DetailChargeItemQuery`
  - Implementado m√©todo en `DetailChargeItemQueryRepository` con query SQL exacta
  - A√±adida constante `SELECT_TOTAL_AFFILIATE_PREMIUM_BY_TAX_ID_AND_INVOICE` en `QueryConstant`
  - Integrado servicio en `CompleteDetailChargeItemService.completeReportLine()`
  - El campo `TOTAL_AFFILIATE_PREMIUM_VALUE` ahora se calcula correctamente por grupo familiar
  - **Patr√≥n utilizado**: Query directa a BD (m√°s eficiente que agrupaci√≥n en memoria)
- **Iniciando Spike Criterio 11 - An√°lisis de flujo**:
  - Identificado flujo completo de c√°lculo de valores asegurados:
    1. `GetInfoCoverageService` ‚Üí ejecuta query `SELECT_INFO_FOR_CALCULATE_COVERAGES_VALUE` a PolicyCenter
    2. `CoverageRulesEngine.extractInfoCoverageDTOByCoverage()` ‚Üí busca cobertura en resultados
    3. `CalculateCoverageValueUtil.calculateCoverageValue()` ‚Üí calcula valor seg√∫n tipo de t√©rmino
  - Confirmado mapeo correcto en `CoverageHeaderMappingProvider`:
    - `DISABILITY_BY_ACCIDENT_WITH_FIREARM_INSURED_VALUE` ‚Üí `DISABILITY_IN_GUN_ACCIDENT` ‚Üí `"LifeInvalidzAdicionalCov"`
  - Regla registrada en `CoverageRulesRegistryProvider.buildDisabilityInGunAccidentRule()`:
    - Busca valores en columnas: `PERCENTAGETERM1`, `DIRECTTERM4`, `DIRECTTERM5`, `DIRECTTERM1`
    - Prioridad: Porcentaje ‚Üí Dinero ‚Üí Cantidad
  - **Pr√≥ximo paso**: Validar query SQL y verificar si la cobertura se est√° obteniendo correctamente de PolicyCenter
- **An√°lisis detallado del Spike Criterio 11**:
  - **Query SQL analizada**: `SELECT_INFO_FOR_CALCULATE_COVERAGES_VALUE`
    - JOIN entre PolicyCenter y BillingCenter
    - Tablas: PC_JOB, PC_POLICYPERIOD, PC_POLICYLINE, PCX_LIFECOV (coberturas)
    - Filtros: jobNumber y masterPolicyNumber
  - **Hip√≥tesis identificadas**:
    1. Valores NULL en campos PERCENTAGETERM1/DIRECTTERM1-7 para esta cobertura espec√≠fica
    2. Query no trae la cobertura por problema en JOINs
    3. PATTERNCODE tiene valor diferente a "LifeInvalidzAdicionalCov" en BD
  - **Hallazgos del an√°lisis de c√≥digo**:
    - Regla est√° correctamente registrada
    - Mapeo est√° correcto
    - Flujo de c√°lculo funciona para otras coberturas
  - **Conclusi√≥n preliminar**: Problema probablemente est√° en los DATOS de PolicyCenter, no en el c√≥digo
  - **Acci√≥n requerida**: Necesita validaci√≥n con datos reales de una factura que contenga la cobertura
- **‚úÖ Tests Unitarios Criterio 4 COMPLETADOS**:
  - Creado `GetTotalAffiliatePremiumServiceTest.java` con 13 casos de prueba:
    1. `testProcess_WithValidFamilyGroup_ReturnsCorrectSum` - Grupo familiar de 3 asegurados (suma 450)
    2. `testProcess_WithSingleAffiliate_ReturnsSingleValue` - Afiliado √∫nico
    3. `testProcess_WithLargeFamilyGroup_ReturnsCorrectSum` - Grupo grande (10+ asegurados)
    4. `testProcess_WithNullTaxId_ReturnsZero` - Validaci√≥n par√°metro taxId null
    5. `testProcess_WithEmptyTaxId_ReturnsZero` - Validaci√≥n par√°metro taxId vac√≠o
    6. `testProcess_WithNullInvoiceNumber_ReturnsZero` - Validaci√≥n par√°metro invoice null
    7. `testProcess_WithEmptyInvoiceNumber_ReturnsZero` - Validaci√≥n par√°metro invoice vac√≠o
    8. `testProcess_WithBothParametersNull_ReturnsZero` - Ambos par√°metros null
    9. `testProcess_WithZeroSum_ReturnsZeroFormatted` - Query retorna BigDecimal.ZERO
    10. `testProcess_WithNullResult_HandlesGracefully` - Query retorna null
    11. `testProcess_WithSQLException_PropagatesException` - Propagaci√≥n de SQLException
    12. `testProcess_WithDecimalValues_FormatsCorrectly` - Formato sin decimales (setScale 0)
    13. `testProcess_WithLargeValues_HandlesCorrectly` - Valores grandes (millones)
  - Todos los tests usan **Mockito** para mock de `DetailChargeItemQuery`
  - Cobertura de casos: happy path, edge cases, validaciones de null/vac√≠o, excepciones
  - ‚úÖ **TODOS LOS TESTS PASAN** (11/11) con Java 17

---
