# Historia #825041: Habilitar creación de beneficiarios "Dummy" por carga masiva en Vida Grupo

**Estado:** Borrador (PO)

---

## Historia de Usuario

**Como** expedidor,  
**Quiero** crear beneficiarios tipo "Dummy" (Persona) mediante carga masiva dejando los campos de identificación vacíos,  
**Para** agilizar la emisión sin detenerse por documentos faltantes, permitiendo además reemplazar cualquier lista de beneficiarios previa por la nueva información cargada.

## Descripción

Permitir la creación de beneficiarios sin número de identificación (Dummy) de forma masiva para evitar bloqueos en la suscripción dentro del proceso de carga masiva de riesgos y beneficiarios en pólizas de Vida Grupo. El sistema determinará automáticamente si debe crear un beneficiario "Dummy" o un "Contacto Completo" basándose en si los campos de identificación (Tipo y Número de Documento) vienen vacíos o diligenciados en el archivo de carga. Adicionalmente, esta carga funciona como una actualización completa de la designación de beneficiarios, asegurando que la información en el sistema refleje exactamente lo último cargado por el usuario (sobrescritura total, no fusión).

---

## Criterios de Aceptación

### Escenario 1: Crear Beneficiario Dummy (Campos Vacíos)

- **Dado** que el expedidor está diligenciando la plantilla de carga masiva para un riesgo
- **Cuando** ingrese el Nombre del beneficiario pero deje **VACÍOS** tanto el campo "Tipo de Documento" como el "Número de Documento"
- **Entonces** el sistema debe crear el beneficiario exitosamente como un contacto tipo **Persona** con identificación Dummy interna

### Escenario 2: Validación de Integridad (Campos Parciales - Tipo Vacío)

- **Dado** que se procesa el archivo de carga
- **Cuando** el sistema detecta un registro donde existe un "Número de Documento" pero el "Tipo de Documento" está vacío
- **Entonces** debe rechazar ese registro específico y generar una entrada en el archivo de errores con el mensaje "Error: El tipo de documento es obligatorio si se ingresa un número"

### Escenario 3: Validación de Integridad (Campos Parciales - Número Vacío)

- **Dado** que se procesa el archivo de carga
- **Cuando** el sistema detecta un registro donde existe un "Tipo de Documento" seleccionado pero el "Número de Documento" está vacío
- **Entonces** debe rechazar ese registro específico y generar una entrada en el archivo de errores con el mensaje "Error: El número de documento es obligatorio si se selecciona un tipo"

### Escenario 4: Reemplazo Total de Beneficiarios Existentes

- **Dado** que existe un riesgo en el sistema que ya tiene beneficiarios asignados (ej. Beneficiario A y B)
- **Cuando** se procesa exitosamente una carga masiva para ese mismo riesgo con una nueva lista de beneficiarios (ej. Beneficiario C)
- **Entonces** el sistema debe eliminar la asignación de los beneficiarios antiguos (A y B) y dejar únicamente al nuevo beneficiario (C) asociado al riesgo

### Escenario 5: Visualización en la Interfaz

- **Dado** que se creó un beneficiario Dummy mediante la lógica de campos vacíos
- **Cuando** se consulte el riesgo en la interfaz de usuario (PCF)
- **Entonces** se debe visualizar el beneficiario creado, mostrando el tipo de documento "Dummy Persona" (o la etiqueta equivalente en UI) asignado automáticamente por el sistema

### Escenario 6: Crear Contacto Completo (Comportamiento Estándar)

- **Dado** que el expedidor está diligenciando la plantilla de carga masiva
- **Cuando** ingrese el Tipo de Documento seleccionado (CC, CE, etc.) Y el Número de Documento con datos
- **Entonces** el sistema debe crear un Contacto Completo como funciona actualmente (comportamiento estándar sin cambios)

### Escenario 7: Mantenimiento de Validaciones Existentes - Riesgos Inexistentes

- **Dado** que se procesa un archivo de carga masiva con beneficiarios
- **Cuando** el sistema detecta en Fase 2 que un riesgo (asegurado) asociado no existe en la Póliza Maestra
- **Entonces** debe rechazar el registro completo y marcarlo como error en el archivo de errores de Fase 2 (comportamiento actual que debe mantenerse)

---

## Información Recopilada

### Usuario y Contexto

- **Tipo de usuario:** Expedidor de pólizas de Vida Grupo
- **Permisos requeridos:** Acceso a "Procesos Masivos" en póliza master desde PolicyCenter
- **Valor de negocio:** Agilizar la emisión de pólizas sin detenerse por falta de documentos de identificación de beneficiarios, mejorando la experiencia del usuario y reduciendo tiempos de emisión

### Reglas de Negocio

**Tabla de Decisión - Creación de Beneficiarios:**

| Campo: Tipo Documento | Campo: Número Documento | Acción del Sistema |
|----------------------|-------------------------|-------------------|
| VACÍO | VACÍO | Crear Beneficiario Dummy (Persona) - El sistema asume internamente el tipo dummy de persona |
| Seleccionado (CC, CE, etc.) | Con Datos | Crear Contacto Completo (Comportamiento estándar actual) |
| Seleccionado (CC, CE, etc.) | VACÍO | Error: "El número de documento es obligatorio si se selecciona un tipo" |
| VACÍO | Con Datos | Error: "El tipo de documento es obligatorio si se ingresa un número" |

**Lógica de Reemplazo de Beneficiarios (Sobrescritura):**
- Si el riesgo (asegurado) al que se le está cargando información **YA tiene beneficiarios asociados** en el sistema, la carga masiva **eliminará/desvinculará** los beneficiarios existentes y registrará **exclusivamente** los nuevos beneficiarios incluidos en el archivo
- **Nota importante:** No es una fusión (merge), es un reemplazo total de la lista para ese riesgo

**Productos Afectados:**
- Vida Integral
- Vida Docentes
- Vida Deudores
- Vida Condiciones Uso

**Pre-requisitos:**
- Los riesgos (asegurados) deben existir en la Póliza Maestra
- Transacción: Movimientos de modificación

**Especificaciones Técnicas:**
- **Plantilla:** No se agregan nuevos tipos de documento a la lista desplegable. Se utiliza la plantilla estándar existente
- **Tipo de Contacto:** Los beneficiarios creados por la lógica "Vacío/Vacío" siempre serán de tipo **Persona**, nunca Compañía
- **Validaciones Azure (Fase 1):** Ajustar para permitir valores nulos en las columnas de Tipo y Número de documento (actualmente son obligatorios, deben pasar a opcionales)

### Interfaz

**Ubicación:** 
- Acceder a póliza master en PolicyCenter → Sección "Procesos Masivos"
- Dashboard de histórico de cargas masivas (LifeCreateMassivelyInsuredsPopup.pcf)
- Botón "Cargar" para seleccionar archivo CSV/Excel

**Flujo de navegación:**
1. Usuario accede a póliza master
2. Navega a sección "Procesos Masivos"
3. Click en "Cargar"
4. Selecciona archivo CSV/Excel con datos de beneficiarios
5. Sistema procesa archivo en dos fases (Fase 1: Azure validación estructura, Fase 2: PolicyCenter validación negocio)
6. Usuario consulta resultados en dashboard con estados en tiempo real

**Elementos de interfaz:**
- Dashboard de histórico con tabla de cargas (MD5, fecha, estado, registros exitosos/fallidos)
- Botón "Cargar" para iniciar nueva carga
- Botón "Refrescar Dashboard" para actualizar estados
- Botón "Descargar Errores Fase X" para obtener archivo de errores

### Sistemas Externos

**Azure Data Factory (Fase 1 - Validación de Estructura):**
- **Ajuste requerido:** Modificar validaciones de expresiones regulares para permitir nulos en columnas de Tipo y Número de documento
- **Archivo de configuración:** controlSchema que define las reglas de validación de estructura
- **Output:** Registros válidos pasan a Fase 2, registros con errores generan archivo ErrorFase1_{md5}.csv

**Azure Functions:**
- Upload: Recepción de bloques de archivo (64KB por bloque)
- Status: Consulta y actualización de estados en Cosmos DB
- Download: Generación y descarga de archivos de errores

**Cosmos DB:**
- Almacenamiento de registros de carga con estados
- Contenedor MASSIVE_UPLOAD para metadatos de carga
- Contenedor UPLOAD_DETAIL para registros individuales

**RabbitMQ:**
- Mensajería asíncrona entre Azure y PolicyCenter
- Notificaciones de cambio de estado (NotifyPhaseStarted, NotifyPhaseError, RecordReadyForProcessing)

**WorkQueues en PolicyCenter (Fase 2 - Validación de Negocio):**
- **Workqueue Enrichment:** Validación de campos de negocio y transformación de datos
- **Workqueue BulkInsert:** Inserción masiva de registros en PolicyCenter según volumen (Low/Medium/High)
- **Ajuste requerido:** Lógica de validación debe permitir crear beneficiarios Dummy cuando ambos campos de identificación estén vacíos

---

## Contexto y Referencias

**Arquitectura:** docs/architecture/flujo-carga-masiva-riesgos-beneficiarios.md (855 líneas documentadas)

**Historias relacionadas:** Ninguna (esta es una funcionalidad nueva independiente)

**Lecciones aprendidas:**
- El proceso de carga masiva es completamente asíncrono (no bloqueante) para permitir al usuario continuar trabajando
- Las validaciones se dividen en dos fases independientes: Fase 1 (estructura en Azure) y Fase 2 (negocio en PolicyCenter)
- Los archivos de errores son específicos por fase para facilitar la corrección del usuario
- El dashboard debe refrescarse manualmente para ver estados actualizados (no hay auto-refresh)
- Las validaciones de integridad de datos son críticas para evitar inconsistencias en base de datos

---

## Definición de Terminado (Inicial)

- [ ] Beneficiarios Dummy se crean correctamente cuando ambos campos de identificación están vacíos
- [ ] Validaciones de campos parciales funcionan correctamente generando errores apropiados
- [ ] Lógica de reemplazo total de beneficiarios funciona correctamente (sobrescritura, no fusión)
- [ ] Beneficiarios Dummy se visualizan correctamente en la interfaz PCF
- [ ] Contactos completos continúan creándose correctamente (sin regresión)
- [ ] Validaciones existentes de riesgos inexistentes continúan funcionando
- [ ] Azure Data Factory permite nulos en columnas de identificación
- [ ] Tests unitarios y de integración implementados
- [ ] Documentación técnica actualizada

---

## Registro de Cambios

| Fecha | Versión | Descripción | Autor |
|-------|---------|-------------|-------|
| 2025-11-25 | 1.0 | Historia creada por PO (importada y validada) | esteban.colorado (PO) |

---

## Metadata

**Autor:** esteban.colorado (PO)  
**Fecha:** 2025-11-25  
**Historias relacionadas:** Ninguna  
**Origen:** Historia importada desde sistema externo y validada con Método Ceiba

---

## Métricas de redacción de la historia de usuario con el PO 

**Tiempo con Método Ceiba:** 15 minutos  
**Tiempo estimado tradicional:** 38 minutos  
**Optimización:** 61%

---
