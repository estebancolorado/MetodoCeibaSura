# Historia #915240: BUG - Organizar los Campos Errados del Detalle de Cobro

**Estado:** Refinado (SM) - Lista para Estimaci√≥n  
**Fecha Creaci√≥n:** Octubre 29, 2025  
**Fecha Refinamiento:** Octubre 29, 2025  
**Origen:** Historia importada y validada  
**Tipo:** Bug Fix  
**Prioridad:** Alta  

---

## Historia de Usuario

**YO COMO:** Expedidor  
**QUIERO:** Que se organicen los campos errados del detalle de cobro  
**PARA:** Poder descargarlo y tener la informaci√≥n que necesita el cliente  

---

## Objetivo de Negocio

A hoy cuando descargamos el detalle de cobro en producci√≥n se identificaron 9 ajustes cr√≠ticos que deben realizarse para poder contar con el informe completamente funcional y entregar informaci√≥n precisa a los clientes corporativos.

Estos ajustes impactan la generaci√≥n del reporte en el flujo de **MicroIntegradorReportesVidaGrupo**, espec√≠ficamente en:
- **WorkQueue 2**: L√≥gica de construcci√≥n de registros (c√≥digo Java)
- **Consultas SQL**: Queries a BillingCenter y PolicyCenter

---

## Contexto T√©cnico

**Componente afectado:** MicroIntegradorReportesVidaGrupo  
**Flujo:** Generaci√≥n de Reporte de Detalle de Cobro  
**Documentaci√≥n:** `docs/architecture/flujo-generacion-reporte-detalle-cobro.md`  

**Puntos de cambio:**
- WorkQueue 2 Processors (construcci√≥n de registros con ~50 campos)
- Consultas SQL a esquemas BC (BillingCenter) y PC (PolicyCenter)
- Tabla de persistencia: `CHARGE_DETAIL_ITEMS` (esquema ADM_VIDAGRUPOREPORTES)
- Formato de salida: Archivo CSV enviado a Azure Massive Download API

---

## Criterios de Aceptaci√≥n

### ‚úÖ Criterio 1: Visualizar el campo "N√∫mero P√≥liza Colectiva" correctamente

**ESTADO:** ‚úÖ Ya resuelto (n√∫mero incorrecto corregido)

**DADO** que se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**CUANDO** se ingrese a billing y se descargue el detalle de cobro  
**ENTONCES** en el campo "N√∫mero P√≥liza Colectiva" se visualice el n√∫mero de la p√≥liza master  

---

### Criterio 2: Visualizar el campo "Identificaci√≥n del Afiliado" correctamente

**DADO** que se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**CUANDO** se ingrese a billing y se descargue el detalle de cobro  
**ENTONCES** en el campo "Identificaci√≥n del Afiliado" se visualice concatenado el tipo y n√∫mero de documento del asegurado que tenga parentesco afiliado  

**Reglas de Negocio:**
- **Formato de concatenaci√≥n:** `{tipo_doc}{numero_doc}` (sin separador)
  - Ejemplo: `CC12345678` (tipo: CC, n√∫mero: 12345678)
  - Ejemplo: `TI98765432` (tipo: TI, n√∫mero: 98765432)
- **Unicidad:** Solo puede haber un afiliado por asegurado en la p√≥liza
- **Fuente de datos:** Asegurado con parentesco tipo "Afiliado" en PolicyCenter

**Ejemplos:**
- Si tipo_doc = "CC" y numero_doc = "1234567890" ‚Üí Mostrar: `CC1234567890`
- Si tipo_doc = "TI" y numero_doc = "987654321" ‚Üí Mostrar: `TI987654321`

---

### Criterio 3: Visualizar el campo "Valor Total Prima x Asegurado" correctamente

**DADO** que se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**CUANDO** se ingrese a billing y se descargue el detalle de cobro  
**ENTONCES** en el campo "Valor Total Prima x Asegurado" se visualice el valor que suma los campos "Valor Prima x Asegurado" + "Valor Impuesto"  

**Reglas de Negocio:**
- **F√≥rmula:** `Valor Total Prima x Asegurado = Valor Prima x Asegurado + Valor Impuesto`
- **Formato num√©rico:** Mantener 2 decimales
- **Validaci√≥n:** El resultado debe ser >= 0

**Ejemplo:**
- Valor Prima x Asegurado: $50,000.00
- Valor Impuesto: $9,500.00
- **Valor Total Prima x Asegurado: $59,500.00**

---

### Criterio 4: Visualizar el campo "Valor Total Afiliado" correctamente

**DADO** que se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**CUANDO** se ingrese a billing y se descargue el detalle de cobro  
**ENTONCES** en el campo "Valor Total Afiliado" se visualice en la celda que corresponde al afiliado el valor que suma los campos "Valor Total Prima x Asegurado" de los asegurados tipo grupo familiar de este mismo  

**Reglas de Negocio:**
- **Aplicable solo para:** Registros de asegurados con parentesco "Afiliado"
- **F√≥rmula:** Sumar todos los "Valor Total Prima x Asegurado" del grupo familiar (afiliado + dependientes)
- **Para dependientes:** Este campo debe estar vac√≠o o en 0
- **Formato num√©rico:** Mantener 2 decimales

**Ejemplo:**
- Afiliado (CC12345678): Valor Total Prima = $100,000
- C√≥nyuge: Valor Total Prima = $80,000
- Hijo 1: Valor Total Prima = $50,000
- Hijo 2: Valor Total Prima = $50,000
- **Valor Total Afiliado (mostrado en fila del afiliado): $280,000.00**

---

### ‚úÖ Criterio 5: Visualizar el campo "Parentesco" correctamente

**ESTADO:** ‚úÖ Ya resuelto

**DADO** que se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**CUANDO** se ingrese a billing y se descargue el detalle de cobro  
**ENTONCES** en el campo "Parentesco" se visualice la sigla del parentesco de cada asegurado y no el c√≥digo  

---

### ‚úÖ Criterio 6: Visualizar el campo "Tipo de Operaci√≥n" correctamente

**ESTADO:** ‚úÖ Ya resuelto

**DADO** que se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**CUANDO** se ingrese a billing y se descargue el detalle de cobro  
**ENTONCES** en el campo "Tipo de Operaci√≥n" se visualice el tipo de operaci√≥n que se visualiza en transacciones de p√≥liza en PC (cotizaci√≥n, cambio de p√≥liza, etc)  

---

### ‚úÖ Criterio 7: Visualizar las columnas de valor asegurado de todas las coberturas contratadas

**ESTADO:** ‚úÖ Ya resuelto

**DADO** que se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**CUANDO** se ingrese a billing y se descargue el detalle de cobro  
**ENTONCES** se visualicen las columnas de valor asegurado por cada cobertura contratada para cada asegurado  

---

### ‚úÖ Criterio 8: Visualizar el campo "Prima Vida" correctamente

**ESTADO:** ‚úÖ Ya resuelto

**DADO** que se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**CUANDO** se ingrese a billing y se descargue el detalle de cobro  
**ENTONCES** en el campo "Prima Vida" se visualice el valor de la prima de la cobertura de vida  

---

### Criterio 9: Visualizar los nombres de los campos que tienen caracteres especiales correctamente

**DADO** que se expidi√≥ una p√≥liza de vida grupo y se gener√≥ la factura  
**CUANDO** se ingrese a billing y se descargue el detalle de cobro  
**ENTONCES** en los campos con tildes y caracteres especiales se visualicen correctamente y no con el signo de interrogaci√≥n "?"  

**Campos afectados:**
- N√∫mero P√≥liza Colectiva (antes: N?mero P?liza Colectiva)
- N√∫mero de Riesgo (antes: N?mero de riesgo)
- N√∫mero de Contrato (antes: N?mero de contrato)
- Descripci√≥n de Riesgo (antes: Descripci?n de Riesgo)
- Soluci√≥n (antes: Soluci?n)
- Identificaci√≥n del Afiliado (antes: Identificaci?n del Afiliado)
- Identificaci√≥n del Asegurado (antes: Identificaci?n del Asegurado)
- N√∫mero de Factura (antes: N?mero de factura)
- Fecha Generaci√≥n Factura (antes: Fecha generaci?n factura)
- Tipo de Operaci√≥n (antes: Tipo de operaci?n)

**Reglas de Negocio:**
- **Encoding del archivo CSV:** UTF-8 sin BOM
- **Validaci√≥n:** Todos los caracteres especiales (√°, √©, √≠, √≥, √∫, √±, √ë) deben visualizarse correctamente
- **Aplicar a:** Headers del CSV y contenido de las celdas

---

## Datos de Prueba

**Factura de prueba:** `100011784911`  
**Ambiente:** Desarrollo/QA  
**Uso:** Validar todos los criterios de aceptaci√≥n antes de desplegar a producci√≥n  

**Validaciones esperadas:**
1. ‚úÖ N√∫mero P√≥liza Colectiva muestra la p√≥liza master
2. Identificaci√≥n del Afiliado en formato `{tipo_doc}{numero_doc}`
3. Valor Total Prima x Asegurado = Prima + Impuesto
4. Valor Total Afiliado suma correctamente el grupo familiar
5. ‚úÖ Parentesco muestra siglas
6. ‚úÖ Tipo de Operaci√≥n muestra descripci√≥n
7. ‚úÖ Todas las coberturas tienen columnas de valor asegurado
8. ‚úÖ Prima Vida muestra valor correcto
9. Todos los headers y datos con tildes se ven correctamente

---

## Contexto T√©cnico (SM)

### Base del Refinamiento

**An√°lisis arquitect√≥nico utilizado:** ‚úÖ S√ç - Basado en an√°lisis previo validado del arquitecto

**Decisiones arquitect√≥nicas adoptadas:**
- Patr√≥n Hexagonal Architecture (Ports & Adapters) con Dependency Injection
- Distribuci√≥n de responsabilidades entre WorkQueue 1 (consultas SQL) y WorkQueue 2 (c√°lculos de negocio)
- Refactorizaci√≥n de inyecci√≥n de dependencias v√≠a constructor en ambos WorkQueues
- Creaci√≥n de `FamilyCalculatorService` como servicio de dominio

**Componentes validados por el arquitecto:**
- WorkQueue1Processors (consultas SQL a BC/PC)
- WorkQueue2Processors (transformaci√≥n y c√°lculos)
- FamilyCalculatorService (nuevo - c√°lculo de grupo familiar)
- CoverageProvider (sin cambios - coberturas ya incluidas)

**Patrones seguidos:**
- SQL-First Approach para concatenaci√≥n de identificaci√≥n del afiliado
- Service Layer Pattern para c√°lculo de valor total afiliado
- Repository Pattern para acceso a datos

### Validaci√≥n T√©cnica con Desarrollador

**Fecha de validaci√≥n:** Octubre 29, 2025

**Aclaraciones cr√≠ticas incorporadas:**

1. **Cobertura "Invalidez por Accidente con Armas" (Criterio pendiente - investigaci√≥n requerida):**
   - ‚úÖ Confirmado: Campo existe en CSV pero llega con valor = 0
   - ‚úÖ Problema puede estar en: query SQL O transformaci√≥n WorkQueue 2
   - ‚úÖ Factura de prueba confirmada: `100011784911` (debe tener valor > 0)
   - üîç Requiere: Query de diagn√≥stico SQL + validaci√≥n en transformaciones

2. **Valor Total Afiliado (Criterio 4 - PRIORIDAD ALTA):**
   - ‚úÖ Implementar en **WorkQueue 2** (no en WorkQueue 1)
   - ‚úÖ Usar datos base de `CHARGE_DETAIL_ITEMS`
   - ‚úÖ Requiere consulta adicional en WorkQueue 2 para obtener grupo familiar
   - ‚úÖ Sumar valores de todos los asegurados del mismo grupo familiar

3. **Encoding UTF-8 (Criterio 9):**
   - ‚úÖ **YA RESUELTO** - Caracteres especiales funcionan correctamente
   - ‚úÖ No requiere implementaci√≥n adicional

4. **Prioridad de implementaci√≥n:**
   - ü•á **CR√çTICO**: Criterio 4 - Valor Total Afiliado (suma grupo familiar)
   - ü•à **ALTO**: Cobertura "Invalidez por Accidente con Armas" (investigaci√≥n + correcci√≥n)
   - ü•â **MEDIO**: Criterio 2 - Identificaci√≥n del Afiliado (concatenaci√≥n tipo + n√∫mero)

### An√°lisis de Arquitectura y Documentaci√≥n

**Arquitectura:**

- **Componentes principales afectados:**
  - `MicroIntegradorReportesVidaGrupo` - Microservicio principal (Apache Camel 3.20)
  - `WorkQueue1Processors` - Consultas SQL a BillingCenter/PolicyCenter
  - `WorkQueue2Processors` - Transformaci√≥n y c√°lculos de negocio
  - `FamilyCalculatorService` (NUEVO) - Servicio de dominio para c√°lculo de grupo familiar

- **M√≥dulos relevantes:**
  - `application/processor/workqueue/` - Procesadores de work queues
  - `domain/service/` - Servicios de dominio (nuevo servicio aqu√≠)
  - `domain/ports/query/` - Ports para consultas adicionales
  - `infrastructure/adapter/repository/query/` - Implementaci√≥n de queries

- **Patrones arquitect√≥nicos:**
  - Hexagonal Architecture (separaci√≥n dominio/infraestructura)
  - Work Queue Pattern con Quartz Scheduler
  - Repository Pattern para acceso a datos
  - Service Layer Pattern para l√≥gica de negocio

**Componentes Espec√≠ficos seg√∫n An√°lisis Arquitect√≥nico:**

- **WorkQueue1Processors:** Modificaci√≥n Media
  - Actualizar `script_policy.sql` para incluir `tipo_documento`
  - Implementar concatenaci√≥n `tipo_documento || numero_documento` en INSERT-SELECT
  - Investigar query de cobertura "Invalidez por Accidente con Armas"
  - Aplicar refactorizaci√≥n de inyecci√≥n de dependencias v√≠a constructor

- **WorkQueue2Processors:** Modificaci√≥n Media-Alta
  - Inyectar nuevo `FamilyCalculatorService` v√≠a constructor
  - Implementar consulta adicional para obtener grupo familiar desde `CHARGE_DETAIL_ITEMS`
  - Calcular "Valor Total Afiliado" para asegurados con parentesco "Afiliado"
  - Validar que cobertura "Invalidez por Accidente con Armas" no se pierda
  - Aplicar refactorizaci√≥n de inyecci√≥n de dependencias

- **FamilyCalculatorService (NUEVO):** Servicio de dominio
  - Responsabilidad: Calcular suma de "Valor Total Prima x Asegurado" del grupo familiar
  - M√©todos: `calculateFamilyTotal()`, `groupByAffiliate()`
  - Ubicaci√≥n: `domain/service/FamilyCalculatorService.java`
  - Inyecci√≥n: Recibir repositorio v√≠a constructor para consulta de grupo familiar

- **CoverageProvider:** Sin cambios
  - Coberturas ya incluidas correctamente
  - Solo requiere validaci√≥n de que no se pierda valor en transformaciones

**Flujos de Negocio Relacionados:**

- **Flujo principal:** `flujo-generacion-reporte-detalle-cobro.md`
  - WorkQueue 1: Consulta de datos de Guidewire (BC/PC)
  - WorkQueue 2: Construcci√≥n de registros con ~50 campos
  - WorkQueue 3: Env√≠o a Azure Massive Download API
  - WorkQueue 4: Limpieza de registros antiguos

**Extensiones de flujo necesarias:**
- WorkQueue 2: Agregar paso de consulta adicional para grupo familiar antes de construcci√≥n de registros

### An√°lisis de Impacto

**C√≥digo existente a modificar:**

- `src/main/java/com/sura/mi/reportes/vidagrupo/application/processor/workqueue/WorkQueue1Processors.java`
- `src/main/java/com/sura/mi/reportes/vidagrupo/application/processor/workqueue/WorkQueue2Processors.java`
- `src/main/resources/sql/script_policy.sql` - Consultas a PolicyCenter
- `src/main/resources/sql/script_bc_pc.sql` - Consultas combinadas (si aplica)

**Archivos nuevos a crear:**

- `src/main/java/com/sura/mi/reportes/vidagrupo/domain/service/FamilyCalculatorService.java` (interface)
- `src/main/java/com/sura/mi/reportes/vidagrupo/domain/service/impl/FamilyCalculatorServiceImpl.java` (implementaci√≥n)
- `src/main/java/com/sura/mi/reportes/vidagrupo/domain/ports/query/ChargeDetailQueryPort.java` (nuevo port para consulta de grupo familiar)
- `src/main/java/com/sura/mi/reportes/vidagrupo/infrastructure/adapter/repository/query/ChargeDetailQueryRepository.java` (implementaci√≥n del port)

**Breaking changes:** Ninguno - Solo correcciones de datos y nuevos c√°lculos

**Migraciones:** No requiere cambios de esquema en BD

**Configuraci√≥n:** No requiere nuevas variables de entorno

### An√°lisis de C√≥digo Base

**Consultas SQL Existentes (script_policy.sql):**

Basado en la documentaci√≥n del flujo, las consultas actuales obtienen:
- Datos de asegurados desde `pc_grouppersonnel`
- Coberturas desde `pc_coverage` y `pc_grouppersonnel_coverage`
- Valores asegurados y primas por cobertura

**Modificaciones SQL requeridas:**

```sql
-- CAMBIO 1: Agregar tipo_documento para concatenaci√≥n (Criterio 2)
SELECT 
    pc.document_type,              -- NUEVO CAMPO
    pc.document_number,
    pc.document_type || pc.document_number as affiliate_document, -- Concatenaci√≥n
    pc.relationship,
    pc.affiliate_id,
    -- ... resto de campos existentes
FROM pc_grouppersonnel pc
WHERE pc.invoice_number = :invoiceNumber
```

**Investigaci√≥n SQL requerida (Cobertura "Invalidez por Accidente con Armas"):**

```sql
-- Query de diagn√≥stico para identificar nombre exacto de cobertura
SELECT DISTINCT 
    cov.coverage_code,
    cov.coverage_name,
    cov.coverage_type,
    cov.insured_value
FROM pc_coverage cov
WHERE UPPER(cov.coverage_name) LIKE '%INVALIDEZ%'
  AND UPPER(cov.coverage_name) LIKE '%ARMAS%'
  OR UPPER(cov.coverage_name) LIKE '%ACCIDENTE%ARMAS%'
ORDER BY cov.coverage_name;

-- Query de validaci√≥n con factura de prueba
SELECT 
    gp.document_number,
    gp.relationship,
    cov.coverage_code,
    cov.coverage_name,
    COALESCE(cov.insured_value, 0) as insured_value,
    COALESCE(gpc.premium, 0) as premium
FROM pc_grouppersonnel gp
LEFT JOIN pc_grouppersonnel_coverage gpc ON gp.id = gpc.insured_id
LEFT JOIN pc_coverage cov ON gpc.coverage_id = cov.id
WHERE gp.invoice_number = '100011784911'
  AND (UPPER(cov.coverage_name) LIKE '%INVALIDEZ%ARMAS%'
       OR cov.coverage_code = 'INA' -- C√≥digo hipot√©tico, validar
       OR cov.coverage_code LIKE 'INV%ACC%')
ORDER BY gp.document_number, cov.coverage_name;
```

**L√≥gica de WorkQueue2 (Construcci√≥n de Registros):**

Basado en el flujo documentado, WorkQueue2 actualmente:
1. Lee datos consolidados desde `CHARGE_DETAIL_PRINCIPAL` (columna `data_json`)
2. Parsea JSON con datos de BC/PC
3. Aplica reglas de negocio usando `CoverageProvider`
4. Construye registros de detalle con ~50 campos
5. Inserta batch en `CHARGE_DETAIL_ITEMS`

**Modificaciones requeridas en WorkQueue2:**

```java
// Pseudoc√≥digo de l√≥gica nueva
for (InsuredData insured : allInsureds) {
    // ... l√≥gica existente de construcci√≥n de registro ...
    
    // NUEVO: Calcular Valor Total Afiliado (Criterio 4)
    if ("Afiliado".equals(insured.getRelationship())) {
        // Consultar grupo familiar desde CHARGE_DETAIL_ITEMS
        List<ChargeDetailItem> familyGroup = 
            chargeDetailQueryPort.findByAffiliateId(
                invoiceNumber, 
                insured.getAffiliateId()
            );
        
        // Calcular suma usando servicio de dominio
        BigDecimal familyTotal = 
            familyCalculatorService.calculateFamilyTotal(familyGroup);
        
        detailRecord.setValorTotalAfiliado(familyTotal);
    } else {
        detailRecord.setValorTotalAfiliado(null); // Dependientes vac√≠o
    }
    
    // VALIDACI√ìN: Cobertura "Invalidez por Accidente con Armas"
    // Verificar que no se sobrescribe a cero
    for (CoverageData coverage : insured.getCoverages()) {
        if (coverage.isInvalidezPorAccidenteConArmas()) {
            logger.debug("Cobertura IPAA - Valor: {}", coverage.getInsuredValue());
            // Asegurar que se mantiene el valor del SQL
        }
    }
}
```

**Estrategias de Testing:**

Basado en el stack tecnol√≥gico documentado (JUnit 4.13.2, Mockito 4.11.0):
- Tests unitarios para `FamilyCalculatorService` con mocks de repositorio
- Tests de integraci√≥n para consultas SQL con base de datos H2/Oracle de desarrollo
- Tests de regresi√≥n con factura `100011784911` para validar todos los criterios
- Mutation testing con PIT 1.15.8 (configurado en el proyecto)

---

## Tareas de Implementaci√≥n (SM)

### Fase 1: Preparaci√≥n y An√°lisis de C√≥digo Existente

**Objetivo:** Comprender implementaci√≥n actual y validar datos con queries de diagn√≥stico

- [ ] **An√°lisis de c√≥digo existente de WorkQueues**
  - [ ] Revisar `WorkQueue1Processors.java` - identificar estructura actual y puntos de modificaci√≥n
  - [ ] Revisar `WorkQueue2Processors.java` - identificar l√≥gica de construcci√≥n de registros
  - [ ] Documentar patr√≥n actual de inyecci√≥n de dependencias (para refactorizar)
  - [ ] Identificar ubicaci√≥n de `CoverageProvider` y su uso actual

- [ ] **Ejecutar queries de diagn√≥stico SQL** (AC: Investigaci√≥n Cobertura)
  - [ ] Conectar a base de datos de desarrollo PolicyCenter
  - [ ] Ejecutar query 1: Identificar nombre exacto de cobertura "Invalidez por Accidente con Armas"
  - [ ] Ejecutar query 2: Validar datos de factura `100011784911` - verificar valor > 0 esperado
  - [ ] Ejecutar query 3: Validar que campo `tipo_documento` existe en `pc_grouppersonnel`
  - [ ] Documentar hallazgos: nombre exacto de cobertura, estructura de JOINs, valores esperados

- [ ] **An√°lisis de scripts SQL existentes**
  - [ ] Revisar `script_policy.sql` - identificar consulta de asegurados actual
  - [ ] Revisar `script_bc_pc.sql` - identificar consulta de coberturas actual
  - [ ] Identificar si query usa INNER JOIN o LEFT JOIN para coberturas
  - [ ] Validar manejo de NULLs con COALESCE en valores asegurados

### Fase 2: Implementaci√≥n de Servicio de Dominio (Valor Total Afiliado - PRIORIDAD ALTA)

**Objetivo:** Crear servicio para calcular suma de grupo familiar

- [ ] **Crear FamilyCalculatorService** (AC: 4)
  - [ ] Crear interface `domain/service/FamilyCalculatorService.java`
    - M√©todo: `BigDecimal calculateFamilyTotal(List<ChargeDetailItem> familyGroup)`
    - M√©todo: `Map<String, List<ChargeDetailItem>> groupByAffiliate(List<ChargeDetailItem> allItems)`
  - [ ] Crear implementaci√≥n `domain/service/impl/FamilyCalculatorServiceImpl.java`
    - Implementar l√≥gica de suma de "Valor Total Prima x Asegurado"
    - Validar que suma sea >= 0
    - Mantener 2 decimales en resultado
    - Logging de c√°lculos para debugging

- [ ] **Crear Port para consulta de grupo familiar** (AC: 4)
  - [ ] Crear `domain/ports/query/ChargeDetailQueryPort.java`
    - M√©todo: `List<ChargeDetailItem> findByAffiliateId(String invoiceNumber, String affiliateId)`
  - [ ] Crear implementaci√≥n `infrastructure/adapter/repository/query/ChargeDetailQueryRepository.java`
    - Implementar query SQL a `CHARGE_DETAIL_ITEMS`
    - Filtrar por `invoice_number` y `affiliate_id`
    - Ordenar por `relationship` (Afiliado primero, luego dependientes)

- [ ] **Tests unitarios de FamilyCalculatorService** (AC: 4)
  - [ ] Test: Calcular suma correcta con 1 afiliado + 3 dependientes
  - [ ] Test: Manejar grupo familiar con solo afiliado (sin dependientes)
  - [ ] Test: Validar formato de 2 decimales
  - [ ] Test: Validar que suma nunca es negativa
  - [ ] Mock de `ChargeDetailQueryPort` con Mockito

### Fase 3: Modificaci√≥n de WorkQueue 1 (Consultas SQL)

**Objetivo:** Incluir tipo de documento para concatenaci√≥n y corregir cobertura

- [ ] **Modificar script_policy.sql - Agregar tipo_documento** (AC: 2)
  - [ ] A√±adir campo `document_type` en SELECT principal
  - [ ] Implementar concatenaci√≥n: `document_type || document_number AS affiliate_document`
  - [ ] Validar que campo existe en esquema `pc_grouppersonnel`
  - [ ] Probar query en BD de desarrollo con factura `100011784911`

- [ ] **Investigar y corregir query de cobertura "Invalidez por Accidente con Armas"**
  - [ ] Usar nombre exacto identificado en Fase 1 (query de diagn√≥stico)
  - [ ] Verificar que JOIN es LEFT JOIN (no INNER) para no filtrar registros
  - [ ] A√±adir COALESCE para manejar NULLs: `COALESCE(cov.insured_value, 0)`
  - [ ] Validar con query de diagn√≥stico que retorna valor > 0 para factura de prueba
  - [ ] Documentar cambio en comentario SQL

- [ ] **Refactorizar WorkQueue1Processors - Inyecci√≥n de Dependencias** (AC: Refactorizaci√≥n)
  - [ ] Identificar dependencias instanciadas con `new ...()` 
  - [ ] Convertir a inyecci√≥n v√≠a constructor
  - [ ] Actualizar configuraci√≥n de Spring/Camel para autowiring
  - [ ] Actualizar tests unitarios con mocks de nuevas dependencias

### Fase 4: Modificaci√≥n de WorkQueue 2 (C√°lculos de Negocio - PRIORIDAD ALTA)

**Objetivo:** Implementar c√°lculo de Valor Total Afiliado y validar cobertura

- [ ] **Inyectar FamilyCalculatorService en WorkQueue2Processors** (AC: 4)
  - [ ] A√±adir `FamilyCalculatorService` como dependencia del constructor
  - [ ] A√±adir `ChargeDetailQueryPort` como dependencia del constructor
  - [ ] Actualizar configuraci√≥n de inyecci√≥n de dependencias
  - [ ] Actualizar tests con mocks de nuevos servicios

- [ ] **Implementar c√°lculo de Valor Total Afiliado** (AC: 4)
  - [ ] Identificar punto en c√≥digo donde se construye registro de detalle
  - [ ] A√±adir condicional: `if ("Afiliado".equals(insured.getRelationship()))`
  - [ ] Consultar grupo familiar: `chargeDetailQueryPort.findByAffiliateId(...)`
  - [ ] Calcular suma: `familyCalculatorService.calculateFamilyTotal(familyGroup)`
  - [ ] Asignar resultado a campo `valorTotalAfiliado` del registro
  - [ ] Para dependientes: asignar `null` o `0` en campo `valorTotalAfiliado`

- [ ] **Validar que cobertura "Invalidez por Accidente con Armas" no se pierde**
  - [ ] A√±adir logging debug antes/despu√©s de transformaciones de coberturas
  - [ ] Verificar que valor del SQL se mantiene en construcci√≥n del registro
  - [ ] Validar que no se sobrescribe a cero en l√≥gica de negocio
  - [ ] A√±adir assertion en tests para validar valor > 0 en factura de prueba

- [ ] **Refactorizar WorkQueue2Processors - Inyecci√≥n de Dependencias** (AC: Refactorizaci√≥n)
  - [ ] Convertir todas las dependencias a inyecci√≥n v√≠a constructor
  - [ ] Actualizar configuraci√≥n de Spring/Camel
  - [ ] Actualizar tests unitarios con mocks

### Fase 5: Testing Integral y Validaci√≥n

**Objetivo:** Validar todos los criterios con factura de prueba

- [ ] **Tests unitarios completos**
  - [ ] WorkQueue1Processors: Mock de queries SQL, validar datos retornados
  - [ ] WorkQueue2Processors: Mock de servicios, validar c√°lculos
  - [ ] FamilyCalculatorService: Tests de l√≥gica de suma (ya creados en Fase 2)
  - [ ] ChargeDetailQueryRepository: Tests de integraci√≥n con H2/Oracle

- [ ] **Tests de integraci√≥n con factura 100011784911** (AC: 1, 2, 3, 4, 5, 6, 7, 8, 9)
  - [ ] ‚úÖ AC1: Validar "N√∫mero P√≥liza Colectiva" (ya resuelto - regresi√≥n)
  - [ ] AC2: Validar "Identificaci√≥n del Afiliado" formato `{tipo}{numero}`
  - [ ] AC3: Validar "Valor Total Prima x Asegurado" = Prima + Impuesto
  - [ ] **AC4: Validar "Valor Total Afiliado" suma de grupo familiar** (CR√çTICO)
  - [ ] ‚úÖ AC5: Validar "Parentesco" siglas (ya resuelto - regresi√≥n)
  - [ ] ‚úÖ AC6: Validar "Tipo de Operaci√≥n" descripci√≥n (ya resuelto - regresi√≥n)
  - [ ] ‚úÖ AC7: Validar columnas de valor asegurado coberturas (ya resuelto - regresi√≥n)
  - [ ] ‚úÖ AC8: Validar "Prima Vida" valor correcto (ya resuelto - regresi√≥n)
  - [ ] ‚úÖ AC9: Validar caracteres especiales UTF-8 (ya resuelto - regresi√≥n)
  - [ ] **VALIDACI√ìN CR√çTICA:** "Invalidez por Accidente con Armas" tiene valor > 0

- [ ] **Tests de regresi√≥n** (AC: Todos)
  - [ ] Ejecutar generaci√≥n de reporte con al menos 3 facturas diferentes
  - [ ] Validar que campos existentes no se afectaron negativamente
  - [ ] Validar que otros tipos de coberturas siguen funcionando
  - [ ] Validar performance: tiempo de ejecuci√≥n similar a versi√≥n anterior

- [ ] **Mutation Testing con PIT**
  - [ ] Ejecutar PIT en clases modificadas y nuevas
  - [ ] Validar cobertura de mutantes > 80%
  - [ ] Corregir tests que no detectan mutaciones

### Fase 6: Code Review y Documentaci√≥n

**Objetivo:** Asegurar calidad y actualizar documentaci√≥n

- [ ] **Code Review**
  - [ ] Revisi√≥n de implementaci√≥n de FamilyCalculatorService
  - [ ] Revisi√≥n de modificaciones en WorkQueue1Processors
  - [ ] Revisi√≥n de modificaciones en WorkQueue2Processors
  - [ ] Revisi√≥n de queries SQL modificadas
  - [ ] Validar principios SOLID y Clean Code
  - [ ] Validar que refactorizaci√≥n de DI est√° correcta

- [ ] **Actualizar documentaci√≥n arquitect√≥nica** (Recomendaci√≥n para Arquitecto)
  - [ ] Sugerir actualizar `flujo-generacion-reporte-detalle-cobro.md` con:
    - WorkQueue 2: Agregar paso de consulta de grupo familiar
    - Diagrama de secuencia: Incluir llamada a FamilyCalculatorService
  - [ ] Sugerir actualizar `architecture-microintegrador-reportes-vidagrupo.md` con:
    - Nuevo servicio de dominio: FamilyCalculatorService
    - Refactorizaci√≥n de inyecci√≥n de dependencias aplicada
    - Lecciones aprendidas de esta correcci√≥n

- [ ] **Documentaci√≥n t√©cnica interna**
  - [ ] Actualizar comentarios Javadoc en clases modificadas
  - [ ] Documentar queries SQL con comentarios explicativos
  - [ ] Actualizar README.md del microservicio si es necesario

### Fase 7: Despliegue y Monitoreo

**Objetivo:** Desplegar a ambientes y validar en producci√≥n

- [ ] **Despliegue a ambiente de Desarrollo**
  - [ ] Build exitoso con Gradle
  - [ ] Validaci√≥n de imagen Docker
  - [ ] Despliegue en ambiente de desarrollo
  - [ ] Smoke tests: generaci√≥n de reporte con factura 100011784911

- [ ] **Validaci√≥n en QA**
  - [ ] Despliegue a ambiente QA
  - [ ] Ejecuci√≥n de suite completa de tests de aceptaci√≥n
  - [ ] Validaci√≥n funcional con usuario de negocio / QA
  - [ ] Aprobaci√≥n de QA para producci√≥n

- [ ] **Despliegue a Producci√≥n**
  - [ ] Plan de rollback documentado
  - [ ] Despliegue en ventana de mantenimiento
  - [ ] Monitoreo de logs en Splunk post-despliegue
  - [ ] Validaci√≥n con facturas reales en producci√≥n
  - [ ] Confirmaci√≥n de usuario de negocio

- [ ] **Monitoreo Post-Despliegue**
  - [ ] Monitorear logs de errores (primeras 24 horas)
  - [ ] Validar performance de WorkQueues
  - [ ] Revisar m√©tricas de tiempo de generaci√≥n de reportes
  - [ ] Confirmar que no hay regresiones en otros campos

---

**Notas sobre vinculaci√≥n con Criterios de Aceptaci√≥n:**

- **AC: 4** - Todas las tareas de FamilyCalculatorService y c√°lculo de Valor Total Afiliado
- **AC: 2** - Modificaci√≥n de SQL para tipo_documento y concatenaci√≥n
- **AC: 3** - Ya implementado, solo validaci√≥n en tests
- **AC: Investigaci√≥n Cobertura** - Queries de diagn√≥stico y correcci√≥n de cobertura "Invalidez por Accidente con Armas"
- **AC: 1, 5, 6, 7, 8, 9** - Ya resueltos, solo tests de regresi√≥n

---



- [ ] Los 9 criterios de aceptaci√≥n est√°n implementados y probados
- [ ] Se validaron cambios en WorkQueue 2 (l√≥gica Java de construcci√≥n)
- [ ] Se validaron cambios en consultas SQL a BC y PC
- [ ] Archivo CSV se genera con encoding UTF-8 sin BOM
- [ ] Pruebas exitosas con factura 100011784911 en ambiente de desarrollo
- [ ] Pruebas de regresi√≥n: otras facturas siguen funcionando correctamente
- [ ] Code review completado y aprobado
- [ ] Documentaci√≥n t√©cnica actualizada si hubo cambios significativos
- [ ] Despliegue a QA y validaci√≥n funcional con usuario de negocio
- [ ] Despliegue a producci√≥n y monitoreo post-despliegue

---

## Definici√≥n de Hecho (DoD)

**‚úÖ Criterios implementados y validados:**

- [ ] **Criterio 4 (PRIORIDAD CR√çTICA):** Valor Total Afiliado calculado correctamente sumando grupo familiar
- [ ] **Criterio 2 (PRIORIDAD ALTA):** Identificaci√≥n del Afiliado en formato `{tipo_doc}{numero_doc}`
- [ ] **Cobertura "Invalidez por Accidente con Armas" (PRIORIDAD ALTA):** Valor > 0 en factura de prueba
- [ ] **Criterio 3:** Valor Total Prima x Asegurado = Prima + Impuesto (validaci√≥n de regresi√≥n)
- [ ] ‚úÖ Criterio 1: N√∫mero P√≥liza Colectiva (ya resuelto - test de regresi√≥n)
- [ ] ‚úÖ Criterio 5: Parentesco en siglas (ya resuelto - test de regresi√≥n)
- [ ] ‚úÖ Criterio 6: Tipo de Operaci√≥n (ya resuelto - test de regresi√≥n)
- [ ] ‚úÖ Criterio 7: Columnas de valor asegurado coberturas (ya resuelto - test de regresi√≥n)
- [ ] ‚úÖ Criterio 8: Prima Vida (ya resuelto - test de regresi√≥n)
- [ ] ‚úÖ Criterio 9: Caracteres especiales UTF-8 (ya resuelto - NO requiere implementaci√≥n)

**‚úÖ Componentes nuevos creados:**

- [ ] FamilyCalculatorService (interface + implementaci√≥n)
- [ ] ChargeDetailQueryPort (interface)
- [ ] ChargeDetailQueryRepository (implementaci√≥n)

**‚úÖ Componentes modificados:**

- [ ] WorkQueue1Processors - Refactorizaci√≥n DI + SQL modificado
- [ ] WorkQueue2Processors - Refactorizaci√≥n DI + c√°lculo de Valor Total Afiliado
- [ ] script_policy.sql - Agregar tipo_documento + correcci√≥n cobertura
- [ ] script_bc_pc.sql (si aplica) - Consultas combinadas

**‚úÖ Validaciones t√©cnicas:**

- [ ] Queries de diagn√≥stico SQL ejecutadas exitosamente
- [ ] Nombre exacto de cobertura "Invalidez por Accidente con Armas" identificado
- [ ] Factura 100011784911 validada con todos los criterios
- [ ] Tests unitarios: cobertura > 80%
- [ ] Mutation testing (PIT): cobertura de mutantes > 80%
- [ ] Tests de regresi√≥n: otras facturas funcionan correctamente
- [ ] Code review completado y aprobado

**‚úÖ Documentaci√≥n:**

- [ ] Comentarios Javadoc actualizados en clases modificadas
- [ ] Queries SQL documentadas con comentarios explicativos
- [ ] Sugerencias de actualizaci√≥n para arquitecto:
  - Actualizar `flujo-generacion-reporte-detalle-cobro.md`
  - Actualizar `architecture-microintegrador-reportes-vidagrupo.md`
  - Documentar lecciones aprendidas

**‚úÖ Despliegue:**

- [ ] Despliegue a ambiente de desarrollo exitoso
- [ ] Validaci√≥n en QA con usuario de negocio
- [ ] Despliegue a producci√≥n completado
- [ ] Monitoreo post-despliegue (primeras 24 horas)

---

## Impacto en el Sistema

**Componentes afectados:**
- ‚úÖ MicroIntegradorReportesVidaGrupo (WorkQueue 2)
- ‚úÖ Consultas SQL a BillingCenter y PolicyCenter
- ‚úÖ Tabla CHARGE_DETAIL_ITEMS
- ‚úÖ Generaci√≥n de archivo CSV

**Riesgos:**
- **Bajo:** Los cambios son principalmente correcciones de datos y formato
- **Mitigaci√≥n:** Validar con factura de prueba antes de producci√≥n
- **Rollback:** Posible mediante revert de c√≥digo si se detectan problemas

**Dependencias:**
- No requiere cambios en Azure Massive Download API
- No requiere cambios en RabbitMQ
- No requiere cambios en estructura de BD (solo l√≥gica)

---

## Informaci√≥n de Importaci√≥n

**Proceso completado:** ‚úÖ Validaci√≥n de completitud  
**An√°lisis realizado:** ‚úÖ Consistencia con documentaci√≥n arquitect√≥nica  
**Preguntas de aclaraci√≥n:** ‚úÖ 9 preguntas respondidas e integradas  
**Versi√≥n final confirmada:** ‚úÖ Usuario confirm√≥  

**Archivo creado:** `915240.BUG-organizar-campos-errados-detalle-cobro.story.md`

**Documentaci√≥n relacionada:**
- Flujo t√©cnico: `docs/architecture/flujo-generacion-reporte-detalle-cobro.md`
- Arquitectura: `docs/architecture/architecture-microintegrador-reportes-vidagrupo.md`

**Mejoras aplicadas:**
- ‚úÖ Reglas de negocio espec√≠ficas para cada criterio
- ‚úÖ Ejemplos concretos de formato y c√°lculos
- ‚úÖ Datos de prueba documentados
- ‚úÖ Contexto t√©cnico completo
- ‚úÖ Definici√≥n de hecho detallada

---

## An√°lisis Arquitect√≥nico (Arquitecto)

### Decisiones de Dise√±o

**Patr√≥n Arquitect√≥nico:** Hexagonal Architecture (Ports & Adapters) con Dependency Injection

**Estrategia de Implementaci√≥n:**

La correcci√≥n de los 3 campos pendientes se implementar√° aprovechando la oportunidad para refactorizar el uso incorrecto de inyecci√≥n de dependencias detectado en el proyecto:

**Distribuci√≥n de Responsabilidades por WorkQueue:**

- **WorkQueue 1 (Consulta de Datos)**: Responsable de obtenci√≥n de datos v√≠a SQL
  - Modificar consultas SQL a PolicyCenter para incluir `tipo_documento`
  - Concatenar tipo + n√∫mero de documento para campo "Identificaci√≥n del Afiliado"
  - Investigar y corregir query de cobertura "Invalidez por Accidente con Armas" (valor en cero)
  
- **WorkQueue 2 (Construcci√≥n de Registros)**: Responsable de transformaci√≥n y c√°lculos de negocio
  - Implementar c√°lculo de "Valor Total Afiliado" (suma del grupo familiar)
  - Validar que valor de cobertura "Invalidez por Accidente con Armas" no se pierda en transformaciones

**Componentes Principales:**

- **WorkQueue1Processors:** Modificaci√≥n Media
  - Actualizar consultas SQL para incluir tipo de documento del afiliado
  - Implementar concatenaci√≥n `tipo_documento || numero_documento` en INSERT-SELECT
  - Investigar query de cobertura "Invalidez por Accidente con Armas" (campo existe pero valor = 0)
  - **Refactorizaci√≥n:** Aplicar inyecci√≥n de dependencias correcta v√≠a constructor

- **WorkQueue2Processors:** Modificaci√≥n Media
  - Implementar c√°lculo de "Valor Total Afiliado" (suma de grupo familiar)
  - Validar que cobertura "Invalidez por Accidente con Armas" mantenga su valor
  - **Refactorizaci√≥n:** Aplicar inyecci√≥n de dependencias correcta v√≠a constructor

- **FamilyCalculatorService (Nuevo):** Servicio de dominio
  - Responsabilidad: Calcular suma de "Valor Total Prima x Asegurado" del grupo familiar
  - M√©todos: `calculateFamilyTotal()`, `groupByAffiliate()`
  - Ubicaci√≥n: `domain/service/FamilyCalculatorService.java`

### Especificaciones T√©cnicas

**Interfaces Requeridas:**

```java
// FamilyCalculatorService.java (NUEVO)
public interface FamilyCalculatorService {
    BigDecimal calculateFamilyTotal(List<InsuredData> familyGroup);
    Map<String, List<InsuredData>> groupByAffiliate(List<InsuredData> allInsureds);
}
```

**Consultas SQL Modificadas (script_policy.sql):**

```sql
-- CAMBIO 1: Agregar tipo_documento para concatenaci√≥n
SELECT 
    pc.document_type,        -- NUEVO
    pc.document_number,
    pc.document_type || pc.document_number as affiliate_document, -- Concatenaci√≥n
    pc.relationship,
    pc.affiliate_id,
    ...
FROM pc_grouppersonnel pc
WHERE ...
```

**Puntos de Investigaci√≥n Cr√≠ticos:**

1. **Cobertura "Invalidez por Accidente con Armas":**
   - El campo YA EXISTE en el CSV pero llega en valor = 0
   - Investigar query SQL: nombre exacto de cobertura, JOINs, manejo de NULLs
   - Validar que no se sobrescribe a cero en l√≥gica de WorkQueue1 o WorkQueue2

**Modelos de Datos:**

```java
public class InsuredData {
    private String documentType;      // NUEVO: Agregado desde SQL
    private String affiliateDocument; // NUEVO: Concatenaci√≥n tipo+n√∫mero
    private String affiliateId;       // Para agrupar familia
    private BigDecimal familyTotal;   // NUEVO: Valor Total Afiliado
    private List<CoverageData> coverages; // Incluye "Invalidez por Accidente con Armas"
    // ... otros campos existentes
}
```

**L√≥gica de C√°lculo - Valor Total Afiliado:**

```java
// WorkQueue2Processors (pseudoc√≥digo)
if (insured.getRelationship().equals("Afiliado")) {
    List<InsuredData> familyGroup = getFamilyGroup(insured.getAffiliateId());
    BigDecimal familyTotal = familyCalculatorService.calculateFamilyTotal(familyGroup);
    detailRecord.setValorTotalAfiliado(familyTotal);
} else {
    detailRecord.setValorTotalAfiliado(null); // Dependientes vac√≠o
}
```

### Impacto Arquitect√≥nico

**Componentes Modificados:**

- ‚úÖ **WorkQueue1Processors** - Modificaci√≥n Media (SQL + refactorizaci√≥n DI)
- ‚úÖ **WorkQueue2Processors** - Modificaci√≥n Media (c√°lculo familia + refactorizaci√≥n DI)
- ‚úÖ **Consultas SQL PolicyCenter** - Modificaci√≥n Mayor (tipo doc + investigar cobertura)

**Componentes Nuevos:**

- ‚úÖ **FamilyCalculatorService** - Servicio de dominio para c√°lculo de suma familiar

**Componentes Sin Cambios:**

- CoverageProvider - NO requiere modificaci√≥n (cobertura ya incluida)
- Tabla CHARGE_DETAIL_ITEMS - NO requiere cambios estructurales
- Azure Massive Download API - NO requiere cambios
- RabbitMQ - NO requiere cambios

**Documentaci√≥n a Actualizar:**

- `flujo-generacion-reporte-detalle-cobro.md` - Actualizar secci√≥n WorkQueue 1 y 2 con nuevos campos
- `architecture-microintegrador-reportes-vidagrupo.md` - Documentar refactorizaci√≥n de inyecci√≥n de dependencias
- Scripts SQL de referencia en `src/main/resources/sql/`

**Riesgos Arquitect√≥nicos:**

| Riesgo                                          | Probabilidad | Impacto | Mitigaci√≥n                                                       |
| ----------------------------------------------- | ------------ | ------- | ---------------------------------------------------------------- |
| Query SQL no retorna tipo de documento          | Baja         | Alto    | Validar con query de diagn√≥stico en BD de desarrollo             |
| Cobertura con nombre diferente en PC            | Alta         | Alto    | **CR√çTICO**: Query de diagn√≥stico para identificar nombre exacto |
| JOIN incorrecto filtrando cobertura             | Media        | Alto    | Revisar plan de ejecuci√≥n SQL, cambiar a LEFT JOIN si necesario  |
| Valor asegurado es realmente cero en datos      | Media        | Medio   | Validar con DBA/negocio si es dato real o error de configuraci√≥n |
| Regresi√≥n en otros campos del CSV               | Baja         | Alto    | Tests de regresi√≥n con factura 100011784911                      |
| Inyecci√≥n de dependencias rompe tests existentes| Media        | Medio   | Actualizar tests unitarios con mocks de nuevos servicios         |

### Validaci√≥n Arquitect√≥nica

**Validado por:** Usuario (Esteban Colorado)  
**Fecha de validaci√≥n:** Octubre 29, 2025  
**Feedback incorporado:** 

1. ‚úÖ Tipo de identificaci√≥n del afiliado resolver en WorkQueue 1 v√≠a SQL (no en WorkQueue 2)
2. ‚úÖ Valor Asegurado Invalidez por Accidente con Armas - campo existe, investigar por qu√© llega en cero
3. ‚úÖ Cobertura ya incluida - no modificar CoverageProvider, solo validar query SQL

**Enfoque aprobado:** Exploratorio con ajustes espec√≠ficos del usuario

### Fases de Implementaci√≥n

**Fase 1: Crear FamilyCalculatorService**
- Implementar servicio de dominio para c√°lculo de suma familiar
- Ubicaci√≥n: `domain/service/FamilyCalculatorService.java`
- Interface con m√©todos: `calculateFamilyTotal()`, `groupByAffiliate()`

**Fase 2: Modificar Consultas SQL en WorkQueue 1**
- Agregar campo `tipo_documento` en query de PolicyCenter
- Implementar concatenaci√≥n `tipo_documento || numero_documento` para "Identificaci√≥n del Afiliado"
- **INVESTIGAR**: Query de cobertura "Invalidez por Accidente con Armas" - por qu√© valor = 0
  - Verificar nombre exacto de cobertura en PC
  - Revisar JOINs (LEFT vs INNER)
  - Validar manejo de NULLs (usar COALESCE)
  - Confirmar filtros WHERE no excluyen cobertura

**Fase 3: Refactorizar WorkQueue1Processors**
- Aplicar inyecci√≥n de dependencias correcta v√≠a constructor
- Eliminar instanciaciones directas (`new ...()`)
- Actualizar l√≥gica de consolidaci√≥n de datos para incluir tipo de documento

**Fase 4: Modificar WorkQueue2Processors**
- Inyectar `FamilyCalculatorService` v√≠a constructor
- Implementar c√°lculo de "Valor Total Afiliado" para asegurados con parentesco "Afiliado"
- Validar que valor de cobertura "Invalidez por Accidente con Armas" no se pierda en transformaciones
- Aplicar inyecci√≥n de dependencias correcta en todas las dependencias

**Fase 5: Validaci√≥n y Testing**
- Query de diagn√≥stico SQL para validar tipo de documento
- Query de diagn√≥stico para identificar nombre exacto de cobertura "Invalidez por Accidente con Armas"
- Testing con factura de prueba `100011784911`
- Validar encoding UTF-8 sin BOM (Criterio 9)
- Tests de regresi√≥n en otros campos del CSV

### Referencias Arquitect√≥nicas

**Documentaci√≥n consultada:**
- `docs/architecture/index.md` - GPS Arquitect√≥nico del ecosistema
- `docs/architecture/flujo-generacion-reporte-detalle-cobro.md` - Flujo completo WorkQueues
- `docs/architecture/architecture-microintegrador-reportes-vidagrupo.md` - Arquitectura hexagonal

**Patrones aplicados:**
- Hexagonal Architecture (Ports & Adapters) - Patr√≥n base del proyecto
- Dependency Injection - Refactorizaci√≥n cr√≠tica aplicada a WorkQueues
- Service Layer Pattern - FamilyCalculatorService
- SQL-First Approach - Resolver en consultas cuando sea m√°s eficiente (tipo documento)
- Repository Pattern - Acceso a datos (ya existente)

**Queries de Diagn√≥stico SQL:**

```sql
-- Diagn√≥stico 1: Validar tipo de documento
SELECT 
    document_type,
    document_number,
    document_type || document_number as concatenated,
    relationship
FROM pc_grouppersonnel
WHERE relationship = 'Afiliado'
AND invoice_number = '100011784911'
LIMIT 10;

-- Diagn√≥stico 2: Identificar nombre exacto de cobertura
SELECT DISTINCT 
    coverage_code,
    coverage_name,
    coverage_type
FROM pc_coverage
WHERE UPPER(coverage_name) LIKE '%INVALIDEZ%'
  AND UPPER(coverage_name) LIKE '%ARMAS%'
ORDER BY coverage_name;

-- Diagn√≥stico 3: Verificar por qu√© valor asegurado = 0
SELECT 
    gp.document_number,
    cov.coverage_code,
    cov.coverage_name,
    cov.insured_value,
    cov.premium
FROM pc_grouppersonnel gp
LEFT JOIN pc_grouppersonnel_coverage gpc ON gp.id = gpc.insured_id
LEFT JOIN pc_coverage cov ON gpc.coverage_id = cov.id
WHERE gp.invoice_number = '100011784911'
  AND UPPER(cov.coverage_name) LIKE '%INVALIDEZ%ARMAS%';
```

---

## Estimaci√≥n

**Fecha de Estimaci√≥n:** Octubre 29, 2025  
**Estimador:** SM - Ceiba  
**Metodolog√≠a:** An√°lisis basado en arquitectura hexagonal, refactorizaci√≥n completa y debugging en tiempo real  

### An√°lisis de Complejidad

**Nivel de complejidad:** **ALTA**

**Justificaci√≥n basada en an√°lisis del c√≥digo base:**

1. **üî¥ Refactorizaci√≥n Completa del Proyecto (40%)**: NO solo WorkQueue1 y WorkQueue2
   - Clase base utilitaria de BD convertida a servicio inyectable
   - **Impacto**: Refactorizaci√≥n de TODOS los flujos del microservicio que usan la clase utilitaria
   - Incluye: WorkQueue1, WorkQueue2, WorkQueue3, WorkQueue4, GenerateDetailChargeProcessor, GetDetailChargeProcessor
   - Actualizaci√≥n masiva de configuraci√≥n de Camel/Spring para inyecci√≥n de dependencias
   - Actualizaci√≥n masiva de tests unitarios (mocks de BD en todos los procesadores)

2. **üî¥ Incertidumbre de An√°lisis de Datos (25%)**:
   - **Valor Total Afiliado**: Tabla origen desconocida - requiere an√°lisis de esquema de BD + validaci√≥n con negocio
   - **Tipo de Identificaci√≥n**: Validar si campo existe en PolicyCenter o requiere consulta adicional
   - **Valor Asegurado en Cero**: Requiere **debugging en tiempo real** en ambiente de desarrollo/QA
   - Puede requerir: an√°lisis de plan de ejecuci√≥n SQL, trazas de log, validaci√≥n de datos con DBA

3. **üü° Debugging en Tiempo Real (20%)**:
   - Despliegue en ambiente de desarrollo con logging debug activado
   - Ejecutar flujo completo con factura de prueba 100011784911
   - Analizar logs de WorkQueue1 (consulta SQL) + WorkQueue2 (transformaciones)
   - Identificar punto exacto donde valor asegurado se convierte en cero
   - Puede requerir: breakpoints remotos, an√°lisis de JSON intermedio, validaci√≥n de transformaciones

**Refactorizaci√≥n requerida:** **S√ç - COMPLETA DEL PROYECTO**

**Precedentes encontrados:**
- ‚ö†Ô∏è NO hay precedente de refactorizaci√≥n total de clase utilitaria a servicio inyectable
- ‚ö†Ô∏è NO hay precedente de debugging en tiempo real para an√°lisis de transformaciones
- ‚ö†Ô∏è Incertidumbre sobre tablas de origen de datos (requiere investigaci√≥n exploratoria)

### Estimaci√≥n por Tareas

| Fase | Descripci√≥n | Sr Con IA | M√©todo Ceiba |
|------|-------------|-----------|--------------|
| Fase 1 | An√°lisis Exploratorio (BD + DBA + tablas origen) | 3.5 h | 2.1 h |
| Fase 2 | Refactorizaci√≥n Clase Base BD | 3.0 h | 1.8 h |
| Fase 3 | Refactorizar TODOS los Procesadores | 6.0 h | 3.6 h |
| Fase 4 | Actualizar TODOS los Tests | 4.5 h | 2.7 h |
| Fase 5 | FamilyCalculatorService | 3.0 h | 1.8 h |
| Fase 6 | Modificar WorkQueue1 SQL | 3.0 h | 1.8 h |
| Fase 7 | Debugging Tiempo Real | 3.5 h | 2.1 h |
| Fase 8 | Modificar WorkQueue2 | 4.0 h | 2.4 h |
| Fase 9 | Testing Integral Completo | 5.5 h | 3.3 h |
| Fase 10 | Code Review Completo | 2.5 h | 1.5 h |
| Fase 11 | Despliegue y Validaci√≥n | 3.0 h | 1.8 h |
| **TOTAL** | | **41.5 h** | **24.9 h** |

### Totales por Perfil

| Perfil | Total Sin IA | Total Con IA | M√©todo Ceiba |
|--------|--------------|--------------|--------------|
| Jr | 110.0 h | 82.5 h | - |
| Semi Sr | 78.0 h | 58.5 h | - |
| Sr | 55.0 h | 41.5 h | - |
| M√©todo Ceiba | - | - | 24.9 h |

### Puntos de Historia

**Usando escala Fibonacci (1 punto = ~7 horas de trabajo):**

**Estimaci√≥n Recomendada:**
- **Sr Con IA**: **6 puntos** (~41.5h, ~1 semana completa)
- **M√©todo Ceiba**: **4 puntos** (~24.9h, ~3-4 d√≠as)

**Con incertidumbre m√°xima:**
- **Sr Con IA**: **8-10 puntos** (~56-70h, ~1.5-2 semanas)
- **M√©todo Ceiba**: **5-6 puntos** (~35-42h, ~5-6 d√≠as)

### An√°lisis de Riesgo

**Porcentaje de desviaci√≥n estimado:** **¬±35%**

**Factores de riesgo identificados:**

1. **üî¥ CR√çTICO - Incertidumbre de Tablas Origen de Datos**
   - Tabla para "Valor Total Afiliado" desconocida
   - Campo "Tipo de Identificaci√≥n" puede no existir en PolicyCenter
   - Requiere: an√°lisis de esquema BD + validaci√≥n con DBA + validaci√≥n con negocio
   - **Impacto potencial**: +8-16 horas si requiere consultas adicionales o l√≥gica compleja

2. **üî¥ CR√çTICO - Debugging Tiempo Real Requerido**
   - Valor asegurado en cero requiere an√°lisis en runtime
   - Puede requerir: m√∫ltiples iteraciones de deploy + logging + an√°lisis de trazas
   - Posibles causas: JOIN incorrecto, transformaci√≥n que sobrescribe, NULL handling, dato real
   - **Impacto potencial**: +6-12 horas si la causa es compleja o requiere m√∫ltiples iteraciones

3. **üî¥ CR√çTICO - Refactorizaci√≥n Completa del Proyecto**
   - Clase utilitaria de BD usada en TODOS los flujos
   - Requiere refactorizaci√≥n de: WorkQueue1-4, procesadores REST, configuraci√≥n completa
   - Riesgo de introducir regresiones en flujos no relacionados con el bug
   - **Impacto potencial**: +10-15 horas si hay problemas con configuraci√≥n Spring/Camel

**Recomendaciones para mitigar riesgos:**
- **üìã Fase 1 Cr√≠tica**: Priorizar an√°lisis exploratorio de tablas ANTES de iniciar desarrollo
- **üîç Debugging Temprano**: Configurar ambiente de desarrollo con logging debug desde el inicio
- **üìû Coordinaci√≥n DBA**: Agendar sesi√≥n con DBA en Fase 1 para validar esquema
- **üß™ Tests Incrementales**: Refactorizar un procesador a la vez + tests antes de continuar

### Recomendaci√≥n Estrat√©gica

Considerar **split de historia** en 2 partes:
- **Historia 915240-A**: Refactorizaci√≥n de clase base BD + inyecci√≥n de dependencias (3-4 puntos)
- **Historia 915240-B**: Correcci√≥n de campos (Valor Total Afiliado + Tipo ID + Valor Asegurado) (3-4 puntos)

**Beneficios del split:**
- ‚úÖ Reducir riesgo t√©cnico mediante validaci√≥n incremental
- ‚úÖ Validar refactorizaci√≥n antes de implementar correcciones
- ‚úÖ Permitir rollback independiente si hay problemas
- ‚úÖ Facilitar code review y testing de cada componente por separado
- ‚úÖ Mejorar visibilidad de progreso en el sprint

### Validaci√≥n de Estimaci√≥n

**‚úÖ Criterios de validaci√≥n cumplidos:**
- An√°lisis arquitect√≥nico completo de MicroIntegradorReportesVidaGrupo
- Revisi√≥n de documentaci√≥n de flujo de generaci√≥n de reporte
- Identificaci√≥n de precedentes y patrones existentes
- Cuantificaci√≥n de incertidumbre y riesgos
- Consideraci√≥n de refactorizaci√≥n completa del proyecto
- Inclusi√≥n de debugging en tiempo real

**Estimaci√≥n aprobada por:** Esteban Colorado  
**Fecha de aprobaci√≥n:** Octubre 29, 2025
