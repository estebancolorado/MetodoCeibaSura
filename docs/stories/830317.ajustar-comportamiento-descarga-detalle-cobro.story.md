# Historia #830317: Ajustar comportamiento de la opción para descargar en BC el detalle de cobro

**Estado:** Borrador (PO)

---

## Historia de Usuario

**Como** Expedidor,  
**Quiero** que el botón de "Generar detalle de cobro" en BillingCenter funcione correctamente para generar y descargar el archivo en excel de detalle de cobro,  
**Para** poder dar solución a necesidades de los asesores mientras ellos lo pueden descargar por AVA o por CHAT.

## Descripción

El flujo de generación y descarga del detalle de cobro ya existe en BillingCenter pero presenta problemas funcionales que impiden su correcto uso. Actualmente, cuando un usuario hace clic en el botón "Generar detalle de cobro" en la sección de facturas colectivas, el sistema siempre muestra el mensaje "está en proceso de generación" sin importar si el archivo existe o no, y cuando el archivo no existe, no consume el servicio POST del MicroIntegradorReportesVidaGrupo para solicitar la generación.

Esta historia corrige el comportamiento del flujo existente para que:
1. Oculte el botón "Generar reporte" en facturas colectivas de pólizas de vida grupo
2. Renombre y ajuste el botón de generación de detalle de cobro
3. Implemente correctamente la lógica de consulta (GET) y generación (POST) según el estado del reporte
4. Redirija correctamente a la pantalla de descarga cuando el archivo esté disponible

**Sistemas involucrados:** BillingCenter (Guidewire 8.0.7), MicroIntegradorReportesVidaGrupo  
**Áreas funcionales:** Facturación Colectiva - Vida Grupo, Reportería  
**Tipo de cambio:** Corrección de flujo existente (bug fix)

---

## Criterios de Aceptación

### Escenario 1: Ocultar botón "Generar reporte" y mostrar botón "Detalle de Cobro"

- **Dado** que se expidió una póliza de cualquiera de los productos de vida grupo y se han corrido los procesos de facturación
- **Cuando** se consulte la póliza en BC y se ingrese a la sección "Ver facturas en cuenta" o "Ver desembolsos en cuenta"
- **Entonces** en la sección de facturas colectivas, en cada registro de factura se debe ocultar el botón "Generar reporte" y solo verse el botón "Detalle de cobro"

### Escenario 2: Generar "Detalle de cobro" cuando no existe (consumir POST)

- **Dado** que se expidió una póliza de cualquiera de los productos de vida grupo y se han corrido los procesos de facturación
- **Cuando** se consulte la póliza en BC, se ingrese a la sección "Ver facturas en cuenta" o "Ver desembolsos en cuenta" y se dé clic en el botón "Detalle de cobro"
- **Entonces** el sistema debe:
  1. Consumir el servicio GET del MicroIntegrador para consultar si el reporte existe
  2. Si el reporte NO existe (respuesta 404), consumir automáticamente el servicio POST para solicitar la generación
  3. Mostrar un mensaje en toolbar azul (arriba de la tabla) indicando que está en proceso de generación del archivo para que lo intente más tarde
  4. Permanecer en la misma pantalla de facturas colectivas

### Escenario 3: Mostrar mensaje cuando el reporte está en proceso

- **Dado** que se expidió una póliza de cualquiera de los productos de vida grupo y se han corrido los procesos de facturación
- **Y** que el reporte ya fue solicitado y está en proceso de generación (estado 1, 2, 3 o 4)
- **Cuando** se consulte la póliza en BC, se ingrese a la sección "Ver facturas en cuenta" o "Ver desembolsos en cuenta" y se dé clic en el botón "Detalle de cobro"
- **Entonces** el sistema debe:
  1. Consumir el servicio GET del MicroIntegrador
  2. Recibir respuesta 404 con mensaje "Reporte en proceso"
  3. Mostrar el mensaje en toolbar azul (arriba de la tabla) indicando que está en proceso de generación
  4. Permanecer en la misma pantalla de facturas colectivas

### Escenario 4: Redirigir a pantalla de descarga cuando el reporte está listo

- **Dado** que se expidió una póliza de cualquiera de los productos de vida grupo y se han corrido los procesos de facturación
- **Y** que el reporte fue generado exitosamente (estado 5)
- **Cuando** se consulte la póliza en BC, se ingrese a la sección "Ver facturas en cuenta" o "Ver desembolsos en cuenta" y se dé clic en el botón "Detalle de cobro"
- **Entonces** el sistema debe:
  1. Consumir el servicio GET del MicroIntegrador
  2. Recibir respuesta 200 OK con la URL de descarga
  3. Redirigir automáticamente a la pantalla de descarga que muestra el botón "Descargar archivo"

### Escenario 5: Descargar automáticamente el archivo Excel

- **Dado** que el usuario fue redirigido a la pantalla de descarga
- **Y** que la pantalla muestra el botón "Descargar archivo"
- **Cuando** el usuario haga clic en el botón "Descargar archivo"
- **Entonces** el sistema debe descargar automáticamente el archivo CSV/Excel sin solicitar confirmación adicional

---

## Información Recopilada

### Usuario y Contexto

- **Tipo de usuario:** Expedidor (rol de BillingCenter con acceso a consulta de facturas colectivas)
- **Permisos requeridos:** Sin permisos específicos adicionales, hereda permisos del rol Expedidor
- **Valor de negocio:** Permitir a los expedidores dar solución inmediata a las necesidades de los asesores mientras estos puedan descargar el detalle de cobro por AVA o CHAT, mejorando el tiempo de respuesta y la autonomía del equipo de servicio al cliente

### Reglas de Negocio

**Problema actual identificado:**
- El flujo existente siempre muestra el mensaje "en proceso de generación" independientemente del estado real del reporte
- Cuando el archivo no existe, no se consume el servicio POST para solicitar la generación al MicroIntegrador
- Esto impide que los usuarios puedan generar y descargar el detalle de cobro

**Lógica de negocio correcta:**

1. **Consulta automática:** Al hacer clic en "Detalle de cobro", siempre consumir primero el servicio GET para verificar estado
2. **Generación automática:** Si GET retorna 404 (no existe), consumir inmediatamente POST sin confirmación del usuario
3. **Diferenciación de estados:**
   - 404 sin reporte: Crear nuevo (POST) → Mensaje "en proceso"
   - 404 con estado 1-4: Reporte en proceso → Mensaje "en proceso"
   - 200 con estado 5: Reporte completado → Redirigir a descarga
   - 500/error: MicroIntegrador maneja el error → BC muestra mensaje de error

4. **Ubicación del botón:** Solo en sección de facturas colectivas para productos de vida grupo
5. **Productos afectados:** Vida Grupo Integral, Deudores, Docentes, Condiciones de Uso (según documentación GPS)

### Interfaz

**Pantallas involucradas:**

1. **Pantalla "Ver facturas en cuenta"** (BC):
   - Tabla de facturas colectivas
   - Columna con botón "Detalle de cobro" (antes "Generar detalle de cobro")
   - Botón "Generar reporte" debe ocultarse para pólizas de vida grupo
   - Toolbar azul arriba de la tabla para mensajes informativos

2. **Pantalla "Ver desembolsos en cuenta"** (BC):
   - Tabla de devoluciones/desembolsos colectivos
   - Columna con botón "Detalle de cobro"
   - Botón "Generar reporte" debe ocultarse para pólizas de vida grupo
   - Toolbar azul arriba de la tabla para mensajes informativos

3. **Pantalla de descarga** (BC):
   - Pantalla específica para descarga del archivo
   - Muestra únicamente el botón "Descargar archivo"
   - Sin información adicional (nombre del archivo, fecha, tamaño)

**Flujo de navegación:**

`
Tabla Facturas Colectivas
  |
  v [Click en "Detalle de cobro"]
  |
  +-- GET /v1/he/invoices/{invoiceNumber}/chargedetail/report
      |
      +-- 404 (No existe) --> POST (Generar) --> Toolbar azul "En proceso" --> Permanece en tabla
      |
      +-- 404 (En proceso) --> Toolbar azul "En proceso" --> Permanece en tabla
      |
      +-- 200 (Completado) --> Redirigir a Pantalla Descarga --> Botón "Descargar archivo"
          |
          v [Click en "Descargar archivo"]
          |
          +-- Descarga automática archivo CSV/Excel
`

### Sistemas Externos

- **MicroIntegradorReportesVidaGrupo:** Sistema responsable de la generación asíncrona del reporte de detalle de cobro. BillingCenter consume sus servicios REST para consultar estado (GET) y solicitar generación (POST). El MicroIntegrador maneja todos los casos de error internamente, BillingCenter solo debe garantizar los consumos correctos y la correcta interpretación de las respuestas.

- **Azure Massive Download API:** Sistema de almacenamiento de archivos masivos (gestionado por el MicroIntegrador, transparente para BC)

- **AVA y CHAT:** Contexto de negocio únicamente. Son canales alternativos donde los asesores pueden descargar el detalle de cobro. Esta historia no afecta su funcionalidad.

---

## Contexto y Referencias

**Arquitectura:**
- [GPS Arquitectónico Principal](c:\Guidewire\docs\architecture\index.md)
- [Arquitectura BillingCenter](c:\Guidewire\docs\architecture\architecture-BillingCenter.md)
- [Flujo de Generación de Reporte Detalle de Cobro](c:\Guidewire\docs\architecture\flujo-generacion-reporte-detalle-cobro.md)
- [Arquitectura MicroIntegradorReportesVidaGrupo](c:\Guidewire\docs\architecture\architecture-microintegrador-reportes-vidagrupo.md)

**Historias relacionadas:**
- Historia #915240: BUG - Organizar los campos errados del detalle de cobro (resuelve problemas de contenido del archivo)

**Lecciones aprendidas:**

- **Validación de estado del reporte:** La historia #915240 documentó extensamente la estructura del reporte de detalle de cobro y los jobs asíncronos del MicroIntegrador (WorkQueues 1-4). Es importante validar correctamente el estado antes de redirigir al usuario.

- **Mensajes claros al usuario:** Los usuarios necesitan información clara sobre el estado del proceso. El mensaje "en proceso de generación" debe mostrarse en toolbar azul arriba de la tabla (no modal, no en la misma fila).

- **Generación automática nocturna:** Existe un proceso batch nocturno que genera automáticamente reportes para facturas nuevas (EventFired + Reglas Preupdate). Esta historia corrige la generación manual desde la UI.

- **Tiempo de generación:** Los reportes pueden tardar entre 1-3 horas en procesarse (según volumen de asegurados). Es crucial que el usuario entienda que debe esperar e intentar más tarde.

- **Productos de Vida Grupo:** Según GPS arquitectónico, los 4 productos principales son: Vida Grupo Integral, Deudores, Docentes y Condiciones de Uso. El botón debe comportarse igual para todos.

---

## Definición de Terminado (Inicial)

- [ ] El botón "Generar reporte" está oculto en facturas colectivas de pólizas de vida grupo
- [ ] El botón "Generar detalle de cobro" está renombrado a "Detalle de cobro"
- [ ] Al hacer clic en "Detalle de cobro", se consume correctamente el servicio GET del MicroIntegrador
- [ ] Si GET retorna 404 (no existe), se consume automáticamente el servicio POST para generar el reporte
- [ ] El mensaje "en proceso de generación" se muestra en toolbar azul arriba de la tabla
- [ ] Cuando GET retorna 200 (completado), se redirige automáticamente a la pantalla de descarga
- [ ] La pantalla de descarga muestra el botón "Descargar archivo"
- [ ] Al hacer clic en "Descargar archivo", se descarga automáticamente sin confirmación
- [ ] El flujo funciona correctamente en "Ver facturas en cuenta"
- [ ] El flujo funciona correctamente en "Ver desembolsos en cuenta"
- [ ] Los casos de error son manejados correctamente (mostrar mensaje de error apropiado)

---

## Registro de Cambios

| Fecha | Versión | Descripción | Autor |
|-------|---------|-------------|-------|
| 2025-11-18 | 1.0 | Historia creada por PO (importada y validada) | esteban.colorado (PO) |

---

## Metadata

**Autor:** esteban.colorado (PO)  
**Fecha:** 2025-11-18  
**Origen:** Historia importada desde Jira/sistema externo y validada con Método Ceiba  
**Historias relacionadas:** #915240  
**Tipo:** Bug Fix / Corrección de flujo existente

---

## Métricas de redacción de la historia de usuario con el PO 

**Tiempo con Método Ceiba:** 25 minutos  
**Tiempo estimado tradicional:** 62 minutos  
**Optimización:** 60%

---
