# Historia #830317: Ajustar comportamiento de la opci√≥n para descargar en BC el detalle de cobro

**Estado:** Borrador (PO)

---

## Historia de Usuario

**Como** Expedidor,  
**Quiero** que el bot√≥n de "Generar detalle de cobro" en BillingCenter funcione correctamente para generar y descargar el archivo en excel de detalle de cobro,  
**Para** poder dar soluci√≥n a necesidades de los asesores mientras ellos lo pueden descargar por AVA o por CHAT.

## Descripci√≥n

El flujo de generaci√≥n y descarga del detalle de cobro ya existe en BillingCenter pero presenta problemas funcionales que impiden su correcto uso. Actualmente, cuando un usuario hace clic en el bot√≥n "Generar detalle de cobro" en la secci√≥n de facturas colectivas, el sistema siempre muestra el mensaje "est√° en proceso de generaci√≥n" sin importar si el archivo existe o no, y cuando el archivo no existe, no consume el servicio POST del MicroIntegradorReportesVidaGrupo para solicitar la generaci√≥n.

Esta historia corrige el comportamiento del flujo existente para que:
1. Oculte el bot√≥n "Generar reporte" en facturas colectivas de p√≥lizas de vida grupo
2. Renombre y ajuste el bot√≥n de generaci√≥n de detalle de cobro
3. Implemente correctamente la l√≥gica de consulta (GET) y generaci√≥n (POST) seg√∫n el estado del reporte
4. Redirija correctamente a la pantalla de descarga cuando el archivo est√© disponible

**Sistemas involucrados:** BillingCenter (Guidewire 8.0.7), MicroIntegradorReportesVidaGrupo  
**√Åreas funcionales:** Facturaci√≥n Colectiva - Vida Grupo, Reporter√≠a  
**Tipo de cambio:** Correcci√≥n de flujo existente (bug fix)

---

## Criterios de Aceptaci√≥n

### Escenario 1: Ocultar bot√≥n "Generar reporte" y mostrar bot√≥n "Detalle de Cobro"

- **Dado** que se expidi√≥ una p√≥liza de cualquiera de los productos de vida grupo y se han corrido los procesos de facturaci√≥n
- **Cuando** se consulte la p√≥liza en BC y se ingrese a la secci√≥n "Ver facturas en cuenta" o "Ver desembolsos en cuenta"
- **Entonces** en la secci√≥n de facturas colectivas, en cada registro de factura se debe ocultar el bot√≥n "Generar reporte" y solo verse el bot√≥n "Detalle de cobro"

### Escenario 2: Generar "Detalle de cobro" cuando no existe (consumir POST)

- **Dado** que se expidi√≥ una p√≥liza de cualquiera de los productos de vida grupo y se han corrido los procesos de facturaci√≥n
- **Cuando** se consulte la p√≥liza en BC, se ingrese a la secci√≥n "Ver facturas en cuenta" o "Ver desembolsos en cuenta" y se d√© clic en el bot√≥n "Detalle de cobro"
- **Entonces** el sistema debe:
  1. Consumir el servicio GET del MicroIntegrador para consultar si el reporte existe
  2. Si el reporte NO existe (respuesta 404), consumir autom√°ticamente el servicio POST para solicitar la generaci√≥n
  3. Mostrar un mensaje en toolbar azul (arriba de la tabla) indicando que est√° en proceso de generaci√≥n del archivo para que lo intente m√°s tarde
  4. Permanecer en la misma pantalla de facturas colectivas

### Escenario 3: Mostrar mensaje cuando el reporte est√° en proceso

- **Dado** que se expidi√≥ una p√≥liza de cualquiera de los productos de vida grupo y se han corrido los procesos de facturaci√≥n
- **Y** que el reporte ya fue solicitado y est√° en proceso de generaci√≥n (estado 1, 2, 3 o 4)
- **Cuando** se consulte la p√≥liza en BC, se ingrese a la secci√≥n "Ver facturas en cuenta" o "Ver desembolsos en cuenta" y se d√© clic en el bot√≥n "Detalle de cobro"
- **Entonces** el sistema debe:
  1. Consumir el servicio GET del MicroIntegrador
  2. Recibir respuesta 404 con mensaje "Reporte en proceso"
  3. Mostrar el mensaje en toolbar azul (arriba de la tabla) indicando que est√° en proceso de generaci√≥n
  4. Permanecer en la misma pantalla de facturas colectivas

### Escenario 4: Redirigir a pantalla de descarga cuando el reporte est√° listo

- **Dado** que se expidi√≥ una p√≥liza de cualquiera de los productos de vida grupo y se han corrido los procesos de facturaci√≥n
- **Y** que el reporte fue generado exitosamente (estado 5)
- **Cuando** se consulte la p√≥liza en BC, se ingrese a la secci√≥n "Ver facturas en cuenta" o "Ver desembolsos en cuenta" y se d√© clic en el bot√≥n "Detalle de cobro"
- **Entonces** el sistema debe:
  1. Consumir el servicio GET del MicroIntegrador
  2. Recibir respuesta 200 OK con la URL de descarga
  3. Redirigir autom√°ticamente a la pantalla de descarga que muestra el bot√≥n "Descargar archivo"

### Escenario 5: Descargar autom√°ticamente el archivo Excel

- **Dado** que el usuario fue redirigido a la pantalla de descarga
- **Y** que la pantalla muestra el bot√≥n "Descargar archivo"
- **Cuando** el usuario haga clic en el bot√≥n "Descargar archivo"
- **Entonces** el sistema debe descargar autom√°ticamente el archivo CSV/Excel sin solicitar confirmaci√≥n adicional

---

## Informaci√≥n Recopilada

### Usuario y Contexto

- **Tipo de usuario:** Expedidor (rol de BillingCenter con acceso a consulta de facturas colectivas)
- **Permisos requeridos:** Sin permisos espec√≠ficos adicionales, hereda permisos del rol Expedidor
- **Valor de negocio:** Permitir a los expedidores dar soluci√≥n inmediata a las necesidades de los asesores mientras estos puedan descargar el detalle de cobro por AVA o CHAT, mejorando el tiempo de respuesta y la autonom√≠a del equipo de servicio al cliente

### Reglas de Negocio

**Problema actual identificado:**
- El flujo existente siempre muestra el mensaje "en proceso de generaci√≥n" independientemente del estado real del reporte
- Cuando el archivo no existe, no se consume el servicio POST para solicitar la generaci√≥n al MicroIntegrador
- Esto impide que los usuarios puedan generar y descargar el detalle de cobro

**L√≥gica de negocio correcta:**

1. **Consulta autom√°tica:** Al hacer clic en "Detalle de cobro", siempre consumir primero el servicio GET para verificar estado
2. **Generaci√≥n autom√°tica:** Si GET retorna 404 (no existe), consumir inmediatamente POST sin confirmaci√≥n del usuario
3. **Diferenciaci√≥n de estados:**
   - 404 sin reporte: Crear nuevo (POST) ‚Üí Mensaje "en proceso"
   - 404 con estado 1-4: Reporte en proceso ‚Üí Mensaje "en proceso"
   - 200 con estado 5: Reporte completado ‚Üí Redirigir a descarga
   - 500/error: MicroIntegrador maneja el error ‚Üí BC muestra mensaje de error

4. **Ubicaci√≥n del bot√≥n:** Solo en secci√≥n de facturas colectivas para productos de vida grupo
5. **Productos afectados:** Vida Grupo Integral, Deudores, Docentes, Condiciones de Uso (seg√∫n documentaci√≥n GPS)

### Interfaz

**Pantallas involucradas:**

1. **Pantalla "Ver facturas en cuenta"** (BC):
   - Tabla de facturas colectivas
   - Columna con bot√≥n "Detalle de cobro" (antes "Generar detalle de cobro")
   - Bot√≥n "Generar reporte" debe ocultarse para p√≥lizas de vida grupo
   - Toolbar azul arriba de la tabla para mensajes informativos

2. **Pantalla "Ver desembolsos en cuenta"** (BC):
   - Tabla de devoluciones/desembolsos colectivos
   - Columna con bot√≥n "Detalle de cobro"
   - Bot√≥n "Generar reporte" debe ocultarse para p√≥lizas de vida grupo
   - Toolbar azul arriba de la tabla para mensajes informativos

3. **Pantalla de descarga** (BC):
   - Pantalla espec√≠fica para descarga del archivo
   - Muestra √∫nicamente el bot√≥n "Descargar archivo"
   - Sin informaci√≥n adicional (nombre del archivo, fecha, tama√±o)

**Flujo de navegaci√≥n:**

`
Tabla Facturas Colectivas
  |
  v [Click en "Detalle de cobro"]
  |
  +-- GET /v1/he/invoices/{invoiceNumber}/chargedetail/report
      |
      +-- 404 (No existe) --> POST (Generar) --> Toolbar azul "En proceso" --> Permanece en tabla
      |
      +-- 404 (En proceso) --> Toolbar azul "En proceso" --> Permanece en tabla
      |
      +-- 200 (Completado) --> Redirigir a Pantalla Descarga --> Bot√≥n "Descargar archivo"
          |
          v [Click en "Descargar archivo"]
          |
          +-- Descarga autom√°tica archivo CSV/Excel
`

### Sistemas Externos

- **MicroIntegradorReportesVidaGrupo:** Sistema responsable de la generaci√≥n as√≠ncrona del reporte de detalle de cobro. BillingCenter consume sus servicios REST para consultar estado (GET) y solicitar generaci√≥n (POST). El MicroIntegrador maneja todos los casos de error internamente, BillingCenter solo debe garantizar los consumos correctos y la correcta interpretaci√≥n de las respuestas.

- **Azure Massive Download API:** Sistema de almacenamiento de archivos masivos (gestionado por el MicroIntegrador, transparente para BC)

- **AVA y CHAT:** Contexto de negocio √∫nicamente. Son canales alternativos donde los asesores pueden descargar el detalle de cobro. Esta historia no afecta su funcionalidad.

---

## An√°lisis Arquitect√≥nico

> **Analista:** Arquitecto Ceiba  
> **Fecha:** 2025-11-18  
> **Estado:** Completo - Listo para refactoring  
> **Versi√≥n:** 2.0 (Corregido con c√≥digo real existente)

### Hallazgo Cr√≠tico: C√≥digo Existe Pero Requiere Ajustes

**Conclusi√≥n del an√°lisis de c√≥digo:**

La funcionalidad **S√ç EXISTE** en BillingCenter. El flujo de generaci√≥n y descarga del detalle de cobro est√° implementado en m√∫ltiples archivos Gosu y PCF. El problema identificado NO es falta de c√≥digo, sino **l√≥gica incorrecta en el manejo de respuestas HTTP** del servicio REST del MicroIntegradorReportesVidaGrupo.

**Archivos EXISTENTES validados:**

**BillingCenter:**
- ‚úÖ `./BillingCenter/modules/configuration/config/import/gen/WService_Ext.xml` - Configuraci√≥n de servicios externos (nota: ChargeDetailReport debe estar en uno de los archivos de ambiente)
- ‚úÖ `./BillingCenter/modules/configuration/gsrc/sura/bc/grouplife/ChargeDetailReportIntegrationAPI.gs` - Cliente REST base
- ‚úÖ `./BillingCenter/modules/configuration/gsrc/sura/bc/grouplife/ChargeDetailReportWS.gs` - Wrapper de endpoints GET/POST
- ‚úÖ `./BillingCenter/modules/configuration/gsrc/sura/bc/grouplife/ChargeDetailReportServiceFacade.gs` - Facade de servicios
- ‚úÖ `./BillingCenter/modules/configuration/gsrc/sura/bc/exportdata/GenerateChargeDetailReportExport.gs` - **Handler principal con l√≥gica a corregir**
- ‚úÖ `./BillingCenter/modules/configuration/config/web/pcf/account/AccountDetailCollectiveInvoices.pcf` - Pantalla de facturas colectivas
- ‚úÖ `./BillingCenter/modules/configuration/config/web/pcf/account/AccountDetailCollectiveDisbursement.pcf` - Pantalla de desembolsos colectivos
- ‚ö†Ô∏è `ChargeDetailReportDownloadPopup.pcf` - **Referenciado en c√≥digo pero NO encontrado f√≠sicamente** (posible PCF din√°mico o a crear)

**MicroIntegradorReportesVidaGrupo:**
- ‚ö†Ô∏è Endpoints REST existen seg√∫n documentaci√≥n pero requieren validaci√≥n (archivos Java truncados en listado)

**MicroIntegradorReportesVidaGrupo:**
- ‚ö†Ô∏è Endpoints REST existen seg√∫n documentaci√≥n pero requieren validaci√≥n (archivos Java truncados en listado)

### An√°lisis del C√≥digo Existente

#### 1. Configuraci√≥n de Servicio Externo

**Archivos:** `WService_Ext.xml`, `dllo-WService_Ext.xml`, `uat-WService_Ext.xml`, `pdn-WService_Ext.xml`

```xml
<WService_Ext public-id="bc:60">
    <Exchange/>
    <Password/>
    <Queue/>
    <Localization>https://labapicorevidagrupo.suramericana.com/vidagruporeportes/v1/he/invoices</Localization>
    <LocalizationType>EndPoint</LocalizationType>
    <RoutingKey/>
    <SecurityType>none</SecurityType>
    <ServiceName>ChargeDetailReport</ServiceName>
    <Version>1.0</Version>
    <User_Ext>Y29yZWd3OmNvOHJlOTUxKkcvNjUwdw=</User_Ext>
    <ApiKey>f8b7a06d70904951b04f35f433f038c6</ApiKey>
</WService_Ext>
```

**An√°lisis:**
- Base URL: `https://labapicorevidagrupo.suramericana.com/vidagruporeportes/v1/he/invoices`
- Autenticaci√≥n: Basic Auth (credenciales en Base64) + API Key en header
- Seguridad: Ninguna adicional declarada (solo HTTPS)

#### 2. Cliente REST (ChargeDetailReportIntegrationAPI.gs)

**Ubicaci√≥n:** `gsrc/sura/bc/grouplife/ChargeDetailReportIntegrationAPI.gs`

```gosu
class ChargeDetailReportIntegrationAPI extends SuraRestConfigurationProvider {
  protected function doPostRequest(url : String) : String {
    var httpPostInstance = getHttpPostInstance(url)
    return executeRequest(httpPostInstance)
  }

  protected function doGetRequest(url : String) : String {
    var httpGetInstance = getHttpGetInstance(url)
    return executeRequest(httpGetInstance)
  }

  protected function executeRequest(methodHttp : HttpRequestBase) : String {
    methodHttp.addHeader(ChargeDetailReportConstant.HEADER_AUTHORIZATION, BasicSecurity)
    methodHttp.addHeader(ChargeDetailReportConstant.HEADER_API_KEY, ApiKey)
    return getRestClient().executeService(methodHttp)
  }

  override property get BasicSecurity() : String {
    if (Config == null || GosuStringUtil.isBlank(Config.User_Ext)) {
      return null
    } else {
      return "Basic ".concat(Config.User_Ext) // Y29yZWd3OmNvOHJlOTUxKkcvNjUwdw=
    }
  }

  protected property get TimeOut() : Long {
    return NumbersConstant.TIME_OUT_MILLISECONDS
  }
}
```

**An√°lisis:**
- ‚úÖ Headers correctos: `Authorization: Basic ...` + `ApiKey: ...`
- ‚úÖ Timeout configurado (constante externa)
- ‚úÖ Extensi√≥n de clase base `SuraRestConfigurationProvider`
- ‚ö†Ô∏è **Falta validaci√≥n:** No parsea c√≥digo HTTP de respuesta (200, 404, 500) - solo retorna String

#### 3. Wrapper de Endpoints (ChargeDetailReportWS.gs)

**Ubicaci√≥n:** `gsrc/sura/bc/grouplife/ChargeDetailReportWS.gs`

```gosu
class ChargeDetailReportWS extends ChargeDetailReportIntegrationAPI {
  construct() {
    super.configure(ChargeDetailReportConstant.SERVICE_NAME) // "ChargeDetailReport"
  }

  protected function generateChargeDetailReport(invoiceOrDisbursementCollectiveNumber : String) : String {
    return doPostRequest(getUrlForChargeDetailReportService(invoiceOrDisbursementCollectiveNumber))
  }

  protected function getChargeDetailReport(invoiceOrDisbursementCollectiveNumber : String) : String {
    return doGetRequest(getUrlForChargeDetailReportService(invoiceOrDisbursementCollectiveNumber))
  }

  protected function getUrlForChargeDetailReportService(invoiceOrDisbursementCollectiveNumber : String) : String {
    var invoiceOrDisbursementCollectiveNumberParameter = invoiceOrDisbursementCollectiveNumber
        .replaceAll(ChargeDetailReportConstant.BLANK_SPACE_REGEX, StringUtils.EMPTY)

    return getUrlService() + "/${invoiceOrDisbursementCollectiveNumberParameter}" +
        ChargeDetailReportConstant.CHARGE_DETAIL_PATH +  // "/chargedetail"
        ChargeDetailReportConstant.REPORT_PATH             // "/report"
  }

  protected property get UrlService() : String {
    return "${Location}" // Desde WService_Ext.xml
  }
}
```

**URL Final Construida:**
```
https://labapicorevidagrupo.suramericana.com/vidagruporeportes/v1/he/invoices/{invoiceNumber}/chargedetail/report
```

**An√°lisis:**
- ‚úÖ URL correctamente formada (coincide con documentaci√≥n arquitect√≥nica)
- ‚úÖ Limpieza de espacios en n√∫mero de factura
- ‚úÖ M√©todos GET y POST separados
- ‚ö†Ô∏è **Problema:** No diferencia respuesta HTTP (siempre retorna String del body)

#### 4. Facade de Servicios (ChargeDetailReportServiceFacade.gs)

**Ubicaci√≥n:** `gsrc/sura/bc/grouplife/ChargeDetailReportServiceFacade.gs`

```gosu
class ChargeDetailReportServiceFacade implements IChargeDetailReportServiceFacade {
  override function generateChargeDetailReport(invoiceOrDisbursementCollectiveNumber : String) : String {
    return getChargeDetailReportWSInstance().generateChargeDetailReport(invoiceOrDisbursementCollectiveNumber)
  }

  override function getChargeDetailReport(invoiceOrDisbursementCollectiveNumber : String) : String {
    return getChargeDetailReportWSInstance().getChargeDetailReport(invoiceOrDisbursementCollectiveNumber)
  }

  protected property get ChargeDetailReportWSInstance() : ChargeDetailReportWS {
    return new ChargeDetailReportWS()
  }
}
```

**An√°lisis:**
- ‚úÖ Facade pattern correcto (simple delegaci√≥n)
- ‚úÖ Implementa interfaz `IChargeDetailReportServiceFacade` (no encontrada f√≠sicamente pero referenciada)
- ‚ÑπÔ∏è No agrega l√≥gica adicional (solo abstracci√≥n)

#### 5. Handler Principal - **AQU√ç EST√Å EL PROBLEMA** (GenerateChargeDetailReportExport.gs)

**Ubicaci√≥n:** `gsrc/sura/bc/exportdata/GenerateChargeDetailReportExport.gs`

```gosu
class GenerateChargeDetailReportExport {
  private static final var _JSON = new GsonBuilder().serializeNulls().create()
  private var _logger = LoggerFactory.getLogger(ChargeDetailReportConstant.SERVICE_NAME)

  public function process(invoiceOrDisbursementCollectiveNumber : String) : void {
    try {
      var responseStr = getChargeDetailReportServiceFacade()
          .getChargeDetailReport(invoiceOrDisbursementCollectiveNumber) // üî¥ GET SIEMPRE PRIMERO
      var responseMap = parseResponse(responseStr)

      processResponseMap(responseMap, invoiceOrDisbursementCollectiveNumber)
    } catch(exception : DisplayableException) {
      _logger.error(exception.Message, exception)
      throw new DisplayableException(exception.Message)
    } catch(exception : Exception) {
      var message = displaykey.Sura.GroupLife.ChargeDetailReport.ErrorToGetChargeDatailReportURL
      _logger.error(message, exception)
      throw new DisplayableException(message + exception.Message)
    }
  }

  protected function processResponseMap(responseMap : Map, invoiceOrDisbursementCollectiveNumber : String) : void {
    var fileUrl = extractFileUrl(responseMap)

    if (isValidFileUrl(fileUrl)) { // üü¢ SI HAY URL ‚Üí Redirigir a descarga
      _logger.info(ChargeDetailReportConstant.MSG_URL_OBTAINED + fileUrl)
      ChargeDetailReportDownloadPopup.push(fileUrl)
    } else { // üî¥ SI NO HAY URL ‚Üí Ejecutar POST
      processGenerateChargeDetailReport(invoiceOrDisbursementCollectiveNumber)
    }
  }

  protected function processGenerateChargeDetailReport(invoiceOrDisbursementCollectiveNumber : String) : void {
    try {
      var responseStr = getChargeDetailReportServiceFacade()
          .generateChargeDetailReport(invoiceOrDisbursementCollectiveNumber) // üî¥ POST

      if (responseStr != null) {
        // üî¥üî¥üî¥ PROBLEMA AQU√ç: Siempre muestra "en proceso" independiente de si es 404 o 201
        throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ChargeDatailReportInProcess)
      } else {
        throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ErrorInvalidResponse)
      }

    } catch(exception : DisplayableException) {
      _logger.error(exception.Message, exception)
      throw new DisplayableException(exception.Message)
    } catch(exception : Exception) {
      var message = displaykey.Sura.GroupLife.ChargeDetailReport.ErrorToGenerateChargeDetailReport
      _logger.error(message, exception)
      throw new Exception(message + exception.Message)
    }
  }

  protected function extractFileUrl(responseMap : Map) : String {
    if (responseMap.containsKey(ChargeDetailReportConstant.KEY_URL_ARCHIVE)) { // "urlArchive"
      return responseMap.get(ChargeDetailReportConstant.KEY_URL_ARCHIVE) as String
    }
    return null
  }
}
```

**üî¥ PROBLEMA RA√çZ IDENTIFICADO:**

1. **GET siempre se ejecuta primero** ‚úÖ (correcto)
2. **Parseo de JSON busca campo `urlArchive`** ‚úÖ (correcto seg√∫n constante)
3. **Si NO hay URL ‚Üí Ejecuta POST** ‚úÖ (l√≥gica correcta)
4. **üî¥ DESPU√âS DEL POST: Siempre muestra "en proceso" SIN importar:**
   - Si el reporte NO exist√≠a (404) ‚Üí POST crea ‚Üí Debe decir "se solicit√≥ generaci√≥n"
   - Si el reporte YA estaba en proceso (404 con mensaje) ‚Üí Debe decir "ya est√° en proceso"
   - Si hubo error (500) ‚Üí Debe decir "error en servicio"
   - Si hubo conflicto (409) ‚Üí Debe decir "reporte ya existe"

5. **üî¥ NO VALIDA C√ìDIGO HTTP:**
   - El m√©todo `doGetRequest()` y `doPostRequest()` solo retornan `String` del body
   - NO retornan objeto con `statusCode`, `headers`, `body`
   - **Imposible diferenciar entre HTTP 200, 404, 409, 500**

6. **üî¥ L√ìGICA DE GET TAMBI√âN INCORRECTA:**
   - Si GET retorna 404 (reporte no existe o en proceso) ‚Üí responseStr probablemente es JSON con error
   - El parseo `_JSON.fromJson(responseStr, Map)` puede funcionar si el 404 retorna JSON v√°lido
   - Pero luego busca `urlArchive` que NO existir√° en respuesta de error
   - Concluye "no hay URL" ‚Üí Ejecuta POST
   - **Funciona por accidente**, pero NO por dise√±o correcto

#### 6. Pantallas PCF

**Archivos:** `AccountDetailCollectiveInvoices.pcf`, `AccountDetailCollectiveDisbursement.pcf`

```xml
<Variable
  initialValue="new sura.bc.exportdata.GenerateChargeDetailReportExport()"
  name="generateChargeDetailReportExport"
  type="sura.bc.exportdata.GenerateChargeDetailReportExport"/>
<Variable
  initialValue="new sura.bc.util.BCUtil()"
  name="bcUtil"
  type="sura.bc.util.BCUtil"/>
<Variable
  initialValue="&quot;BC.ReportChargeDetailIsActive&quot;"
  name="reportChargeDetailIsActiveToggleName"
  type="String"/>
```

**An√°lisis:**
- ‚úÖ Variable `generateChargeDetailReportExport` instanciada correctamente
- ‚ö†Ô∏è **NO SE ENCONTR√ì la llamada a `generateChargeDetailReportExport.process()`** en el PCF le√≠do (posiblemente en filas de la tabla m√°s abajo)
- ‚ö†Ô∏è **Feature Toggle:** `BC.ReportChargeDetailIsActive` - posiblemente controla visibilidad del bot√≥n
- ‚ö†Ô∏è **NO SE ENCONTR√ì bot√≥n visible** en las primeras 100 l√≠neas del PCF

### Patr√≥n Arquitect√≥nico Identificado

**Patr√≥n Actual (Incorrecto):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  UI PCF: Click "Detalle de cobro"                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GenerateChargeDetailReportExport.process(invoiceNumber)    ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  1. GET /chargedetail/report                                 ‚îÇ
‚îÇ     ‚îî‚îÄ> responseStr (String del body, SIN status code)      ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  2. Parse JSON: buscar "urlArchive"                          ‚îÇ
‚îÇ     ‚îú‚îÄ SI existe URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ChargeDetailReportDownloadPopup.push(url)  ‚úÖ
‚îÇ     ‚îÇ                                                        ‚îÇ
‚îÇ     ‚îî‚îÄ SI NO existe URL ‚îÄ‚îÄ> processGenerateChargeDetailReport()         ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  3. POST /chargedetail/report                                ‚îÇ
‚îÇ     ‚îî‚îÄ> responseStr (String, SIN status code)               ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  4. if (responseStr != null) {                               ‚îÇ
‚îÇ       üî¥ SIEMPRE throw "En proceso de generaci√≥n"           ‚îÇ
‚îÇ     }                                                        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Problemas:**

1. ‚ùå No valida c√≥digo HTTP 404 vs 200 en GET
2. ‚ùå No valida c√≥digo HTTP 201 vs 404 vs 409 en POST
3. ‚ùå Siempre muestra mismo mensaje "en proceso" sin diferenciar casos
4. ‚ùå No redirige autom√°ticamente cuando GET retorna 200 con URL (s√≠ lo hace, pero por accidente)
5. ‚ùå No diferencia entre "reporte no existe a√∫n" vs "reporte en proceso de generaci√≥n"

**Patr√≥n Corregido Esperado:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  UI PCF: Click "Detalle de cobro"                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GenerateChargeDetailReportExport.process(invoiceNumber)    ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  1. GET /chargedetail/report                                 ‚îÇ
‚îÇ     ‚îî‚îÄ> HTTPResponse {statusCode, body, headers}            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  2. Evaluar statusCode:                                      ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ     ‚îå‚îÄ HTTP 200 (Completado) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ     ‚îÇ   - Parse JSON body: extraer "urlArchive"         ‚îÇ   ‚îÇ
‚îÇ     ‚îÇ   - ChargeDetailReportDownloadPopup.push(url)     ‚îÇ   ‚îÇ
‚îÇ     ‚îÇ   - STOP (no ejecutar POST)                       ‚îÇ   ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ     ‚îå‚îÄ HTTP 404 (No existe O en proceso) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ     ‚îÇ   - Ejecutar POST /chargedetail/report            ‚îÇ  ‚îÇ
‚îÇ     ‚îÇ   - Evaluar respuesta POST:                       ‚îÇ  ‚îÇ
‚îÇ     ‚îÇ      ‚îú‚îÄ 201 Created: "Reporte solicitado OK"      ‚îÇ  ‚îÇ
‚îÇ     ‚îÇ      ‚îú‚îÄ 404 Conflict: "Reporte ya est√° en proceso"‚îÇ  ‚îÇ
‚îÇ     ‚îÇ      ‚îú‚îÄ 409 Conflict: "Reporte ya existe"         ‚îÇ  ‚îÇ
‚îÇ     ‚îÇ      ‚îî‚îÄ 500 Error: "Servicio no disponible"       ‚îÇ  ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ     ‚îå‚îÄ HTTP 500 (Error) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ     ‚îÇ   - Mostrar mensaje error gen√©rico                ‚îÇ   ‚îÇ
‚îÇ     ‚îÇ   - NO ejecutar POST                               ‚îÇ   ‚îÇ
‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Componentes a Refactorizar

#### CR√çTICO: ChargeDetailReportIntegrationAPI.gs

**Cambio requerido:** Retornar objeto `HTTPResponse` en lugar de `String`

**C√≥digo actual:**
```gosu
protected function doGetRequest(url : String) : String {
  var httpGetInstance = getHttpGetInstance(url)
  return executeRequest(httpGetInstance) // ‚ùå Solo retorna body
}
```

**C√≥digo propuesto:**
```gosu
protected function doGetRequest(url : String) : HTTPResponse {
  var httpGetInstance = getHttpGetInstance(url)
  return executeRequestWithStatus(httpGetInstance) // ‚úÖ Retorna {statusCode, body}
}

protected function executeRequestWithStatus(methodHttp : HttpRequestBase) : HTTPResponse {
  methodHttp.addHeader(ChargeDetailReportConstant.HEADER_AUTHORIZATION, BasicSecurity)
  methodHttp.addHeader(ChargeDetailReportConstant.HEADER_API_KEY, ApiKey)
  
  var httpResponse = getRestClient().execute(methodHttp) // Obtener respuesta completa
  var statusCode = httpResponse.StatusLine.StatusCode
  var body = EntityUtils.toString(httpResponse.Entity, ChargeDetailReportConstant.UTF_8)
  
  return new HTTPResponse(statusCode, body)
}
```

**Nota:** Requiere crear clase helper `HTTPResponse` con propiedades `StatusCode` y `Body`.

#### CR√çTICO: GenerateChargeDetailReportExport.gs

**Cambio requerido:** Validar c√≥digo HTTP antes de parsear JSON

**C√≥digo actual (l√≠neas 14-30):**
```gosu
public function process(invoiceOrDisbursementCollectiveNumber : String) : void {
  try {
    var responseStr = getChargeDetailReportServiceFacade()
        .getChargeDetailReport(invoiceOrDisbursementCollectiveNumber) // ‚ùå String sin c√≥digo HTTP
    var responseMap = parseResponse(responseStr)
    processResponseMap(responseMap, invoiceOrDisbursementCollectiveNumber)
  } catch(...) { ... }
}

protected function processResponseMap(responseMap : Map, invoiceOrDisbursementCollectiveNumber : String) : void {
  var fileUrl = extractFileUrl(responseMap)
  if (isValidFileUrl(fileUrl)) {
    ChargeDetailReportDownloadPopup.push(fileUrl) // ‚úÖ OK cuando hay URL
  } else {
    processGenerateChargeDetailReport(invoiceOrDisbursementCollectiveNumber) // ‚ùå L√≥gica incorrecta
  }
}
```

**C√≥digo propuesto:**
```gosu
public function process(invoiceOrDisbursementCollectiveNumber : String) : void {
  try {
    var getResponse = getChargeDetailReportServiceFacade()
        .getChargeDetailReport(invoiceOrDisbursementCollectiveNumber) // ‚úÖ HTTPResponse
    
    processGetResponse(getResponse, invoiceOrDisbursementCollectiveNumber)
  } catch(exception : DisplayableException) {
    _logger.error(exception.Message, exception)
    throw new DisplayableException(exception.Message)
  } catch(exception : Exception) {
    var message = displaykey.Sura.GroupLife.ChargeDetailReport.ErrorToGetChargeDatailReportURL
    _logger.error(message, exception)
    throw new DisplayableException(message + exception.Message)
  }
}

protected function processGetResponse(getResponse : HTTPResponse, invoiceNumber : String) : void {
  switch(getResponse.StatusCode) {
    case 200:
      // Reporte completado - redirigir a descarga
      var responseMap = parseResponse(getResponse.Body)
      var fileUrl = extractFileUrl(responseMap)
      if (isValidFileUrl(fileUrl)) {
        _logger.info(ChargeDetailReportConstant.MSG_URL_OBTAINED + fileUrl)
        ChargeDetailReportDownloadPopup.push(fileUrl)
      } else {
        throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ErrorMissingURL)
      }
      break
      
    case 404:
      // Reporte no existe o en proceso - solicitar generaci√≥n
      processGenerateChargeDetailReport(invoiceNumber)
      break
      
    case 500:
      // Error en servicio
      throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ErrorServiceUnavailable)
      break
      
    default:
      throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ErrorUnexpectedStatus(getResponse.StatusCode))
  }
}

protected function processGenerateChargeDetailReport(invoiceNumber : String) : void {
  try {
    var postResponse = getChargeDetailReportServiceFacade()
        .generateChargeDetailReport(invoiceNumber) // ‚úÖ HTTPResponse
    
    switch(postResponse.StatusCode) {
      case 201:
        // Reporte solicitado exitosamente
        throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ChargeDetailReportRequested)
        break
        
      case 404:
        // Reporte ya est√° en proceso
        throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ChargeDetailReportInProcess)
        break
        
      case 409:
        // Conflicto - reporte ya existe
        throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ChargeDetailReportConflict)
        break
        
      case 500:
        throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ErrorToGenerateChargeDetailReport)
        break
        
      default:
        throw new DisplayableException(displaykey.Sura.GroupLife.ChargeDetailReport.ErrorInvalidResponse)
    }
  } catch(exception : DisplayableException) {
    _logger.error(exception.Message, exception)
    throw new DisplayableException(exception.Message)
  } catch(exception : Exception) {
    var message = displaykey.Sura.GroupLife.ChargeDetailReport.ErrorToGenerateChargeDetailReport
    _logger.error(message, exception)
    throw new Exception(message + exception.Message)
  }
}
```

#### PENDIENTE: ChargeDetailReportDownloadPopup.pcf

**Estado:** Referenciado en c√≥digo (`ChargeDetailReportDownloadPopup.push(fileUrl)`) pero **NO encontrado f√≠sicamente**.

**Acciones:**
1. Buscar en runtime de Guidewire si existe como PCF din√°mico
2. Si NO existe, crear PCF nuevo con:
   - T√≠tulo: "Detalle de Cobro"
   - Bot√≥n: "Descargar archivo"
   - Click ‚Üí Download autom√°tico de `fileUrl` sin confirmaci√≥n

#### PENDIENTE: Botones en PCF AccountDetailCollectiveInvoices y AccountDetailCollectiveDisbursement

**Estado:** Variable `generateChargeDetailReportExport` existe pero **NO se encontr√≥ el bot√≥n en las primeras 100 l√≠neas**.

**Acci√≥n:** Leer secci√≥n de botones de tabla (RowIterator) para localizar implementaci√≥n actual.

### Orden de Implementaci√≥n Sugerido

**Sprint 1: Refactoring Core (3-5 d√≠as)**

1. **D√≠a 1:** Crear clase helper `HTTPResponse.gs`
   - Propiedades: `StatusCode: int`, `Body: String`, `Headers: Map`
   - Constructor
   - Tests unitarios

2. **D√≠a 2:** Refactorizar `ChargeDetailReportIntegrationAPI.gs`
   - Cambiar firma de `doGetRequest()` y `doPostRequest()` para retornar `HTTPResponse`
   - Actualizar `executeRequest()` para capturar c√≥digo HTTP
   - Tests unitarios con mocks

3. **D√≠a 3:** Refactorizar `ChargeDetailReportServiceFacade.gs`
   - Actualizar firmas para retornar `HTTPResponse`
   - Propagar cambios a interfaz `IChargeDetailReportServiceFacade`
   - Tests unitarios

4. **D√≠a 4-5:** Refactorizar `GenerateChargeDetailReportExport.gs`
   - Implementar `processGetResponse()` con switch de c√≥digos HTTP
   - Implementar `processGenerateChargeDetailReport()` con switch de c√≥digos HTTP
   - Agregar mensajes de error espec√≠ficos en `displaykey.*`
   - Tests unitarios completos (6+ escenarios)

**Sprint 2: UI + Testing E2E (3 d√≠as)**

5. **D√≠a 1:** Localizar o crear `ChargeDetailReportDownloadPopup.pcf`
   - Si no existe, crear PCF b√°sico
   - Bot√≥n de descarga autom√°tica
   - Tests manuales de descarga

6. **D√≠a 2:** Validar botones en PCF de facturas y desembolsos
   - Leer c√≥digo completo de ambos PCF
   - Validar visibilidad de bot√≥n seg√∫n feature toggle
   - Agregar l√≥gica para ocultar "Generar reporte" en productos Vida Grupo (si aplica)

7. **D√≠a 3:** Tests End-to-End
   - Escenario 1: GET 200 ‚Üí Redirect a descarga ‚úÖ
   - Escenario 2: GET 404 ‚Üí POST 201 ‚Üí Mensaje "solicitado" ‚úÖ
   - Escenario 3: GET 404 ‚Üí POST 404 ‚Üí Mensaje "en proceso" ‚úÖ
   - Escenario 4: GET 404 ‚Üí POST 409 ‚Üí Mensaje "conflicto" ‚úÖ
   - Escenario 5: GET 500 ‚Üí Mensaje error ‚úÖ

**Total Estimado:** 8 d√≠as (2 sprints de 1 semana)

### Riesgos y Decisiones T√©cnicas Cr√≠ticas

#### ‚ö†Ô∏è Riesgo 1: Cambio en firma de m√©todos p√∫blicos

**Problema:** `ChargeDetailReportServiceFacade` implementa interfaz `IChargeDetailReportServiceFacade`. Cambiar la firma de `String` a `HTTPResponse` puede romper otros consumidores.

**Decisi√≥n:**
- Verificar si hay otros usos de esta interfaz en el c√≥digo
- Si NO hay otros usos ‚Üí Proceder con cambio directo
- Si S√ç hay otros usos ‚Üí Crear m√©todos nuevos con sufijo `WithStatus()` y deprecar los antiguos

#### ‚ö†Ô∏è Riesgo 2: DisplayKeys faltantes

**Problema:** Los mensajes referenciados (`displaykey.Sura.GroupLife.ChargeDetailReport.*`) pueden no existir.

**Decisi√≥n:**
- Crear/validar todos los displaykeys antes de deploy:
  - `ChargeDetailReportRequested`: "Reporte solicitado. Intente descargar en 1-2 horas."
  - `ChargeDetailReportInProcess`: "Reporte en proceso de generaci√≥n. Intente m√°s tarde."
  - `ChargeDetailReportConflict`: "El reporte ya existe o est√° siendo procesado."
  - `ErrorServiceUnavailable`: "Servicio temporalmente no disponible. Intente m√°s tarde."
  - `ErrorMissingURL`: "Error: URL de descarga no encontrada en respuesta."
  - `ErrorUnexpectedStatus(code)`: "Error inesperado del servicio (c√≥digo {0})."

#### ‚ö†Ô∏è Riesgo 3: MicroIntegrador no implementado

**Problema:** C√≥digo Java del MicroIntegrador parece no existir (archivos truncados en listado).

**Decisi√≥n:**
- **VALIDAR CON EQUIPO DE MICROINTEGRADOR** antes de iniciar implementaci√≥n
- Si NO existe el endpoint REST:
  - Coordinar implementaci√≥n paralela (historia dependiente)
  - Crear mocks HTTP para testing de BillingCenter
- Si S√ç existe:
  - Validar contrato de API (c√≥digos HTTP, estructura JSON)
  - Confirmar nombre exacto del campo: `urlArchive` o `downloadUrl`

### M√©tricas de √âxito

**T√©cnicas:**
- 100% de tests unitarios pasan (cobertura >85%)
- 0 regresiones en funcionalidad existente
- Tiempo de respuesta GET/POST <500ms (ambiente QA)

**Funcionales:**
- Los 5 escenarios E2E documentados pasan exitosamente
- Mensajes de usuario claros y diferenciados por estado
- Descarga autom√°tica funciona sin confirmaci√≥n adicional

**Negocio:**
- Usuarios pueden distinguir entre "reporte no existe" vs "en proceso"
- Reducci√≥n de clicks manuales (no re-solicitar reportes existentes)

---

### Dependencias Externas Validadas

| Sistema | Endpoint/Ubicaci√≥n | Estado | Notas |
|---------|-------------------|--------|-------|
| **Oracle DB Guidewire Replica** | LABGWDWH (BC_OWNER + PC_OWNER) | ‚úÖ Existe | Validado en historia #915240, contiene esquemas completos de BC + PC para consultas masivas |
| **Azure Massive Download API** | https://labapicorevidagrupo.suramericana.com.co/... | ‚ö†Ô∏è Validar | Documentado pero requiere validaci√≥n de credenciales y endpoints exactos |
| **RabbitMQ** | msglab.suramericana.com.co:5672 | ‚ö†Ô∏è No aplica | Usado para notificar AVA/PorChat (NO para BillingCenter) - fuera del alcance de esta historia |

### Flujo de Datos Completo (End-to-End)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 1: Usuario hace clic en "Detalle de cobro" (BillingCenter UI)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  ‚îÇ
  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 2: Handler Gosu consulta estado (GET)                                  ‚îÇ
‚îÇ  GenerateChargeDetailReportExport.go(invoice)                               ‚îÇ
‚îÇ    ‚îú‚îÄ> ChargeDetailReportServiceFacade.consultarEstado(invoiceNumber)      ‚îÇ
‚îÇ    ‚îî‚îÄ> GET http://micro:9000/v1/he/invoices/{num}/chargedetail/report      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  ‚îÇ
  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 3: MicroIntegrador procesa GET                                         ‚îÇ
‚îÇ  RestApiRouteDetailCharge ‚Üí ConsultarEstadoReporteQuery                     ‚îÇ
‚îÇ    ‚îú‚îÄ> DetailChargeReportService.consultarEstadoReporte(invoiceNumber)     ‚îÇ
‚îÇ    ‚îî‚îÄ> Repository query: SELECT estado, url_archivo FROM control_reportes  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ Estado NO EXISTE (estado=0 o null) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ                                                                            ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ   ‚îÇ Respuesta: HTTP 404 + {"mensaje": "Reporte no existe"}            ‚îÇ  ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                                            ‚îÇ
  ‚îÇ   ‚ñº                                                                        ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ   ‚îÇ FASE 4: BC recibe 404 ‚Üí Ejecuta POST autom√°tico                   ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  ChargeDetailReportServiceFacade.generarReporte(invoiceNumber)     ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  POST http://micro:9000/v1/he/invoices/{num}/chargedetail/report  ‚îÇ  ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                                            ‚îÇ
  ‚îÇ   ‚ñº                                                                        ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ   ‚îÇ FASE 5: MicroIntegrador procesa POST                               ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  GenerarReporteDetalleCobroCommand                                 ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ    ‚îú‚îÄ> Validar no duplicado                                        ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ    ‚îú‚îÄ> INSERT INTO control_reportes (invoice, estado=1, fecha)     ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ    ‚îî‚îÄ> HTTP 201 + {"mensaje": "Reporte solicitado"}                ‚îÇ  ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                                            ‚îÇ
  ‚îÇ   ‚ñº                                                                        ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ   ‚îÇ FASE 6: BC muestra Toolbar azul "En proceso de generaci√≥n..."     ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  Location.showMessage(..., INFO, TopBar)                           ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  Usuario permanece en tabla de facturas                            ‚îÇ  ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                                            ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ Estado EN PROCESO (estado=1,2,3,4) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ                                                                            ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ   ‚îÇ Respuesta: HTTP 404 + {"mensaje": "Reporte en proceso"}           ‚îÇ  ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                                            ‚îÇ
  ‚îÇ   ‚ñº                                                                        ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ   ‚îÇ BC muestra Toolbar azul "En proceso de generaci√≥n..."             ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ NO ejecuta POST (ya existe)                                        ‚îÇ  ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                                            ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ Estado COMPLETADO (estado=5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  ‚îÇ                                                                            ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ   ‚îÇ Respuesta: HTTP 200 +                                              ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ {"urlArchive": "https://azure.../file.csv", "estado": 5, ...}     ‚îÇ  ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                                            ‚îÇ
  ‚îÇ   ‚ñº                                                                        ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ   ‚îÇ FASE 7: BC parsea JSON y extrae URL                                ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  var downloadUrl = response.JSON["urlArchive"]                     ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  Location.goDirectlyToPopup("ChargeDetailReportDownloadPopup.pcf") ‚îÇ  ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                                            ‚îÇ
  ‚îÇ   ‚ñº                                                                        ‚îÇ
  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
  ‚îÇ   ‚îÇ FASE 8: Pantalla de descarga                                       ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  ChargeDetailReportDownloadPopup.pcf                               ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  - Muestra bot√≥n "Descargar archivo"                               ‚îÇ  ‚îÇ
  ‚îÇ   ‚îÇ  - Click ‚Üí Download autom√°tico desde Azure URL                     ‚îÇ  ‚îÇ
  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
  ‚îÇ                                                                            ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ BACKGROUND: WorkQueues procesando (cada hora) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
       ‚îÇ                                                                       ‚îÇ
       ‚îú‚îÄ> WQ1: estado 1‚Üí2, crear cabecera Azure                              ‚îÇ
       ‚îú‚îÄ> WQ2: estado 2‚Üí3, escribir detalle (bloques)                        ‚îÇ
       ‚îú‚îÄ> WQ3: estado 3‚Üí5, cerrar archivo, actualizar url_archivo            ‚îÇ
       ‚îî‚îÄ> WQ4: limpiar registros antiguos (>30 d√≠as)                         ‚îÇ
```

### Riesgos y Decisiones T√©cnicas Cr√≠ticas

#### ‚ö†Ô∏è Riesgo 1: Nombre del campo JSON de URL de descarga

**Problema:** La documentaci√≥n muestra inconsistencias entre `urlArchive` y `downloadUrl`.

**Impacto:** Si BillingCenter parsea el campo incorrecto, el redirect a descarga fallar√°.

**Decisi√≥n Requerida (antes de implementar):**
1. Validar con el equipo de MicroIntegrador cu√°l es el nombre EXACTO del campo JSON
2. Documentar en contrato de API (OpenAPI/Swagger)
3. Crear test de integraci√≥n que valide el parseo correcto

**Alternativa de Mitigaci√≥n:** Implementar fallback en Gosu:
```gosu
var downloadUrl = response.JSON["urlArchive"] ?: response.JSON["downloadUrl"]
if (downloadUrl == null) {
  Location.showMessage("Error: URL de descarga no encontrada", ERROR, TopBar)
  return
}
```

#### ‚ö†Ô∏è Riesgo 2: Timeout de consulta GET

**Problema:** Si WorkQueues tardan mucho (1-3 horas seg√∫n documentaci√≥n), usuarios har√°n m√∫ltiples clicks en "Detalle de cobro".

**Impacto:** Carga innecesaria en MicroIntegrador + frustraci√≥n del usuario.

**Decisi√≥n de Dise√±o:**
- Timeout HTTP: 5 segundos (suficiente para query a tabla control)
- Mensaje claro en Toolbar: "Reporte en proceso de generaci√≥n. Intente nuevamente en 1-2 horas."
- **NO implementar polling autom√°tico** (evitar carga en servidor)

**Mejora Futura (fuera del alcance):**
- Notificaci√≥n por email cuando reporte est√© listo
- Indicador de progreso visual (estado 1‚Üí2‚Üí3‚Üí5)

#### ‚ö†Ô∏è Riesgo 3: C√≥digos de productos Vida Grupo

**Problema:** Documentaci√≥n menciona 4 productos principales pero pueden existir m√°s variantes.

**Impacto:** Bot√≥n "Generar reporte" visible en productos incorrectos o bot√≥n "Detalle de cobro" oculto en productos v√°lidos.

**Decisi√≥n de Dise√±o:**
- Crear propiedad configurable en `product-codes.properties`
- Validar lista completa con Product Owner antes de deploy
- Implementar logging cuando se oculte bot√≥n (auditor√≠a)

**Lista Provisional (validar con PO):**
```properties
vidagrupo.products=VidaGrupoIntegral,Deudores,Docentes,CondicionesDeUso,VidaGrupoIntegralPlus
```

#### ‚ö†Ô∏è Riesgo 4: Manejo de errores HTTP 500 del MicroIntegrador

**Problema:** Si MicroIntegrador est√° ca√≠do o retorna error interno, BillingCenter debe manejarlo sin romper la UI.

**Impacto:** Experiencia de usuario rota si no hay manejo de excepciones.

**Decisi√≥n de Dise√±o:**
- Catch todas las excepciones de red (timeout, connection refused, 500)
- Mostrar mensaje gen√©rico: "Servicio temporalmente no disponible. Intente m√°s tarde."
- Logging detallado con stack trace para debugging
- **NO bloquear** la funcionalidad principal de BillingCenter (solo notificar error)

```gosu
try {
  var response = ServiceFacade.consultarEstado(invoiceNumber)
  // ... l√≥gica normal
} catch (e: HTTPException) {
  Logger.error("Error consultando MicroIntegrador", e)
  Location.showMessage("Servicio temporalmente no disponible. Contacte soporte.", ERROR, TopBar)
} catch (e: Exception) {
  Logger.error("Error inesperado en GenerateChargeDetailReportExport", e)
  Location.showMessage("Error inesperado. Contacte soporte.", ERROR, TopBar)
}
```

### Plan de Testing

#### Tests Unitarios

**BillingCenter (Gosu)**
- `GenerateChargeDetailReportExportTest.gs`
  - Test: Respuesta 404 ‚Üí Ejecuta POST
  - Test: Respuesta 200 ‚Üí Parsea URL correctamente
  - Test: Respuesta 500 ‚Üí Muestra mensaje error
  - Test: Timeout de red ‚Üí Muestra mensaje error
  - Mock de `ChargeDetailReportServiceFacade`

**MicroIntegrador (Java + JUnit 5)**
- `ConsultarEstadoReporteDetalleCobroIndividualQueryTest.java`
  - Test: Estado 5 ‚Üí HTTP 200 + URL
  - Test: Estado 1-4 ‚Üí HTTP 404 + mensaje "en proceso"
  - Test: Estado 0/null ‚Üí HTTP 404 + mensaje "no existe"
- `GenerarReporteDetalleCobroIndividualCommandTest.java`
  - Test: Invoice v√°lido ‚Üí Inserta registro estado=1 ‚Üí HTTP 201
  - Test: Invoice duplicado ‚Üí HTTP 409
  - Test: Invoice inv√°lido ‚Üí HTTP 400

#### Tests de Integraci√≥n

**End-to-End (E2E)**
- **Escenario 1:** Click en bot√≥n ‚Üí GET 404 ‚Üí POST 201 ‚Üí Toolbar "en proceso"
  - Setup: BD sin registro del invoice
  - Acci√≥n: Click en "Detalle de cobro"
  - Validaci√≥n: POST ejecutado + registro insertado con estado=1
  
- **Escenario 2:** Click en bot√≥n ‚Üí GET 404 (en proceso) ‚Üí Toolbar "en proceso"
  - Setup: BD con registro estado=2
  - Acci√≥n: Click en "Detalle de cobro"
  - Validaci√≥n: NO ejecuta POST + mensaje correcto
  
- **Escenario 3:** Click en bot√≥n ‚Üí GET 200 ‚Üí Redirect a DownloadScreen
  - Setup: BD con registro estado=5 + URL v√°lida
  - Acci√≥n: Click en "Detalle de cobro"
  - Validaci√≥n: Redirect correcto + URL pasada como par√°metro

- **Escenario 4:** Click en "Descargar archivo" ‚Üí Download autom√°tico
  - Setup: DownloadScreen con URL de Azure v√°lida
  - Acci√≥n: Click en bot√≥n
  - Validaci√≥n: Archivo descargado sin modal de confirmaci√≥n

**Herramientas:**
- BillingCenter: Guidewire Test Framework (GTF) + Selenium (si aplica para UI)
- MicroIntegrador: Spring Test + TestContainers (Oracle DB mock) + WireMock (Azure API mock)

#### Tests de Performance

**Carga Esperada:**
- Usuarios concurrentes: 10-20 expedidores
- Requests GET/POST simult√°neos: ~5 por minuto (escenario pesimista)

**Pruebas:**
- JMeter: 20 requests GET simult√°neos ‚Üí Tiempo respuesta < 500ms
- JMeter: 10 requests POST simult√°neos ‚Üí Tiempo respuesta < 1s
- Validar que WorkQueues NO se afecten por carga de API REST

### Orden de Implementaci√≥n Sugerido

**Sprint 1: Infraestructura Base (5 d√≠as)**

1. **D√≠a 1-2:** MicroIntegrador - Base de Datos
   - Crear tabla `control_reportes` (si no existe)
   - Crear √≠ndices: `idx_invoice_number`, `idx_estado`
   - Script de rollback
   - Tests de DDL

2. **D√≠a 3-5:** MicroIntegrador - REST API + Application Layer
   - `RestApiRouteDetailCharge.java` (GET + POST endpoints)
   - `ConsultarEstadoReporteQuery.java`
   - `GenerarReporteCommand.java`
   - `DetailChargeReportService.java`
   - `DetailChargeReportRepository.java`
   - Tests unitarios (>80% coverage)

**Sprint 2: Integraci√≥n BillingCenter (5 d√≠as)**

3. **D√≠a 1-2:** BillingCenter - Capa de Integraci√≥n
   - `ChargeDetailReportServiceFacade.gs` (cliente REST)
   - Configuraci√≥n de endpoints (`endpoints.properties`)
   - Tests unitarios con mock del MicroIntegrador

4. **D√≠a 3-4:** BillingCenter - L√≥gica de Negocio
   - `GenerateChargeDetailReportExport.gs` (handler principal)
   - State Machine con manejo de 200/404/500
   - Logging y auditor√≠a
   - Tests unitarios

5. **D√≠a 5:** BillingCenter - Configuraci√≥n de Productos
   - `product-codes.properties` con lista de productos Vida Grupo
   - Validaci√≥n con PO

**Sprint 3: UI + Testing (5 d√≠as)**

6. **D√≠a 1-2:** BillingCenter - PCF Screens
   - `AccountDetailCollectiveInvoices.pcf` (modificar tabla + toolbar + bot√≥n)
   - `AccountDetailCollectiveDisbursement.pcf` (modificar tabla + toolbar + bot√≥n)
   - L√≥gica de visibilidad de botones (productos Vida Grupo)

7. **D√≠a 3:** BillingCenter - PCF Download Screen
   - `ChargeDetailReportDownloadPopup.pcf` (pantalla de descarga)
   - Bot√≥n "Descargar archivo" con download autom√°tico

8. **D√≠a 4-5:** Tests de Integraci√≥n E2E
   - Configurar ambiente de QA con MicroIntegrador + BD
   - Ejecutar 4 escenarios E2E completos
   - Validar manejo de errores
   - Performance testing b√°sico

**Sprint 4: Refinamiento + Deploy (3 d√≠as)**

9. **D√≠a 1:** Validaciones Cr√≠ticas
   - Confirmar nombre exacto del campo JSON (`urlArchive` vs `downloadUrl`)
   - Validar lista final de productos Vida Grupo con PO
   - Revisar mensajes de usuario (UX)

10. **D√≠a 2:** Documentaci√≥n T√©cnica
    - README de integraci√≥n para equipo de soporte
    - Diagramas de secuencia actualizados
    - Manual de troubleshooting

11. **D√≠a 3:** Deploy a Producci√≥n
    - Deploy MicroIntegrador (endpoints REST)
    - Deploy BillingCenter (PCF + Gosu)
    - Smoke testing en producci√≥n
    - Monitoreo primeras 24 horas

**Total Estimado:** ~18 d√≠as (3-4 sprints de 2 semanas)

### Consideraciones de Seguridad

1. **Autenticaci√≥n entre BillingCenter ‚Üî MicroIntegrador**
   - ‚ö†Ô∏è **Validar:** ¬øRequiere OAuth2/JWT o es HTTP b√°sico interno?
   - **Decisi√≥n Pendiente:** Revisar est√°ndares de seguridad de Sura

2. **Autorizaci√≥n de descarga de archivos**
   - URL de Azure: ¬øEs p√∫blica o requiere token SAS con expiraci√≥n?
   - **Validar:** Si requiere re-generaci√≥n de token SAS antes de cada descarga

3. **Validaci√≥n de datos de entrada**
   - `invoiceNumber`: Validar formato num√©rico + longitud m√°xima
   - Prevenir SQL Injection en queries (usar PreparedStatements)

4. **Logging de auditor√≠a**
   - Registrar cada GET/POST con: usuario, timestamp, invoice number, resultado
   - Cumplimiento con pol√≠ticas de privacidad (no loggear datos sensibles de asegurados)

### M√©tricas de √âxito

**T√©cnicas:**
- Disponibilidad del servicio: >99.5%
- Tiempo de respuesta GET: <500ms (p95)
- Tiempo de respuesta POST: <1s (p95)
- Tasa de error: <1% (excluyendo errores de usuario)

**Funcionales:**
- 100% de los casos de uso validados en QA
- 0 regresiones en funcionalidad existente de BillingCenter

**Negocio:**
- Reducci√≥n de solicitudes manuales a expedidores (medir despu√©s de 1 mes)
- Satisfacci√≥n del usuario (encuesta post-implementaci√≥n)

---

## Contexto y Referencias

**Arquitectura:**
- [GPS Arquitect√≥nico Principal](c:\Guidewire\docs\architecture\index.md)
- [Arquitectura BillingCenter](c:\Guidewire\docs\architecture\architecture-BillingCenter.md)
- [Flujo de Generaci√≥n de Reporte Detalle de Cobro](c:\Guidewire\docs\architecture\flujo-generacion-reporte-detalle-cobro.md)
- [Arquitectura MicroIntegradorReportesVidaGrupo](c:\Guidewire\docs\architecture\architecture-microintegrador-reportes-vidagrupo.md)

**Historias relacionadas:**
- Historia #915240: BUG - Organizar los campos errados del detalle de cobro (resuelve problemas de contenido del archivo)

**Lecciones aprendidas:**

- **Validaci√≥n de estado del reporte:** La historia #915240 document√≥ extensamente la estructura del reporte de detalle de cobro y los jobs as√≠ncronos del MicroIntegrador (WorkQueues 1-4). Es importante validar correctamente el estado antes de redirigir al usuario.

- **Mensajes claros al usuario:** Los usuarios necesitan informaci√≥n clara sobre el estado del proceso. El mensaje "en proceso de generaci√≥n" debe mostrarse en toolbar azul arriba de la tabla (no modal, no en la misma fila).

- **Generaci√≥n autom√°tica nocturna:** Existe un proceso batch nocturno que genera autom√°ticamente reportes para facturas nuevas (EventFired + Reglas Preupdate). Esta historia corrige la generaci√≥n manual desde la UI.

- **Tiempo de generaci√≥n:** Los reportes pueden tardar entre 1-3 horas en procesarse (seg√∫n volumen de asegurados). Es crucial que el usuario entienda que debe esperar e intentar m√°s tarde.

- **Productos de Vida Grupo:** Seg√∫n GPS arquitect√≥nico, los 4 productos principales son: Vida Grupo Integral, Deudores, Docentes y Condiciones de Uso. El bot√≥n debe comportarse igual para todos.

---

## Definici√≥n de Terminado (Inicial)

- [ ] El bot√≥n "Generar reporte" est√° oculto en facturas colectivas de p√≥lizas de vida grupo
- [ ] El bot√≥n "Generar detalle de cobro" est√° renombrado a "Detalle de cobro"
- [ ] Al hacer clic en "Detalle de cobro", se consume correctamente el servicio GET del MicroIntegrador
- [ ] Si GET retorna 404 (no existe), se consume autom√°ticamente el servicio POST para generar el reporte
- [ ] El mensaje "en proceso de generaci√≥n" se muestra en toolbar azul arriba de la tabla
- [ ] Cuando GET retorna 200 (completado), se redirige autom√°ticamente a la pantalla de descarga
- [ ] La pantalla de descarga muestra el bot√≥n "Descargar archivo"
- [ ] Al hacer clic en "Descargar archivo", se descarga autom√°ticamente sin confirmaci√≥n
- [ ] El flujo funciona correctamente en "Ver facturas en cuenta"
- [ ] El flujo funciona correctamente en "Ver desembolsos en cuenta"
- [ ] Los casos de error son manejados correctamente (mostrar mensaje de error apropiado)

---

## Registro de Cambios

| Fecha | Versi√≥n | Descripci√≥n | Autor |
|-------|---------|-------------|-------|
| 2025-11-18 | 1.0 | Historia creada por PO (importada y validada) | esteban.colorado (PO) |

---

## Metadata

**Autor:** esteban.colorado (PO)  
**Fecha:** 2025-11-18  
**Origen:** Historia importada desde Jira/sistema externo y validada con M√©todo Ceiba  
**Historias relacionadas:** #915240  
**Tipo:** Bug Fix / Correcci√≥n de flujo existente

---

## M√©tricas de redacci√≥n de la historia de usuario con el PO 

**Tiempo con M√©todo Ceiba:** 25 minutos  
**Tiempo estimado tradicional:** 62 minutos  
**Optimizaci√≥n:** 60%

---
